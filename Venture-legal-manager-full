import React, { useState, useEffect, useRef } from 'react';
import { Building2, FileText, Users, DollarSign, Plus, X, ArrowLeft, ChevronRight, ChevronDown, AlertCircle, CheckCircle, Check, Trash2, PieChart, TrendingUp, Briefcase, UserCheck, Pencil, FileOutput, ExternalLink, Info, Download, Upload, Search, LayoutDashboard, FolderOpen, Sparkles, Clock, ArrowUpRight, Copy, Eye, Filter, SortAsc, ChevronUp, Zap, Rocket, Settings } from 'lucide-react';

// Toast Notification Component
const Toast = ({ message, type = 'success', onClose }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);
  
  const colors = {
    success: 'bg-emerald-500 text-white',
    error: 'bg-red-500 text-white',
    info: 'bg-blue-500 text-white',
    warning: 'bg-amber-500 text-white'
  };
  
  const icons = {
    success: <CheckCircle className="w-5 h-5" />,
    error: <AlertCircle className="w-5 h-5" />,
    info: <Info className="w-5 h-5" />,
    warning: <AlertCircle className="w-5 h-5" />
  };
  
  return (
    <div className={`fixed bottom-6 right-6 ${colors[type]} px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 z-[200] animate-slide-up`}>
      {icons[type]}
      <span className="font-medium">{message}</span>
      <button onClick={onClose} className="ml-2 opacity-70 hover:opacity-100">
        <X className="w-4 h-4" />
      </button>
    </div>
  );
};

// Collapsible Section Component
const CollapsibleSection = ({ title, icon: Icon, iconColor = 'blue', children, defaultOpen = true, badge, action }) => {
  const [isOpen, setIsOpen] = useState(defaultOpen);
  const colors = {
    blue: 'text-blue-600 bg-blue-100',
    green: 'text-green-600 bg-green-100',
    purple: 'text-purple-600 bg-purple-100',
    orange: 'text-orange-600 bg-orange-100',
    teal: 'text-teal-600 bg-teal-100',
    slate: 'text-slate-600 bg-slate-100',
  };
  
  return (
    <div className="bg-white rounded-xl border shadow-sm transition-shadow hover:shadow-md">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="w-full p-5 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white hover:from-slate-100 hover:to-slate-50 transition-colors rounded-t-xl"
      >
        <div className="flex items-center gap-3">
          <div className={`p-2 rounded-lg ${colors[iconColor]}`}>
            <Icon className="w-5 h-5" />
          </div>
          <span className="font-semibold text-slate-800">{title}</span>
          {badge && <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">{badge}</span>}
        </div>
        <div className="flex items-center gap-2">
          {action && <div onClick={e => e.stopPropagation()}>{action}</div>}
          <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
        </div>
      </button>
      {isOpen && (
        <div className="p-5 pt-0 border-t">
          {children}
        </div>
      )}
    </div>
  );
};

// Stat Card Component
const StatCard = ({ icon: Icon, iconColor, value, label, subtext, onClick, highlight }) => {
  const colors = {
    blue: 'bg-blue-100 text-blue-600',
    green: 'bg-green-100 text-green-600',
    purple: 'bg-purple-100 text-purple-600',
    orange: 'bg-orange-100 text-orange-600',
    emerald: 'bg-emerald-100 text-emerald-600',
    red: 'bg-red-100 text-red-600',
  };
  
  const Wrapper = onClick ? 'button' : 'div';
  
  return (
    <Wrapper 
      onClick={onClick}
      className={`bg-white p-5 rounded-xl border text-left transition-all ${
        onClick ? 'hover:shadow-lg hover:border-blue-200 cursor-pointer hover:-translate-y-0.5' : 'hover:shadow-md'
      } ${highlight ? 'ring-2 ring-blue-500 ring-offset-2' : ''}`}
    >
      <div className="flex justify-between items-start mb-2">
        <div className={`p-2.5 rounded-lg ${colors[iconColor]}`}>
          <Icon className="w-5 h-5" />
        </div>
        <span className={`text-2xl font-bold ${highlight ? 'text-blue-600' : 'text-slate-900'}`}>{value}</span>
      </div>
      <p className="text-sm text-slate-600 font-medium">{label}</p>
      {subtext && <p className="text-xs text-slate-400 mt-1">{subtext}</p>}
    </Wrapper>
  );
};

// Empty State Component
const EmptyState = ({ icon: Icon, iconColor = 'blue', title, description, action, actionLabel }) => {
  const colors = {
    blue: 'bg-blue-100 text-blue-600',
    green: 'bg-green-100 text-green-600',
    purple: 'bg-purple-100 text-purple-600',
    orange: 'bg-orange-100 text-orange-600',
  };
  
  return (
    <div className="py-12 text-center">
      <div className={`w-16 h-16 ${colors[iconColor]} rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm`}>
        <Icon className="w-8 h-8" />
      </div>
      <h3 className="text-lg font-semibold text-slate-800 mb-2">{title}</h3>
      <p className="text-slate-500 mb-6 max-w-md mx-auto">{description}</p>
      {action && (
        <button onClick={action} className="px-5 py-2.5 bg-blue-600 text-white rounded-lg inline-flex items-center gap-2 hover:bg-blue-700 transition-colors shadow-sm hover:shadow-md">
          <Plus className="w-5 h-5" /> {actionLabel}
        </button>
      )}
    </div>
  );
};

// Progress Steps Component for Document Generation
const ProgressSteps = ({ steps, currentStep }) => (
  <div className="flex items-center gap-2">
    {steps.map((step, idx) => (
      <React.Fragment key={idx}>
        <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
          idx < currentStep ? 'bg-green-100 text-green-700' :
          idx === currentStep ? 'bg-blue-600 text-white shadow-md' :
          'bg-slate-100 text-slate-400'
        }`}>
          {idx < currentStep ? <CheckCircle className="w-4 h-4" /> : <span className="w-5 h-5 flex items-center justify-center">{idx + 1}</span>}
          {step}
        </div>
        {idx < steps.length - 1 && <div className={`w-8 h-0.5 ${idx < currentStep ? 'bg-green-300' : 'bg-slate-200'}`} />}
      </React.Fragment>
    ))}
  </div>
);

const Field = ({ label, value, onChange, type = 'text', className = '', ...props }) => (
  <div className={className}>
    <label className="block text-sm text-slate-600 mb-1.5 font-medium">{label}</label>
    <input type={type} value={value || ''} onChange={onChange} className="w-full border border-slate-200 rounded-lg px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all" {...props} />
  </div>
);

const NumberField = ({ label, value, onChange, className = '', decimals = 0, prefix = '', ...props }) => {
  const [focused, setFocused] = useState(false);
  const [localValue, setLocalValue] = useState('');

  const formatDisplay = (num) => {
    if (num === '' || num === null || num === undefined) return '';
    const n = typeof num === 'string' ? parseFloat(num) : num;
    if (isNaN(n)) return '';
    if (decimals > 0) {
      return prefix + n.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }
    return prefix + n.toLocaleString();
  };

  const handleFocus = () => {
    setFocused(true);
    setLocalValue(value?.toString() || '');
  };

  const handleBlur = () => {
    setFocused(false);
    const cleaned = localValue.replace(/[^0-9.-]/g, '');
    const parsed = decimals > 0 ? parseFloat(cleaned) : parseInt(cleaned);
    onChange({ target: { value: isNaN(parsed) ? 0 : parsed } });
  };

  const handleChange = (e) => {
    setLocalValue(e.target.value);
  };

  return (
    <div className={className}>
      <label className="block text-sm text-slate-600 mb-1.5 font-medium">{label}</label>
      <input
        type="text"
        value={focused ? localValue : formatDisplay(value)}
        onChange={handleChange}
        onFocus={handleFocus}
        onBlur={handleBlur}
        className="w-full border border-slate-200 rounded-lg px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
        {...props}
      />
    </div>
  );
};

const SelectField = ({ label, value, onChange, options, className = '' }) => (
  <div className={className}>
    <label className="block text-sm text-slate-600 mb-1.5 font-medium">{label}</label>
    <select value={value || ''} onChange={onChange} className="w-full border border-slate-200 rounded-lg px-3 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all bg-white">
      {options.map(o => <option key={o} value={o}>{o}</option>)}
    </select>
  </div>
);

const SectionHeader = ({ children, color = 'blue' }) => {
  const colors = {
    blue: 'border-blue-200 text-blue-700',
    slate: 'border-slate-200 text-slate-700',
    green: 'border-green-200 text-green-700',
    purple: 'border-purple-200 text-purple-700',
    orange: 'border-orange-200 text-orange-700',
    teal: 'border-teal-200 text-teal-700',
  };
  return (
    <div className={`col-span-2 mt-4 first:mt-0 pb-1 border-b-2 ${colors[color] || colors.blue}`}>
      <span className="text-sm font-semibold">{children}</span>
    </div>
  );
};

export default function VentureLegalApp() {
  // Template folder URL - update this to your Google Drive templates folder
  const TEMPLATE_FOLDER_URL = "https://drive.google.com/drive/folders/1FEjAo2oLvdGRmDCALwZZBj_wtFdbDM4E";
  
  // File input ref for import
  const fileInputRef = useRef(null);
  const [importError, setImportError] = useState(null);
  const [importSuccess, setImportSuccess] = useState(false);
  
  // Team Sharing state
  const [showTeamSharing, setShowTeamSharing] = useState(false);
  const [importJsonText, setImportJsonText] = useState('');
  
  // Backup tracking state - use single state object to ensure atomic updates
  const [backupState, setBackupState] = useState({
    hasUnsyncedChanges: false,
    unsyncedChangeCount: 0,
    showSyncReminder: false
  });
  const [lastCloudSync, setLastCloudSync] = useState(null);
  const syncReminderInterval = useRef(null);
  const SYNC_REMINDER_MINUTES = 5; // Remind every 5 minutes if there are unsynced changes
  
  // Fund-level costs (not tied to specific ventures)
  const [nonVentureStudioCost, setNonVentureStudioCost] = useState(0);
  
  // UX Enhancement State
  const [toast, setToast] = useState(null); // { message, type }
  const [searchQuery, setSearchQuery] = useState('');
  const [sortBy, setSortBy] = useState('name'); // 'name', 'date', 'raised', 'tvpi'
  const [showQuickAdd, setShowQuickAdd] = useState(false);
  
  // Helper to show toast
  const showToast = (message, type = 'success') => {
    setToast({ message, type });
  };
  
  const [ventures, setVentures] = useState([]);
  const [selectedVenture, setSelectedVenture] = useState(null);
  const [showNewVenture, setShowNewVenture] = useState(false);
  const [isLoadingVentures, setIsLoadingVentures] = useState(true);
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [ventureToDelete, setVentureToDelete] = useState(null);
  const [deleteConfirmText, setDeleteConfirmText] = useState('');
  const [isEditing, setIsEditing] = useState(false);
  const [editingVenture, setEditingVenture] = useState(null);
  const [showGeneratePrompt, setShowGeneratePrompt] = useState(false);
  const [ventureToGenerate, setVentureToGenerate] = useState(null);
  const [generateOptions, setGenerateOptions] = useState({
    // Individual documents - only formation documents selected by default
    docs: {
      // Formation - always needed
      certificateOfIncorporation: true,
      bylaws: true,
      actionOfIncorporator: true,
      organizationalResolutions: true,
      restrictedStockPurchaseAgreement: true,
      equityIncentivePlan: true,
      equityPlanStockholderConsent: true,
      // SAFE Templates - not selected by default (blank templates)
      safeMFN: false,
      safeValuationCap: false,
      // Option Agreement Templates
      immediatelyExercisableOption: false,
      nonImmediatelyExercisableOption: false,
      // Equity Plan Forms - not selected by default
      equityPlanRSPA: false,
      exerciseAgreementStandard: false,
      exerciseAgreementEarly: false,
      // Employment Templates - not selected by default
      offerLetter: false,
      eiaca: false,
      // Advisor/Consultant Templates - not selected by default
      advisorAgreement: false,
      consultingAgreement: false,
      corporateConsultingAgreement: false,
      ipStockPurchaseAgreement: false,
    },
    // Categories (derived from docs)
    formation: true,
    safeTemplates: false,
    equityPlan: false,
    equityPlanForms: false,
    employment: false,
    // Individual awardee documents - will be set based on data availability
    individualSafes: true,
    individualOptions: true,
    individualAdvisors: true,
    overwrite: false
  });

  // Individual document generation
  const [showIndividualGenerate, setShowIndividualGenerate] = useState(false);
  const [individualDocType, setIndividualDocType] = useState(null); // 'safe', 'employee', 'advisor'
  const [individualDocData, setIndividualDocData] = useState(null);
  const [individualOverwrite, setIndividualOverwrite] = useState(true);
  const [entryDeleteConfirm, setEntryDeleteConfirm] = useState(null);
  const [entryDeleteText, setEntryDeleteText] = useState('');
  
  // Audit log state
  const [showAuditLog, setShowAuditLog] = useState(false);
  const [auditLogExpanded, setAuditLogExpanded] = useState(false);

  // New modals for adding entries
  const [showAddFunding, setShowAddFunding] = useState(false);
  const [showAddEmployee, setShowAddEmployee] = useState(false);
  const [showAddAdvisor, setShowAddAdvisor] = useState(false);

  // Edit modals
  const [editingFunding, setEditingFunding] = useState(null);
  const [editingEmployee, setEditingEmployee] = useState(null);
  const [editingAdvisor, setEditingAdvisor] = useState(null);
  
  // Inline editing for paid-in capital on home page
  const [inlinePaidIn, setInlinePaidIn] = useState({}); // { ventureId: value }
  const [savingPaidIn, setSavingPaidIn] = useState({}); // { ventureId: true/false }

  // New entry forms - with expanded fields for document generation
  const defaultFundingRound = {
    type: 'SAFE',
    investorName: '',
    date: '',
    amount: 0,
    valuationCap: 0,
    discount: 0,
    valuationType: 'Post-Money',
    valuation: 0,
    sharesIssued: 0,
    pricePerShare: 0,
    safeTemplate: 'valuationCap', // 'valuationCap' or 'mfn'
    // Additional fields for document generation
    investorAddress: '',
    investorEmail: '',
    investorJurisdiction: '',
  };

  const defaultEmployeeGrant = {
    employeeName: '',
    employeeTitle: '', // Job title for the employee
    grantDate: '',
    shares: 0,
    vestingSchedule: '4 years with 1 year cliff',
    exercisePrice: 0.01,
    grantType: 'ISO',
    optionAgreementType: 'standard', // 'standard' (non-immediately exercisable) or 'earlyExercise' (immediately exercisable)
    // Additional fields for document generation
    employeeAddress: '',
    employeeEmail: '',
    vestingStartDate: '',
  };

  const defaultAdvisorGrant = {
    advisorName: '',
    advisorTitle: '', // Title/role for signature block
    grantDate: '',
    shares: 0,
    vestingSchedule: '2 years monthly',
    exercisePrice: 0.01,
    agreementType: 'advisor', // 'advisor', 'consulting', or 'ipStockPurchase'
    // Additional fields for document generation
    advisorAddress: '',
    advisorEmail: '',
    monthlyHours: '',
    consultingFee: '',
    hourlyRate: '',
    servicesDescription: '',
    scopeOfWork: '',
    areaOfExpertise: '',
    // IP Stock Purchase specific
    projectName: '',
    descriptionOfAdvisorIPAssignment: '', // Description of IP being assigned by advisor
    domainNames: '',
    socialAccounts: '',
    githubRepos: '',
    wordMarks: '',
  };

  // Pre-generation field collection state
  const [showPreGenerate, setShowPreGenerate] = useState(false);
  const [showScriptSection, setShowScriptSection] = useState(false); // Controls when to show the script in generate modal
  const [skippedFields, setSkippedFields] = useState(false); // Track if user chose to skip filling fields
  const [preGenerateData, setPreGenerateData] = useState({
    // Venture-level fields that might be missing
    effectiveDate: '',
    presidentName: '',
    secretaryName: '',
    treasurerName: '',
    // Per-entry overrides collected at generation time
    fundingOverrides: {}, // keyed by index
    employeeOverrides: {}, // keyed by index
    advisorOverrides: {}, // keyed by index
  });

  const [newFunding, setNewFunding] = useState({...defaultFundingRound});
  const [newEmployee, setNewEmployee] = useState({...defaultEmployeeGrant});
  const [newAdvisor, setNewAdvisor] = useState({...defaultAdvisorGrant});
  const [docLearnMore, setDocLearnMore] = useState(null);
  const [showTemplateDocuments, setShowTemplateDocuments] = useState(false);

  const documentDefinitions = {
    // Formation Documents
    certificateOfIncorporation: {
      id: 'certificateOfIncorporation',
      name: 'Certificate of Incorporation',
      category: 'formation',
      required: true,
      brief: 'The official document filed with the state to legally form your corporation.',
      detailed: `The Certificate of Incorporation is the foundational legal document that officially creates your corporation under Delaware law. This document is filed with the Delaware Secretary of State and establishes your company as a legal entity separate from its founders.

This document defines the fundamental structure of your corporation: the company's legal name, the types and number of shares the company is authorized to issue (both Common Stock and any preferred classes like FF Preferred), the par value of shares, and the registered agent who will receive legal notices on behalf of the company.

Delaware is the preferred state of incorporation for most venture-backed startups because of its well-developed corporate law, business-friendly Court of Chancery, and the predictability this provides to investors. Once filed and accepted, the Certificate of Incorporation allows you to issue stock, open bank accounts, and conduct business as a corporation.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Total Shares Authorized', source: 'Total Shares Authorized' },
        { field: 'Common Stock Authorized', source: 'Common Shares Authorized' },
        { field: 'FF Preferred Stock Authorized', source: 'FF Preferred Shares Authorized' },
        { field: 'Par Value', source: 'Par Value' },
        { field: 'FF Preferred Par Value', source: 'FF Preferred Par Value' },
        { field: 'Registered Agent Name', source: 'Registered Agent' },
        { field: 'Registered Agent Address', source: 'Registered Agent Address' },
        { field: 'Incorporator Name', source: 'Incorporator Name' },
      ]
    },
    bylaws: {
      id: 'bylaws',
      name: 'Bylaws',
      category: 'formation',
      required: true,
      brief: 'Internal rules governing how your corporation operates and makes decisions.',
      detailed: `Bylaws are the internal operating manual for your corporation. Unlike the Certificate of Incorporation, bylaws are not filed with the state—they're kept with your corporate records and govern the day-to-day operations and decision-making processes of the company.

The bylaws establish the rules for how shareholders and directors meet and vote, how officers are appointed and what their duties are, how stock is issued and transferred, and how the company can indemnify its directors and officers against lawsuits. They also specify quorum requirements, notice periods for meetings, and procedures for amending the bylaws themselves.

Well-drafted bylaws are essential for maintaining proper corporate governance. Investors and acquirers will review your bylaws during due diligence to ensure the company has been properly managed. The bylaws should be formally adopted at the first board meeting after incorporation.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    actionOfIncorporator: {
      id: 'actionOfIncorporator',
      name: 'Action of Incorporator',
      category: 'formation',
      required: true,
      brief: 'Appoints the initial board of directors and adopts the bylaws.',
      detailed: `The Action of Incorporator is the critical bridge document between filing your Certificate of Incorporation and beginning actual corporate operations. The incorporator (the person who signed and filed the Certificate of Incorporation) uses this document to take the first official corporate actions.

This document serves three essential purposes: it formally adopts the company's Bylaws, appoints the initial Board of Directors, and transfers control from the incorporator to the Board. Once this action is completed, the incorporator's role is finished—all future corporate actions will be taken by the Board of Directors or shareholders.

This document establishes the chain of authority that legitimizes all subsequent corporate actions. Investors and acquirers will review this document during due diligence to verify that proper corporate formalities were followed from the very beginning. Without this document, there could be questions about whether later corporate actions (like issuing stock) were properly authorized.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Incorporator Name', source: 'Incorporator Name' },
        { field: 'Initial Director Name', source: 'Initial Director Name' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    organizationalResolutions: {
      id: 'organizationalResolutions',
      name: 'Organizational Resolutions',
      category: 'formation',
      required: true,
      brief: 'Board resolutions that authorize key startup actions like issuing stock and opening bank accounts.',
      detailed: `The Organizational Resolutions (also called Initial Board Resolutions or First Resolutions of the Board) document the decisions made at the first meeting of your Board of Directors. This is where the company officially comes to life as an operating business.

These resolutions typically authorize: election of officers (CEO, President, Secretary, Treasurer), adoption of the Equity Incentive Plan, issuance of founder shares, approval of the Restricted Stock Purchase Agreement, opening of bank accounts, selection of the company's fiscal year, and authorization to qualify to do business in other states where needed.

This document is critical for establishing the "paper trail" that shows your company has followed proper corporate formalities. Banks will require a copy of these resolutions (specifically the banking resolution) to open corporate accounts. Investors will review these during due diligence. The resolutions should be signed by all directors and kept with your permanent corporate records.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Initial Director Name', source: 'Initial Director Name' },
        { field: 'Equity Plan Year', source: 'Equity Plan Year' },
        { field: 'Option Pool Shares', source: 'Option Pool Shares' },
        { field: 'Founder Entity Name', source: 'Founder Entity Name' },
        { field: 'Founder Common Shares', source: 'Founder Common Shares' },
        { field: 'Founder Common Purchase Price', source: 'Founder Common Purchase Price' },
        { field: 'Founder FF Preferred Shares', source: 'Founder FF Preferred Shares' },
        { field: 'Founder FF Preferred Purchase Price', source: 'Founder FF Preferred Purchase Price' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    restrictedStockPurchaseAgreement: {
      id: 'restrictedStockPurchaseAgreement',
      name: 'Restricted Stock Purchase Agreement',
      category: 'formation',
      required: true,
      brief: 'Agreement for founders to purchase shares subject to vesting and company repurchase rights.',
      detailed: `The Restricted Stock Purchase Agreement (RSPA) is the contract under which founders purchase their initial equity in the company. The shares are "restricted" because they're subject to vesting—if a founder leaves before fully vesting, the company can repurchase unvested shares at the original purchase price.

The RSPA includes the vesting schedule (typically 4 years with a 1-year cliff), the company's repurchase right for unvested shares, transfer restrictions preventing founders from selling shares without company consent, a right of first refusal giving the company the option to buy shares before they're sold to third parties, and critically important 83(b) election language.

IMPORTANT: Founders should file an 83(b) election with the IRS within 30 days of signing this agreement. The 83(b) election allows founders to pay tax on the shares at their current (low) value rather than as they vest at potentially much higher values. Failing to file an 83(b) election can result in enormous unexpected tax bills. This is one of the most common and costly mistakes founders make.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Founder/Purchaser Name', source: 'Founder Entity Name' },
        { field: 'Common Shares Purchased', source: 'Founder Common Shares' },
        { field: 'Common Stock Purchase Price', source: 'Founder Common Purchase Price' },
        { field: 'FF Preferred Shares Purchased', source: 'Founder FF Preferred Shares' },
        { field: 'FF Preferred Purchase Price', source: 'Founder FF Preferred Purchase Price' },
        { field: 'Par Value', source: 'Par Value' },
        { field: 'FF Preferred Par Value', source: 'FF Preferred Par Value' },
      ]
    },
    equityIncentivePlan: {
      id: 'equityIncentivePlan',
      name: 'Equity Incentive Plan',
      category: 'formation',
      required: true,
      brief: 'Framework for granting stock options and equity awards to employees and advisors.',
      detailed: `The Equity Incentive Plan (also called Stock Option Plan or Stock Incentive Plan) is the legal framework that allows your company to grant equity compensation to employees, advisors, and consultants. Without this plan, you cannot issue stock options.

The plan establishes: the share reserve (option pool) available for grants, the types of awards that can be made (Incentive Stock Options, Non-Qualified Stock Options, Restricted Stock Awards, RSUs), standard vesting terms, exercise procedures and post-termination exercise periods, and how the plan is administered by the Board or a committee.

ISOs (Incentive Stock Options) offer favorable tax treatment for employees—they're not taxed at exercise if certain holding periods are met—but are only available to employees (not contractors or advisors) and have a $100,000 annual limit. NSOs (Non-Qualified Stock Options) are more flexible but are taxed as ordinary income on the "spread" (difference between exercise price and fair market value) at exercise. The plan must be approved by both the Board and stockholders for ISOs to qualify for their tax benefits.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
        { field: 'Share Reserve / Option Pool', source: 'Option Pool Shares' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    equityPlanStockholderConsent: {
      id: 'equityPlanStockholderConsent',
      name: 'Equity Plan Stockholder Consent',
      category: 'formation',
      required: true,
      brief: 'Stockholder approval required for the equity incentive plan.',
      detailed: `The Equity Plan Stockholder Consent is the formal stockholder approval of the Equity Incentive Plan. This approval is legally required for Incentive Stock Options (ISOs) to qualify for their favorable tax treatment under Internal Revenue Code Section 422.

For early-stage companies where the founders own 100% of the shares, this approval is typically done by written consent rather than holding a formal stockholder meeting. The consent must be obtained within 12 months before or after the Board adopts the plan.

This document should be kept with your permanent corporate records and will be reviewed during due diligence by investors and acquirers. If you later increase the share reserve (option pool) or make material amendments to the plan, you'll need to obtain new stockholder approval. Failing to have proper stockholder approval means any ISOs granted under the plan may be recharacterized as NSOs, resulting in adverse tax consequences for your employees.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
        { field: 'Share Reserve / Option Pool', source: 'Option Pool Shares' },
        { field: 'Founder/Stockholder Name', source: 'Founder Entity Name' },
      ]
    },
    // SAFE Templates
    safeMFN: {
      id: 'safeMFN',
      name: 'Post-Money SAFE - MFN Only',
      category: 'safeTemplates',
      required: false,
      brief: 'Simple investment agreement with Most Favored Nation clause but no valuation cap.',
      detailed: `The MFN (Most Favored Nation) SAFE is an investment instrument used when you want to accept investment without setting a specific valuation cap. This is the standard Y Combinator post-money SAFE with only an MFN provision.

The MFN clause provides investor protection: if you later issue SAFEs with better terms (like a valuation cap or discount), the MFN investor has the right to amend their SAFE to match those better terms. This allows early investors to invest without forcing the company to set a valuation when there may not be enough traction to justify one.

This template document is generated for reference and use with future investors. When you actually close an investment, you'll fill in the specific investor details. The MFN SAFE has no maturity date, pays no interest, doesn't give the investor a board seat, and converts to equity at the next priced financing round at whatever price that round sets (or at the better terms obtained via the MFN clause).`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    safeValuationCap: {
      id: 'safeValuationCap',
      name: 'Post-Money SAFE - Valuation Cap Only',
      category: 'safeTemplates',
      required: false,
      brief: 'Simple investment agreement that converts to equity at a capped valuation.',
      detailed: `The Valuation Cap SAFE is the most common form of early-stage startup investment. This is the standard Y Combinator post-money SAFE with a valuation cap, which sets the maximum valuation at which the investment converts to equity.

The "post-money" designation is important: it means the valuation cap includes the SAFE investment amount and the option pool. This makes the math simple—an investor knows exactly what percentage they'll own at conversion (Investment Amount ÷ Valuation Cap = Ownership %). For example, a $500K investment at a $5M post-money cap guarantees the investor 10% ownership at conversion.

This template document is generated for reference. When closing actual investments, you'll fill in: the investor's name, the investment amount, the valuation cap, and the effective date. The SAFE converts to preferred stock at your next priced financing round at the lower of the cap or the actual round price, ensuring early investors are rewarded for their early risk.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    // Equity Plan Forms
    immediatelyExercisableOption: {
      id: 'immediatelyExercisableOption',
      name: 'Immediately Exercisable Option Agreement',
      category: 'equityPlan',
      required: false,
      brief: 'Stock option that can be exercised before vesting, enabling early exercise for tax benefits.',
      detailed: `The Immediately Exercisable Option Agreement (also called Early Exercise Option) allows the recipient to exercise their stock options before the underlying shares have vested. This is a significant tax planning opportunity, especially for early employees.

When an employee early exercises, they pay the exercise price upfront to purchase shares, but the unvested shares remain subject to the company's repurchase right at the exercise price if the employee leaves. The key benefit is the ability to file an 83(b) election within 30 days of exercise, which starts the capital gains clock immediately.

This matters because: if an employee waits to exercise until shares are vested and valuable, they'll owe ordinary income tax on the spread between exercise price and fair market value (for NSOs) or potentially AMT (for ISOs). By early exercising when the spread is zero or minimal, and filing an 83(b) election, all future appreciation can qualify for long-term capital gains treatment (currently taxed at lower rates than ordinary income). This can result in significant tax savings for early employees.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    nonImmediatelyExercisableOption: {
      id: 'nonImmediatelyExercisableOption',
      name: 'Non-Immediately Exercisable Option Agreement',
      category: 'equityPlan',
      required: false,
      brief: 'Standard stock option that can only be exercised after vesting.',
      detailed: `The Non-Immediately Exercisable Option Agreement is the traditional form of stock option grant. The recipient can only exercise (purchase) shares after they vest according to the vesting schedule, typically 4 years with a 1-year cliff.

This approach is simpler for both the company and the employee: the employee doesn't need to pay anything upfront, doesn't take on the risk of buying shares that might become worthless, and doesn't need to worry about 83(b) elections. The company has simpler administration since it doesn't need to track repurchase rights on unvested exercised shares.

The trade-off is tax treatment. For NSOs (Non-Qualified Stock Options), the employee owes ordinary income tax on the spread between exercise price and fair market value at the time of exercise—this can be a substantial tax bill if the company has grown significantly. For ISOs (Incentive Stock Options), there's no regular tax at exercise, but the spread may trigger Alternative Minimum Tax (AMT). This template is used when granting options to employees under your Equity Incentive Plan.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    // Employment & Advisor
    offerLetter: {
      id: 'offerLetter',
      name: 'Multistate Offer Letter',
      category: 'employment',
      required: false,
      brief: 'Employment offer letter template compliant with multiple state requirements.',
      detailed: `The Multistate Offer Letter is a template for extending employment offers that's designed to comply with the varying requirements of different U.S. states. Employment law differs significantly by state, and this template includes provisions and disclosures needed across multiple jurisdictions.

The offer letter covers: position title and reporting structure, start date, compensation (base salary, any bonus structure), equity compensation (referencing the separate option agreement), benefits eligibility, at-will employment status, and references to additional agreements the employee will sign (like PIIA/CIIAA for intellectual property assignment).

This is a template document—you'll customize it for each hire with their specific terms. Note that some states have additional requirements: California requires specific language about at-will employment, some states require disclosure of pay ranges, and certain localities have their own requirements. For key hires or hires in states with complex employment laws (CA, NY, MA), consider having an employment attorney review the customized offer letter.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    advisorAgreement: {
      id: 'advisorAgreement',
      name: 'Advisor Agreement',
      category: 'employment',
      required: false,
      brief: 'Agreement for advisors providing services in exchange for equity compensation.',
      detailed: `The Advisor Agreement establishes the relationship between your company and advisors—experienced individuals who provide strategic guidance, introductions, or expertise in exchange for equity compensation. Unlike employees, advisors are independent contractors with a typically lighter time commitment.

The agreement covers: the scope of advisory services expected, time commitment (often expressed as hours per month or availability for calls/meetings), equity compensation (typically 0.25% to 1% of the company depending on stage and involvement level), vesting schedule (advisors often vest over 2 years monthly rather than the 4-year employee schedule), confidentiality obligations, intellectual property assignment for any work product, and termination provisions.

Advisors receive NSOs (Non-Qualified Stock Options) rather than ISOs since they're not employees. This template is used when bringing on advisors—you'll fill in the specific advisor's name, the number of shares, vesting schedule, and any specific terms for their engagement. Be thoughtful about advisor equity; it comes from your option pool and dilutes everyone.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year (for option reference)', source: 'Equity Plan Year' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    consultingAgreement: {
      id: 'consultingAgreement',
      name: 'Consulting Agreement',
      category: 'employment',
      required: false,
      brief: 'Agreement for consultants providing ongoing services in exchange for cash and/or equity.',
      detailed: `The Consulting Agreement is used when engaging independent contractors who provide more substantial, ongoing services than a typical advisor. Unlike advisors who primarily provide strategic guidance, consultants typically perform specific deliverable-based work.

The agreement covers: detailed scope of services and deliverables, payment terms (hourly rate, project fee, or retainer), equity compensation if applicable (typically NSOs), work schedule and availability expectations, confidentiality and non-disclosure obligations, intellectual property assignment (critical—ensures the company owns all work product), independent contractor status confirmation, and termination provisions.

Key distinction from employment: consultants are 1099 independent contractors, not W-2 employees. This means no tax withholding, no benefits, and the consultant is responsible for their own taxes. Be careful about misclassification—the IRS and state agencies have specific tests for whether someone is truly an independent contractor. If you control how, when, and where the work is done, they may be considered an employee.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year (for option reference)', source: 'Equity Plan Year' },
        { field: 'State of Incorporation', source: 'State' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    ipStockPurchaseAgreement: {
      id: 'ipStockPurchaseAgreement',
      name: 'Restricted Stock Purchase Agreement (IP Assignment)',
      category: 'employment',
      required: false,
      brief: 'Agreement for founders or contributors to purchase stock in exchange for assigning intellectual property to the company.',
      detailed: `The IP Assignment Stock Purchase Agreement is used when someone contributes intellectual property to the company in exchange for equity. This is common when: a founder developed technology before incorporation that needs to be assigned to the company, a technical co-founder joins and contributes pre-existing IP, or an advisor/consultant has developed relevant IP that the company wants to acquire.

The agreement combines two critical elements: an assignment of intellectual property rights (patents, copyrights, trade secrets, know-how) to the company, and a restricted stock purchase where the contributor receives shares in exchange. The shares are typically subject to vesting just like founder shares.

This document is essential for clean IP ownership. Investors will conduct IP due diligence and want to see clear chains of title showing the company owns all its intellectual property. Any IP developed by founders before incorporation, or contributed by others, should be formally assigned. The contributor should also file an 83(b) election within 30 days to avoid adverse tax consequences as shares vest.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
        { field: 'Par Value', source: 'Par Value' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    // NEW: Employee IP and Confidentiality Agreement
    eiaca: {
      id: 'eiaca',
      name: 'Employee Invention Assignment & Confidentiality Agreement (EIACA)',
      category: 'employment',
      required: false,
      brief: 'Ensures company ownership of employee inventions and protects confidential information.',
      detailed: `The Employee Invention Assignment and Confidentiality Agreement (EIACA, also called PIIA or CIIAA) is a critical employment document that protects the company's intellectual property and confidential information. Every employee should sign this agreement.

The agreement covers several key areas: assignment of inventions (ensuring any work product created during employment belongs to the company), confidentiality obligations (protecting trade secrets, business plans, customer lists, and other proprietary information), non-solicitation provisions (preventing departing employees from poaching colleagues or customers), and acknowledgment of prior inventions (documenting what IP the employee brings to the company that won't be assigned).

This document is essential for any company with intellectual property—which is essentially every startup. Investors and acquirers will verify during due diligence that all employees have signed invention assignment agreements. Without these agreements, there could be disputes about who owns key technology. California has specific carve-outs for employee inventions created entirely on their own time without company resources, which this template accommodates.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    // NEW: Corporate Consulting Agreement
    corporateConsultingAgreement: {
      id: 'corporateConsultingAgreement',
      name: 'Corporate Consulting Agreement (Entity)',
      category: 'employment',
      required: false,
      brief: 'Agreement for engaging a corporate entity to provide consulting services.',
      detailed: `The Corporate Consulting Agreement is used when engaging a business entity (corporation, LLC, or partnership) rather than an individual to provide consulting services. This is common when working with consulting firms, agencies, or when an individual consultant operates through their own company.

The key differences from an individual consulting agreement include: the contracting party is the entity rather than the individual, the entity is responsible for its own employees and subcontractors, liability and indemnification provisions are structured for entity-to-entity relationships, and payment terms may differ (often NET-30 invoicing).

The agreement still covers critical elements: detailed scope of work, deliverables and milestones, payment terms and invoicing procedures, confidentiality obligations, intellectual property assignment (critical—work product must be assigned to your company), representations and warranties from the consulting entity, and termination provisions. When working with a corporate consultant, ensure their employees who perform work also sign individual confidentiality agreements.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'State of Incorporation', source: 'State' },
        { field: 'Principal Office Address', source: 'Principal Office Address' },
      ]
    },
    // NEW: Equity Plan RSPA with Vesting (for employees/service providers under the plan)
    equityPlanRSPA: {
      id: 'equityPlanRSPA',
      name: 'Equity Plan Restricted Stock Purchase Agreement',
      category: 'equityPlanForms',
      required: false,
      brief: 'Agreement for employees to purchase restricted stock under the equity incentive plan.',
      detailed: `The Equity Plan Restricted Stock Purchase Agreement (RSPA) allows employees and service providers to purchase shares of company stock under the Equity Incentive Plan, subject to vesting restrictions. This is different from stock options—the recipient actually owns the shares from day one, but unvested shares can be repurchased by the company if the person leaves.

This approach is sometimes preferred over stock options because: the recipient owns real shares immediately (with voting rights and dividends), there's no "exercise" transaction needed later, and with an 83(b) election filed within 30 days, all future appreciation can qualify for long-term capital gains treatment.

The agreement covers: number of shares being purchased, purchase price (typically fair market value), vesting schedule (usually 4 years with 1-year cliff), company's right to repurchase unvested shares at the original purchase price, transfer restrictions, and right of first refusal. Recipients should strongly consider filing an 83(b) election within 30 days to lock in current tax treatment on the shares.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
        { field: 'State of Incorporation', source: 'State' },
      ]
    },
    // NEW: Exercise Agreement for Standard (Non-Immediately Exercisable) Options
    exerciseAgreementStandard: {
      id: 'exerciseAgreementStandard',
      name: 'Stock Option Exercise Agreement (Standard)',
      category: 'equityPlanForms',
      required: false,
      brief: 'Form for employees to exercise vested stock options and purchase shares.',
      detailed: `The Stock Option Exercise Agreement is the form used when an option holder decides to exercise their vested stock options and purchase the underlying shares. This is the companion document to the Non-Immediately Exercisable Option Agreement.

When exercising options, the option holder: completes this form specifying how many shares they're exercising, pays the exercise price (shares × exercise price per share), may need to pay for tax withholding (for NSOs, the spread is taxable income), and receives actual shares of company stock.

The form captures: option holder information, option grant details (grant number, date, exercise price), number of shares being exercised, payment method (check, wire, or potentially cashless exercise if allowed), tax withholding elections, and acknowledgment of transfer restrictions on the shares. For NSOs, the company must withhold taxes or collect equivalent payment. For ISOs, there's no withholding required but the spread may trigger AMT.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
      ]
    },
    // NEW: Exercise Agreement for Early Exercise Options
    exerciseAgreementEarly: {
      id: 'exerciseAgreementEarly',
      name: 'Stock Option Exercise Agreement (Early Exercise)',
      category: 'equityPlanForms',
      required: false,
      brief: 'Form for early-exercising unvested stock options, enabling 83(b) election for tax benefits.',
      detailed: `The Early Exercise Agreement is used when an option holder with immediately exercisable options chooses to exercise before their shares have vested. This is a powerful tax planning tool that enables the 83(b) election strategy.

By early exercising when the spread between exercise price and fair market value is minimal (ideally zero), and filing an 83(b) election within 30 days, the option holder can: start the capital gains holding period clock immediately, avoid ordinary income tax on future appreciation (for NSOs), avoid AMT on future appreciation (for ISOs), and potentially qualify for long-term capital gains treatment on all appreciation if shares are held long enough.

The agreement includes: standard exercise provisions, acknowledgment that unvested shares remain subject to the company's repurchase right, 83(b) election information and instructions (critical—must be filed with IRS within 30 days), and transfer restrictions. The option holder takes on risk by paying for shares upfront that could be forfeited if they leave before vesting, but the potential tax savings can be substantial.`,
      fieldsUpdated: [
        { field: 'Company Name', source: 'Legal Name' },
        { field: 'Plan Year', source: 'Equity Plan Year' },
      ]
    }
  };

  const templateList = Object.values(documentDefinitions);

  const folderStructure = [
    { name: 'Formation Documents', required: true },
    { name: 'SAFE Agreements', required: false },
    { name: 'Equity Plan Forms', required: false },
    { name: 'Employment and Advisor Agreements', required: false },
  ];

  const defaultVenture = {
    legalName: '',
    foundedDate: '',
    state: 'Delaware',
    driveFolderUrl: '',
    registeredAgent: 'Corporation Service Company',
    registeredAgentAddress: '251 Little Falls Drive, City of Wilmington, County of New Castle, Delaware 19808',
    principalOfficeAddress: '301 E Archer St., Tulsa, Oklahoma 74120',
    totalSharesAuthorized: 10000000,
    commonSharesAuthorized: 9200000,
    ffPreferredSharesAuthorized: 800000,
    parValue: 0.00001,
    ffPreferredParValue: 0.00002,
    incorporatorName: 'Jacob Johnson',
    initialDirectorName: 'Jacob Johnson',
    presidentName: '',
    secretaryName: '',
    treasurerName: '',
    founderEntityName: 'GVS Founders II LLC',
    founderCommonShares: 7200000,
    founderCommonPurchasePrice: 72.00,
    founderFFPreferredShares: 800000,
    founderFFPreferredPurchasePrice: 16.00,
    // Formation RSPA - IP assignment description for GVS/founder
    descriptionOfGVSIPAssignment: '',
    equityPlanYear: '2025',
    optionPoolShares: 1000000,
    status: 'Active',
    fundingRounds: [],
    employeeGrants: [],
    advisorGrants: [],
    // TVPI tracking fields
    paidInCapital: 0,
    paidInCapitalUpdatedAt: null,
    // Document generation audit log
    documentAuditLog: [],
  };

  const [newVenture, setNewVenture] = useState({...defaultVenture});

  useEffect(() => { 
    const initializeApp = async () => {
      // Load local ventures and settings
      await loadVentures();
      await loadFundSettings();
      
      // Load last backup time
      try {
        const result = await window.storage.get('backup:lastSync');
        if (result?.value) {
          setLastCloudSync(result.value);
        }
      } catch { /* ignore */ }
    };
    
    initializeApp();
  }, []);

  // Scroll to top when navigating to venture detail
  useEffect(() => {
    if (selectedVenture) {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }, [selectedVenture]);

  const loadFundSettings = async () => {
    try {
      const result = await window.storage.get('fund:settings');
      if (result?.value) {
        const settings = JSON.parse(result.value);
        setNonVentureStudioCost(settings.nonVentureStudioCost || 0);
      }
    } catch { /* ignore */ }
  };

  const saveNonVentureStudioCost = async (value) => {
    setNonVentureStudioCost(value);
    try {
      await window.storage.set('fund:settings', JSON.stringify({ nonVentureStudioCost: value }));
    } catch { /* ignore */ }
  };

  const loadVentures = async () => {
    try {
      const result = await window.storage.list('venture:');
      if (result?.keys && result.keys.length > 0) {
        const ventureData = await Promise.all(
          result.keys.map(async (key) => {
            try {
              const data = await window.storage.get(key);
              if (data?.value) {
                const parsed = JSON.parse(data.value);
                return { ...defaultVenture, ...parsed };
              }
              return null;
            } catch { return null; }
          })
        );
        setVentures(ventureData.filter(v => v !== null));
      } else {
        setVentures([]);
      }
    } catch (err) { 
      console.error('Failed to load ventures:', err);
      setVentures([]); 
    } finally {
      // Always set loading to false, even if there's an error
      setIsLoadingVentures(false);
    }
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // BACKUP TRACKING FUNCTIONS
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Mark that there are unsynced changes
  const markUnsyncedChange = () => {
    setBackupState(prev => ({
      ...prev,
      hasUnsyncedChanges: true,
      unsyncedChangeCount: prev.unsyncedChangeCount + 1
    }));
  };
  
  // Mark that data has been backed up (reset the counter)
  const markAsSynced = async () => {
    setBackupState({
      hasUnsyncedChanges: false,
      unsyncedChangeCount: 0,
      showSyncReminder: false
    });
    const syncTime = new Date().toISOString();
    setLastCloudSync(syncTime);
    
    // Save the backup time
    try {
      await window.storage.set('backup:lastSync', syncTime);
    } catch { /* ignore */ }
  };
  
  // Set up periodic backup reminder
  useEffect(() => {
    // Clear any existing interval
    if (syncReminderInterval.current) {
      clearInterval(syncReminderInterval.current);
    }
    
    // Set up new interval to check for unsynced changes
    syncReminderInterval.current = setInterval(() => {
      setBackupState(prev => {
        if (prev.hasUnsyncedChanges && prev.unsyncedChangeCount > 0) {
          // Show toast - but we need to be careful not to cause re-render loops
          // Just set the reminder flag, the toast will be shown by the component
          return { ...prev, showSyncReminder: true };
        }
        return prev;
      });
    }, SYNC_REMINDER_MINUTES * 60 * 1000); // Convert minutes to milliseconds
    
    return () => {
      if (syncReminderInterval.current) {
        clearInterval(syncReminderInterval.current);
      }
    };
  }, []); // Empty deps - only run once
  
  // Show toast when reminder flag is set
  useEffect(() => {
    if (backupState.showSyncReminder && backupState.hasUnsyncedChanges) {
      showToast(`⚠️ You have ${backupState.unsyncedChangeCount} unsynced changes. Click to backup your data.`, 'error');
    }
  }, [backupState.showSyncReminder]);
  
  // Warn before closing if there are unsynced changes
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      if (backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0) {
        e.preventDefault();
        e.returnValue = 'You have unsynced changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [backupState.hasUnsyncedChanges, backupState.unsyncedChangeCount]);

  // Export all ventures data to JSON file
  const exportData = () => {
    const exportPayload = {
      exportDate: new Date().toISOString(),
      version: '1.0',
      fundSettings: {
        nonVentureStudioCost: nonVentureStudioCost
      },
      ventures: ventures
    };
    const dataStr = JSON.stringify(exportPayload, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `venture-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  // Import ventures data from JSON file
  const handleImport = async (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    
    setImportError(null);
    setImportSuccess(false);
    
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      // Validate structure
      if (!data.ventures || !Array.isArray(data.ventures)) {
        throw new Error('Invalid backup file format');
      }
      
      // Save each venture to storage
      for (const venture of data.ventures) {
        if (venture.id) {
          await window.storage.set(`venture:${venture.id}`, JSON.stringify(venture));
        }
      }
      
      // Restore fund settings if present
      if (data.fundSettings) {
        await saveNonVentureStudioCost(data.fundSettings.nonVentureStudioCost || 0);
      }
      
      // Reload ventures
      await loadVentures();
      setImportSuccess(true);
      setTimeout(() => setImportSuccess(false), 3000);
    } catch (err) {
      setImportError(err.message || 'Failed to import data');
      setTimeout(() => setImportError(null), 5000);
    }
    
    // Reset file input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  // ═══════════════════════════════════════════════════════════════
  // TEAM SHARING FUNCTIONS
  // ═══════════════════════════════════════════════════════════════
  
  // Generate the team data export
  const getTeamExportData = () => {
    return {
      exportDate: new Date().toISOString(),
      version: '1.0',
      fundSettings: {
        nonVentureStudioCost: nonVentureStudioCost
      },
      ventures: ventures
    };
  };

  // Copy team data as JSON to clipboard
  const copyTeamData = () => {
    const data = getTeamExportData();
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    showToast('Team data copied to clipboard!', 'success');
  };

  // Import team data from pasted JSON
  const importTeamData = async (jsonText) => {
    try {
      const data = JSON.parse(jsonText);
      
      if (!data.ventures || !Array.isArray(data.ventures)) {
        throw new Error('Invalid data format');
      }
      
      // Save each venture to storage
      for (const venture of data.ventures) {
        if (venture.id) {
          await window.storage.set(`venture:${venture.id}`, JSON.stringify(venture));
        }
      }
      
      // Restore fund settings if present
      if (data.fundSettings) {
        await saveNonVentureStudioCost(data.fundSettings.nonVentureStudioCost || 0);
      }
      
      // Reload ventures
      await loadVentures();
      showToast(`Imported ${data.ventures.length} ventures!`, 'success');
      setImportJsonText('');
      setShowTeamSharing(false);
      return true;
    } catch (err) {
      showToast('Import failed: ' + err.message, 'error');
      return false;
    }
  };

  /**
   * Generate placeholder mappings using {{PLACEHOLDER}} syntax
   * Maps standardized template placeholders to venture data
   */
  const generateFieldMappings = (venture) => {
    const legalName = venture.legalName || '';
    const totalFounderPurchasePrice = (venture.founderCommonPurchasePrice || 0) + (venture.founderFFPreferredPurchasePrice || 0);
    
    // New {{PLACEHOLDER}} based mappings
    const placeholders = {
      // ═══════════════════════════════════════════════════════════════
      // COMPANY INFORMATION
      // ═══════════════════════════════════════════════════════════════
      '{{COMPANY_NAME}}': legalName,
      '{{COMPANY_SHORT_NAME}}': legalName.replace(/, Inc\.?$|, LLC\.?$|, Corp\.?$/i, ''),
      '{{STATE_OF_INCORPORATION}}': venture.state || 'Delaware',
      
      // ═══════════════════════════════════════════════════════════════
      // REGISTERED AGENT
      // ═══════════════════════════════════════════════════════════════
      '{{REGISTERED_AGENT_NAME}}': venture.registeredAgent || '',
      '{{REGISTERED_AGENT_ADDRESS}}': venture.registeredAgentAddress || '',
      
      // ═══════════════════════════════════════════════════════════════
      // PRINCIPAL OFFICE
      // ═══════════════════════════════════════════════════════════════
      '{{PRINCIPAL_OFFICE_ADDRESS}}': venture.principalOfficeAddress || '',
      '{{COMPANY_ADDRESS}}': venture.principalOfficeAddress || '',
      
      // ═══════════════════════════════════════════════════════════════
      // SHARE STRUCTURE
      // ═══════════════════════════════════════════════════════════════
      '{{TOTAL_AUTHORIZED_SHARES}}': (venture.totalSharesAuthorized || 0).toLocaleString(),
      '{{COMMON_SHARES_AUTHORIZED}}': (venture.commonSharesAuthorized || 0).toLocaleString(),
      '{{FF_PREFERRED_SHARES_AUTHORIZED}}': (venture.ffPreferredSharesAuthorized || 0).toLocaleString(),
      '{{OPTION_POOL_SHARES}}': (venture.optionPoolShares || 0).toLocaleString(),
      
      // ═══════════════════════════════════════════════════════════════
      // PAR VALUES
      // ═══════════════════════════════════════════════════════════════
      '{{PAR_VALUE}}': '$' + (venture.parValue || 0),
      '{{PAR_VALUE_NUMBER}}': String(venture.parValue || 0),
      '{{FF_PREFERRED_PAR_VALUE}}': '$' + (venture.ffPreferredParValue || 0),
      '{{FF_PREFERRED_PAR_VALUE_NUMBER}}': String(venture.ffPreferredParValue || 0),
      
      // ═══════════════════════════════════════════════════════════════
      // OFFICERS / PEOPLE
      // ═══════════════════════════════════════════════════════════════
      '{{PERSON_NAME}}': venture.incorporatorName || venture.initialDirectorName || '',
      '{{INCORPORATOR_NAME}}': venture.incorporatorName || '',
      '{{INITIAL_DIRECTOR_NAME}}': venture.initialDirectorName || '',
      '{{DIRECTOR_1_NAME}}': venture.initialDirectorName || '',
      '{{PRESIDENT_NAME}}': venture.presidentName || venture.initialDirectorName || '',
      '{{SECRETARY_NAME}}': venture.secretaryName || venture.initialDirectorName || '',
      '{{TREASURER_NAME}}': venture.treasurerName || venture.initialDirectorName || '',
      '{{CEO_NAME}}': venture.presidentName || venture.initialDirectorName || '',
      
      // ═══════════════════════════════════════════════════════════════
      // FOUNDER STOCK PURCHASE
      // ═══════════════════════════════════════════════════════════════
      '{{FOUNDER_ENTITY_NAME}}': venture.founderEntityName || '',
      '{{FOUNDER_NAME}}': venture.founderEntityName || '',
      '{{FOUNDER_COMMON_SHARES}}': (venture.founderCommonShares || 0).toLocaleString(),
      '{{FOUNDER_FF_PREFERRED_SHARES}}': (venture.founderFFPreferredShares || 0).toLocaleString(),
      '{{FOUNDER_COMMON_PURCHASE_PRICE}}': '$' + (venture.founderCommonPurchasePrice || 0).toFixed(2),
      '{{FOUNDER_FF_PREFERRED_PURCHASE_PRICE}}': '$' + (venture.founderFFPreferredPurchasePrice || 0).toFixed(2),
      '{{TOTAL_FOUNDER_PURCHASE_PRICE}}': '$' + totalFounderPurchasePrice.toFixed(2),
      '{{AGGREGATE_PURCHASE_PRICE}}': '$' + (venture.founderCommonPurchasePrice || 0).toFixed(2),
      '{{NUMBER_OF_SHARES}}': (venture.founderCommonShares || 0).toLocaleString(),
      '{{PRICE_PER_SHARE}}': '$' + (venture.parValue || 0),
      '{{DESCRIPTION_OF_GVS_IP_ASSIGNMENT}}': venture.descriptionOfGVSIPAssignment || '',
      
      // ═══════════════════════════════════════════════════════════════
      // EQUITY PLAN
      // ═══════════════════════════════════════════════════════════════
      '{{EQUITY_PLAN_YEAR}}': venture.equityPlanYear || new Date().getFullYear().toString(),
      '{{PLAN_NAME}}': (venture.equityPlanYear || new Date().getFullYear()) + ' Equity Incentive Plan',
      '{{PLAN_EFFECTIVE_DATE}}': venture.foundedDate || '',
      '{{BOARD_APPROVAL_DATE}}': venture.foundedDate || '',
      '{{STOCKHOLDER_APPROVAL_DATE}}': venture.foundedDate || '',
      
      // ═══════════════════════════════════════════════════════════════
      // DATES - These will be filled at document generation time
      // ═══════════════════════════════════════════════════════════════
      '{{EFFECTIVE_DATE}}': venture.foundedDate || '__________________',
      '{{SIGNATURE_DATE}}': '__________________',
      
      // ═══════════════════════════════════════════════════════════════
      // SIGNATURES - Left blank for manual signing
      // ═══════════════════════════════════════════════════════════════
      '{{SIGNATURE}}': '__________________',
      '{{SIGNATORY_NAME}}': venture.incorporatorName || venture.initialDirectorName || '__________________',
      '{{SIGNATORY_TITLE}}': 'Authorized Signatory',
      '{{SIGNATORY_ADDRESS}}': venture.principalOfficeAddress || '__________________',
    };
    
    return { replacements: placeholders, ventureName: legalName };
  };

  /**
   * Analyze selected documents and identify missing fields that should be collected
   * before generating. Returns structured data for the pre-generation modal.
   */
  const getMissingFieldsForGeneration = (venture, options) => {
    const missing = {
      venture: [],      // Venture-level missing fields
      safes: [],        // Per-SAFE missing fields
      employees: [],    // Per-employee missing fields
      advisors: [],     // Per-advisor missing fields
      hasRequired: false,
      hasOptional: false,
    };
    
    const docs = options.docs || {};
    const safes = (venture.fundingRounds || []).filter(f => f.type === 'SAFE');
    const employees = venture.employeeGrants || [];
    const advisors = venture.advisorGrants || [];
    
    // Check venture-level fields for formation documents
    const formationSelected = ['certificateOfIncorporation', 'bylaws', 'actionOfIncorporator', 
      'organizationalResolutions', 'restrictedStockPurchaseAgreement', 'equityIncentivePlan', 
      'equityPlanStockholderConsent'].some(d => docs[d] !== false);
    
    if (formationSelected) {
      // These are nice-to-have for organizational resolutions
      if (!venture.presidentName && !venture.initialDirectorName) {
        missing.venture.push({ field: 'presidentName', label: 'President/CEO Name', required: false, 
          hint: 'For organizational resolutions. Will use Initial Director if blank.' });
      }
      if (!venture.secretaryName && !venture.initialDirectorName) {
        missing.venture.push({ field: 'secretaryName', label: 'Secretary Name', required: false,
          hint: 'For organizational resolutions. Will use Initial Director if blank.' });
      }
      if (!venture.treasurerName && !venture.initialDirectorName) {
        missing.venture.push({ field: 'treasurerName', label: 'Treasurer/CFO Name', required: false,
          hint: 'For organizational resolutions. Will use Initial Director if blank.' });
      }
    }
    
    // Check for Formation RSPA (Restricted Stock Purchase Agreement) specific fields
    if (docs.restrictedStockPurchaseAgreement !== false) {
      if (!venture.descriptionOfGVSIPAssignment) {
        missing.venture.push({ 
          field: 'descriptionOfGVSIPAssignment', 
          label: 'Description of GVS IP Assignment (Formation RSPA)', 
          required: true,
          hint: 'For "Restricted Stock Purchase Agreement" - Describe the IP being assigned by GVS Founders to the company (e.g., "All software, designs, documentation, and intellectual property related to the [Project Name] platform")'
        });
      }
    }
    
    // Check individual SAFE documents
    if (options.individualSafes !== false && safes.length > 0) {
      safes.forEach((safe, idx) => {
        const safeMissing = { index: idx, name: safe.investorName || `SAFE ${idx + 1}`, fields: [] };
        
        if (!safe.investorAddress) {
          safeMissing.fields.push({ field: 'investorAddress', label: 'Investor Address', required: false,
            hint: 'Mailing address for signature block' });
        }
        if (!safe.investorEmail) {
          safeMissing.fields.push({ field: 'investorEmail', label: 'Investor Email', required: false,
            hint: 'For notices section' });
        }
        if (!safe.investorJurisdiction) {
          safeMissing.fields.push({ field: 'investorJurisdiction', label: 'Investor Jurisdiction', required: false,
            hint: 'State/Country of investor (e.g., Delaware, California)' });
        }
        
        if (safeMissing.fields.length > 0) {
          missing.safes.push(safeMissing);
        }
      });
    }
    
    // Check individual employee option documents
    if (options.individualOptions !== false && employees.length > 0) {
      employees.forEach((emp, idx) => {
        const empMissing = { index: idx, name: emp.employeeName || `Employee ${idx + 1}`, fields: [] };
        
        if (!emp.employeeTitle) {
          empMissing.fields.push({ field: 'employeeTitle', label: 'Job Title', required: false,
            hint: 'Employee\'s job title (e.g., "Software Engineer")' });
        }
        if (!emp.employeeAddress) {
          empMissing.fields.push({ field: 'employeeAddress', label: 'Employee Address', required: false,
            hint: 'Home address for agreement' });
        }
        if (!emp.employeeEmail) {
          empMissing.fields.push({ field: 'employeeEmail', label: 'Employee Email', required: false,
            hint: 'For notices section' });
        }
        if (!emp.vestingStartDate) {
          empMissing.fields.push({ field: 'vestingStartDate', label: 'Vesting Start Date', required: false,
            hint: 'Usually same as grant date. Leave blank to use grant date.' });
        }
        
        if (empMissing.fields.length > 0) {
          missing.employees.push(empMissing);
        }
      });
    }
    
    // Check individual advisor/consultant documents
    if (options.individualAdvisors !== false && advisors.length > 0) {
      advisors.forEach((adv, idx) => {
        const advMissing = { index: idx, name: adv.advisorName || `Advisor ${idx + 1}`, fields: [], agreementType: adv.agreementType };
        
        // Common fields for all advisor types
        if (!adv.advisorTitle) {
          advMissing.fields.push({ field: 'advisorTitle', label: 'Title/Role', required: false,
            hint: 'Title for signature block (e.g., "Advisor", "Consultant")' });
        }
        if (!adv.advisorAddress) {
          advMissing.fields.push({ field: 'advisorAddress', label: 'Address', required: false,
            hint: 'Mailing address for signature block' });
        }
        if (!adv.advisorEmail) {
          advMissing.fields.push({ field: 'advisorEmail', label: 'Email', required: false,
            hint: 'For notices section' });
        }
        
        // Consulting agreement specific fields
        if (adv.agreementType === 'consulting') {
          if (!adv.monthlyHours) {
            advMissing.fields.push({ field: 'monthlyHours', label: 'Monthly Hours', required: true,
              hint: 'Expected hours per month (e.g., "10-20")' });
          }
          if (!adv.consultingFee && !adv.hourlyRate) {
            advMissing.fields.push({ field: 'consultingFee', label: 'Monthly Fee OR', required: false,
              hint: 'Fixed monthly consulting fee' });
            advMissing.fields.push({ field: 'hourlyRate', label: 'Hourly Rate', required: false,
              hint: 'Hourly rate if not fixed fee' });
          }
          if (!adv.scopeOfWork) {
            advMissing.fields.push({ field: 'scopeOfWork', label: 'Scope of Work', required: true,
              hint: 'Description of consulting services' });
          }
        }
        
        // Advisor agreement specific fields  
        if (adv.agreementType === 'advisor') {
          if (!adv.monthlyHours) {
            advMissing.fields.push({ field: 'monthlyHours', label: 'Monthly Hours', required: false,
              hint: 'Expected availability (e.g., "5-10")' });
          }
          if (!adv.areaOfExpertise) {
            advMissing.fields.push({ field: 'areaOfExpertise', label: 'Area of Expertise', required: false,
              hint: 'Advisor\'s specialty (e.g., "Go-to-market strategy")' });
          }
          if (!adv.servicesDescription) {
            advMissing.fields.push({ field: 'servicesDescription', label: 'Services Description', required: false,
              hint: 'Brief description of advisory services' });
          }
        }
        
        // IP Stock Purchase agreement specific fields
        if (adv.agreementType === 'ipStockPurchase') {
          if (!adv.projectName) {
            advMissing.fields.push({ field: 'projectName', label: 'Project/Product Name', required: true,
              hint: 'Name of the project or product being assigned (e.g., "Salesflow AI")' });
          }
          if (!adv.descriptionOfAdvisorIPAssignment) {
            advMissing.fields.push({ 
              field: 'descriptionOfAdvisorIPAssignment', 
              label: 'Description of Advisor IP Assignment (Advisor RSPA)', 
              required: true,
              hint: 'For "Restricted Stock Purchase Agreement (IP Assignment)" - Describe the IP this advisor is assigning to the company'
            });
          }
          if (!adv.githubRepos) {
            advMissing.fields.push({ field: 'githubRepos', label: 'GitHub Repositories', required: false,
              hint: 'GitHub repos to transfer (e.g., "org/repo-name")' });
          }
          if (!adv.domainNames) {
            advMissing.fields.push({ field: 'domainNames', label: 'Domain Names', required: false,
              hint: 'Domain names to transfer (e.g., "example.com, app.example.com")' });
          }
          if (!adv.wordMarks) {
            advMissing.fields.push({ field: 'wordMarks', label: 'Word Marks / Brand Names', required: false,
              hint: 'Brand/product names to transfer (e.g., "Acme, AcmeFlow")' });
          }
          if (!adv.socialAccounts) {
            advMissing.fields.push({ field: 'socialAccounts', label: 'Social Media Accounts', required: false,
              hint: 'Social media handles to transfer (e.g., "@projecthandle")' });
          }
        }
        
        if (advMissing.fields.length > 0) {
          missing.advisors.push(advMissing);
        }
      });
    }
    
    // Determine if we have any missing fields
    missing.hasRequired = missing.advisors.some(a => a.fields.some(f => f.required));
    missing.hasOptional = missing.venture.length > 0 || missing.safes.length > 0 || 
      missing.employees.length > 0 || missing.advisors.length > 0;
    
    return missing;
  };

  const generateAppsScript = (venture, options = {}) => {
    const m = generateFieldMappings(venture);
    const r = m.replacements;
    const name = venture.legalName || '';
    
    // Get individual document selections (default all true for backwards compatibility)
    const docs = options.docs || {};
    
    // Compute category flags from individual document selections
    const formationDocs = ['certificateOfIncorporation', 'bylaws', 'actionOfIncorporator', 'organizationalResolutions', 'restrictedStockPurchaseAgreement', 'equityIncentivePlan', 'equityPlanStockholderConsent'];
    const safeDocs = ['safeMFN', 'safeValuationCap'];
    const equityDocs = ['immediatelyExercisableOption', 'nonImmediatelyExercisableOption'];
    const employmentDocs = ['offerLetter', 'advisorAgreement'];
    
    const generateFormation = formationDocs.some(d => docs[d] !== false);
    const generateSafeTemplates = safeDocs.some(d => docs[d] !== false);
    const generateEquityPlan = equityDocs.some(d => docs[d] !== false);
    const generateEmployment = employmentDocs.some(d => docs[d] !== false);
    const generateIndividualSafes = options.individualSafes !== false;
    const generateIndividualOptions = options.individualOptions !== false;
    const generateIndividualAdvisors = options.individualAdvisors !== false;
    const overwriteExisting = options.overwrite === true;
    
    // Prepare arrays for individual documents
    const safes = (venture.fundingRounds || []).filter(f => f.type === 'SAFE');
    const pricedRounds = (venture.fundingRounds || []).filter(f => f.type === 'Priced Round');
    const employees = venture.employeeGrants || [];
    const advisors = venture.advisorGrants || [];
    
    // Count selected documents
    const selectedFormationDocs = formationDocs.filter(d => docs[d] !== false);
    const selectedSafeDocs = safeDocs.filter(d => docs[d] !== false);
    const selectedEquityDocs = equityDocs.filter(d => docs[d] !== false);
    const selectedEmploymentDocs = employmentDocs.filter(d => docs[d] !== false);
    
    let script = '/**\n';
    script += ' * AUTO-GENERATED SCRIPT FOR: ' + name + '\n';
    script += ' * \n';
    script += ' * DOCUMENTS TO GENERATE:\n';
    if (selectedFormationDocs.length > 0) script += ' * ✓ Formation Documents (' + selectedFormationDocs.length + ')\n';
    if (selectedSafeDocs.length > 0) script += ' * ✓ SAFE Agreement Templates (' + selectedSafeDocs.length + ')\n';
    if (selectedEquityDocs.length > 0) script += ' * ✓ Equity Plan Forms (' + selectedEquityDocs.length + ')\n';
    if (selectedEmploymentDocs.length > 0) script += ' * ✓ Employment & Advisor Agreement Templates (' + selectedEmploymentDocs.length + ')\n';
    if (generateIndividualSafes && safes.length > 0) script += ' * ✓ Individual SAFE Agreements (' + safes.length + ')\n';
    if (generateIndividualOptions && employees.length > 0) script += ' * ✓ Individual Option Agreements (' + employees.length + ')\n';
    if (generateIndividualAdvisors && advisors.length > 0) script += ' * ✓ Individual Advisor Agreements (' + advisors.length + ')\n';
    script += ' * \n';
    script += ' * OVERWRITE MODE: ' + (overwriteExisting ? 'ON - Will update existing documents' : 'OFF - Will skip existing documents') + '\n';
    script += ' */\n\n';
    script += 'var VENTURE_NAME = "' + name + '";\n';
    script += 'var VENTURES_FOLDER_ID = "1wq9rS06o9_tPkFWHnVIJn1wJ6JFuMHSR";\n';
    script += 'var OVERWRITE_EXISTING = ' + (overwriteExisting ? 'true' : 'false') + ';\n\n';
    
    // Document category flags
    script += '// Document Categories to Generate\n';
    script += 'var GENERATE = {\n';
    script += '  formation: ' + generateFormation + ',\n';
    script += '  safeTemplates: ' + generateSafeTemplates + ',\n';
    script += '  equityPlan: ' + generateEquityPlan + ',\n';
    script += '  employment: ' + generateEmployment + ',\n';
    script += '  individualSafes: ' + generateIndividualSafes + ',\n';
    script += '  individualOptions: ' + generateIndividualOptions + ',\n';
    script += '  individualAdvisors: ' + generateIndividualAdvisors + '\n';
    script += '};\n\n';
    
    // Individual document selections
    script += '// Individual Document Selections\n';
    script += 'var DOCS = {\n';
    script += '  // Formation Documents\n';
    script += '  certificateOfIncorporation: ' + (docs.certificateOfIncorporation !== false) + ',\n';
    script += '  bylaws: ' + (docs.bylaws !== false) + ',\n';
    script += '  actionOfIncorporator: ' + (docs.actionOfIncorporator !== false) + ',\n';
    script += '  organizationalResolutions: ' + (docs.organizationalResolutions !== false) + ',\n';
    script += '  restrictedStockPurchaseAgreement: ' + (docs.restrictedStockPurchaseAgreement !== false) + ',\n';
    script += '  equityIncentivePlan: ' + (docs.equityIncentivePlan !== false) + ',\n';
    script += '  equityPlanStockholderConsent: ' + (docs.equityPlanStockholderConsent !== false) + ',\n';
    script += '  // SAFE Templates\n';
    script += '  safeMFN: ' + (docs.safeMFN !== false) + ',\n';
    script += '  safeValuationCap: ' + (docs.safeValuationCap !== false) + ',\n';
    script += '  // Equity Plan Forms\n';
    script += '  immediatelyExercisableOption: ' + (docs.immediatelyExercisableOption !== false) + ',\n';
    script += '  nonImmediatelyExercisableOption: ' + (docs.nonImmediatelyExercisableOption !== false) + ',\n';
    script += '  // Employment & Advisor\n';
    script += '  offerLetter: ' + (docs.offerLetter !== false) + ',\n';
    script += '  advisorAgreement: ' + (docs.advisorAgreement !== false) + ',\n';
    script += '  consultingAgreement: ' + (docs.consultingAgreement !== false) + ',\n';
    script += '  ipStockPurchaseAgreement: ' + (docs.ipStockPurchaseAgreement !== false) + '\n';
    script += '};\n\n';
    
    script += 'var TEMPLATE_SUBFOLDERS = {\n';
    script += '  "Template - Formation Documents": {\n';
    script += '    id: "1QQtXw2sCspt9OHi_KfU3T7J0Ivx3umC3",\n';
    script += '    newName: "' + name + ' - Formation Documents",\n';
    script += '    category: "formation"\n';
    script += '  },\n';
    script += '  "SAFE Templates": {\n';
    script += '    id: "1eQUtGRD4b5mJTUZ3EnpW7e00o1MdATs_",\n';
    script += '    newName: "' + name + ' - SAFE Agreements",\n';
    script += '    category: "safeTemplates"\n';
    script += '  },\n';
    script += '  "Template - Equity Plan Forms": {\n';
    script += '    id: "1pHGO3-fjw0GLnheDdIP53q_b2dLu2tec",\n';
    script += '    newName: "' + name + ' - Equity Plan Forms",\n';
    script += '    category: "equityPlan"\n';
    script += '  },\n';
    script += '  "Employment, Advisor and Consultant Agreements": {\n';
    script += '    id: "1U-gfwcc3UQL9TzJ1gKb563N5xfkLoSsv",\n';
    script += '    newName: "' + name + ' - Employment and Advisor Agreements",\n';
    script += '    category: "employment"\n';
    script += '  }\n';
    script += '};\n\n';
    
    // Placeholder-based field replacements using {{PLACEHOLDER}} syntax
    script += '// ═══════════════════════════════════════════════════════════════\n';
    script += '// PLACEHOLDER REPLACEMENTS - Maps {{PLACEHOLDER}} to actual values\n';
    script += '// ═══════════════════════════════════════════════════════════════\n';
    script += 'var FIELD_REPLACEMENTS = {\n';
    script += '  // Company Information\n';
    script += '  "{{COMPANY_NAME}}": "' + (r['{{COMPANY_NAME}}'] || '') + '",\n';
    script += '  "{{COMPANY_SHORT_NAME}}": "' + (r['{{COMPANY_SHORT_NAME}}'] || '') + '",\n';
    script += '  "{{STATE_OF_INCORPORATION}}": "' + (r['{{STATE_OF_INCORPORATION}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Registered Agent\n';
    script += '  "{{REGISTERED_AGENT_NAME}}": "' + (r['{{REGISTERED_AGENT_NAME}}'] || '') + '",\n';
    script += '  "{{REGISTERED_AGENT_ADDRESS}}": "' + (r['{{REGISTERED_AGENT_ADDRESS}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Principal Office\n';
    script += '  "{{PRINCIPAL_OFFICE_ADDRESS}}": "' + (r['{{PRINCIPAL_OFFICE_ADDRESS}}'] || '') + '",\n';
    script += '  "{{COMPANY_ADDRESS}}": "' + (r['{{COMPANY_ADDRESS}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Share Structure\n';
    script += '  "{{TOTAL_AUTHORIZED_SHARES}}": "' + (r['{{TOTAL_AUTHORIZED_SHARES}}'] || '') + '",\n';
    script += '  "{{COMMON_SHARES_AUTHORIZED}}": "' + (r['{{COMMON_SHARES_AUTHORIZED}}'] || '') + '",\n';
    script += '  "{{FF_PREFERRED_SHARES_AUTHORIZED}}": "' + (r['{{FF_PREFERRED_SHARES_AUTHORIZED}}'] || '') + '",\n';
    script += '  "{{OPTION_POOL_SHARES}}": "' + (r['{{OPTION_POOL_SHARES}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Par Values\n';
    script += '  "{{PAR_VALUE}}": "' + (r['{{PAR_VALUE}}'] || '') + '",\n';
    script += '  "{{PAR_VALUE_NUMBER}}": "' + (r['{{PAR_VALUE_NUMBER}}'] || '') + '",\n';
    script += '  "{{FF_PREFERRED_PAR_VALUE}}": "' + (r['{{FF_PREFERRED_PAR_VALUE}}'] || '') + '",\n';
    script += '  "{{FF_PREFERRED_PAR_VALUE_NUMBER}}": "' + (r['{{FF_PREFERRED_PAR_VALUE_NUMBER}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Officers / People\n';
    script += '  "{{PERSON_NAME}}": "' + (r['{{PERSON_NAME}}'] || '') + '",\n';
    script += '  "{{INCORPORATOR_NAME}}": "' + (r['{{INCORPORATOR_NAME}}'] || '') + '",\n';
    script += '  "{{INITIAL_DIRECTOR_NAME}}": "' + (r['{{INITIAL_DIRECTOR_NAME}}'] || '') + '",\n';
    script += '  "{{DIRECTOR_1_NAME}}": "' + (r['{{DIRECTOR_1_NAME}}'] || '') + '",\n';
    script += '  "{{PRESIDENT_NAME}}": "' + (r['{{PRESIDENT_NAME}}'] || '') + '",\n';
    script += '  "{{SECRETARY_NAME}}": "' + (r['{{SECRETARY_NAME}}'] || '') + '",\n';
    script += '  "{{TREASURER_NAME}}": "' + (r['{{TREASURER_NAME}}'] || '') + '",\n';
    script += '  "{{CEO_NAME}}": "' + (r['{{CEO_NAME}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Founder Stock Purchase\n';
    script += '  "{{FOUNDER_ENTITY_NAME}}": "' + (r['{{FOUNDER_ENTITY_NAME}}'] || '') + '",\n';
    script += '  "{{FOUNDER_NAME}}": "' + (r['{{FOUNDER_NAME}}'] || '') + '",\n';
    script += '  "{{FOUNDER_COMMON_SHARES}}": "' + (r['{{FOUNDER_COMMON_SHARES}}'] || '') + '",\n';
    script += '  "{{FOUNDER_FF_PREFERRED_SHARES}}": "' + (r['{{FOUNDER_FF_PREFERRED_SHARES}}'] || '') + '",\n';
    script += '  "{{FOUNDER_COMMON_PURCHASE_PRICE}}": "' + (r['{{FOUNDER_COMMON_PURCHASE_PRICE}}'] || '') + '",\n';
    script += '  "{{FOUNDER_FF_PREFERRED_PURCHASE_PRICE}}": "' + (r['{{FOUNDER_FF_PREFERRED_PURCHASE_PRICE}}'] || '') + '",\n';
    script += '  "{{TOTAL_FOUNDER_PURCHASE_PRICE}}": "' + (r['{{TOTAL_FOUNDER_PURCHASE_PRICE}}'] || '') + '",\n';
    script += '  "{{AGGREGATE_PURCHASE_PRICE}}": "' + (r['{{AGGREGATE_PURCHASE_PRICE}}'] || '') + '",\n';
    script += '  "{{NUMBER_OF_SHARES}}": "' + (r['{{NUMBER_OF_SHARES}}'] || '') + '",\n';
    script += '  "{{PRICE_PER_SHARE}}": "' + (r['{{PRICE_PER_SHARE}}'] || '') + '",\n';
    script += '  "{{DESCRIPTION_OF_GVS_IP_ASSIGNMENT}}": "' + (r['{{DESCRIPTION_OF_GVS_IP_ASSIGNMENT}}'] || '').replace(/"/g, '\\"').replace(/\n/g, '\\n') + '",\n';
    script += '  \n';
    script += '  // Equity Plan\n';
    script += '  "{{EQUITY_PLAN_YEAR}}": "' + (r['{{EQUITY_PLAN_YEAR}}'] || '') + '",\n';
    script += '  "{{PLAN_NAME}}": "' + (r['{{PLAN_NAME}}'] || '') + '",\n';
    script += '  "{{PLAN_EFFECTIVE_DATE}}": "' + (r['{{PLAN_EFFECTIVE_DATE}}'] || '') + '",\n';
    script += '  "{{BOARD_APPROVAL_DATE}}": "' + (r['{{BOARD_APPROVAL_DATE}}'] || '') + '",\n';
    script += '  "{{STOCKHOLDER_APPROVAL_DATE}}": "' + (r['{{STOCKHOLDER_APPROVAL_DATE}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Dates\n';
    script += '  "{{EFFECTIVE_DATE}}": "' + (r['{{EFFECTIVE_DATE}}'] || '') + '",\n';
    script += '  "{{SIGNATURE_DATE}}": "' + (r['{{SIGNATURE_DATE}}'] || '') + '",\n';
    script += '  \n';
    script += '  // Signatures\n';
    script += '  "{{SIGNATURE}}": "' + (r['{{SIGNATURE}}'] || '') + '",\n';
    script += '  "{{SIGNATORY_NAME}}": "' + (r['{{SIGNATORY_NAME}}'] || '') + '",\n';
    script += '  "{{SIGNATORY_TITLE}}": "' + (r['{{SIGNATORY_TITLE}}'] || '') + '",\n';
    script += '  "{{SIGNATORY_ADDRESS}}": "' + (r['{{SIGNATORY_ADDRESS}}'] || '') + '"\n';
    script += '};\n\n';
    
    // Additional venture data for reference
    script += '// Additional Venture Data\n';
    script += 'var VENTURE_DATA = {\n';
    script += '  legalName: "' + (venture.legalName || '') + '",\n';
    script += '  state: "' + (venture.state || 'Delaware') + '",\n';
    script += '  incorporatorName: "' + (venture.incorporatorName || '') + '",\n';
    script += '  initialDirectorName: "' + (venture.initialDirectorName || '') + '",\n';
    script += '  principalOfficeAddress: "' + (venture.principalOfficeAddress || '') + '",\n';
    script += '  registeredAgent: "' + (venture.registeredAgent || '') + '",\n';
    script += '  registeredAgentAddress: "' + (venture.registeredAgentAddress || '') + '",\n';
    script += '  totalSharesAuthorized: ' + (venture.totalSharesAuthorized || 0) + ',\n';
    script += '  commonSharesAuthorized: ' + (venture.commonSharesAuthorized || 0) + ',\n';
    script += '  ffPreferredSharesAuthorized: ' + (venture.ffPreferredSharesAuthorized || 0) + ',\n';
    script += '  parValue: ' + (venture.parValue || 0) + ',\n';
    script += '  ffPreferredParValue: ' + (venture.ffPreferredParValue || 0) + ',\n';
    script += '  founderEntityName: "' + (venture.founderEntityName || '') + '",\n';
    script += '  founderCommonShares: ' + (venture.founderCommonShares || 0) + ',\n';
    script += '  founderCommonPurchasePrice: ' + (venture.founderCommonPurchasePrice || 0) + ',\n';
    script += '  founderFFPreferredShares: ' + (venture.founderFFPreferredShares || 0) + ',\n';
    script += '  founderFFPreferredPurchasePrice: ' + (venture.founderFFPreferredPurchasePrice || 0) + ',\n';
    script += '  descriptionOfGVSIPAssignment: "' + (venture.descriptionOfGVSIPAssignment || '').replace(/"/g, '\\"').replace(/\n/g, '\\n') + '",\n';
    script += '  equityPlanYear: "' + (venture.equityPlanYear || '') + '",\n';
    script += '  optionPoolShares: ' + (venture.optionPoolShares || 0) + '\n';
    script += '};\n\n';
    
    // SAFE investor data
    if (safes.length > 0) {
      script += '// SAFE Investors\n';
      script += 'var SAFE_INVESTORS = [\n';
      safes.forEach((safe, i) => {
        const docName = safe.safeTemplate === 'mfn' 
          ? 'Post-Money SAFE (MFN) - ' + (safe.investorName || '')
          : 'Post-Money SAFE (Valuation Cap) - ' + (safe.investorName || '');
        script += '  {\n';
        script += '    documentName: "' + docName + '",\n';
        script += '    investorName: "' + (safe.investorName || '') + '",\n';
        script += '    date: "' + (safe.date || '') + '",\n';
        script += '    amount: "' + (safe.amount || 0).toLocaleString() + '",\n';
        script += '    amountWords: "' + numberToWords(safe.amount || 0) + '",\n';
        script += '    valuationCap: "' + (safe.valuationCap || 0).toLocaleString() + '",\n';
        script += '    valuationCapWords: "' + numberToWords(safe.valuationCap || 0) + '",\n';
        script += '    discount: "' + (safe.discount || 0) + '",\n';
        script += '    safeTemplate: "' + (safe.safeTemplate || 'valuationCap') + '",\n';
        // Additional fields for document generation
        script += '    address: "' + (safe.investorAddress || '') + '",\n';
        script += '    email: "' + (safe.investorEmail || '') + '",\n';
        script += '    jurisdiction: "' + (safe.investorJurisdiction || '') + '"\n';
        script += '  }' + (i < safes.length - 1 ? ',' : '') + '\n';
      });
      script += '];\n\n';
    }
    
    // Employee grant data
    if (employees.length > 0) {
      script += '// Employee Grants\n';
      script += 'var EMPLOYEE_GRANTS = [\n';
      employees.forEach((emp, i) => {
        const docName = emp.optionAgreementType === 'earlyExercise'
          ? 'Early Exercise Stock Option Agreement (' + (emp.grantType || 'ISO') + ') - ' + (emp.employeeName || '')
          : 'Stock Option Agreement (' + (emp.grantType || 'ISO') + ') - ' + (emp.employeeName || '');
        script += '  {\n';
        script += '    documentName: "' + docName + '",\n';
        script += '    employeeName: "' + (emp.employeeName || '') + '",\n';
        script += '    employeeTitle: "' + (emp.employeeTitle || '') + '",\n';
        script += '    grantDate: "' + (emp.grantDate || '') + '",\n';
        script += '    shares: "' + (emp.shares || 0).toLocaleString() + '",\n';
        script += '    sharesWords: "' + numberToWords(emp.shares || 0) + '",\n';
        script += '    exercisePrice: "' + (emp.exercisePrice || 0).toFixed(4) + '",\n';
        script += '    vestingSchedule: "' + (emp.vestingSchedule || '') + '",\n';
        script += '    grantType: "' + (emp.grantType || 'ISO') + '",\n';
        script += '    optionAgreementType: "' + (emp.optionAgreementType || 'standard') + '",\n';
        // Additional fields for document generation
        script += '    address: "' + (emp.employeeAddress || '') + '",\n';
        script += '    email: "' + (emp.employeeEmail || '') + '",\n';
        script += '    vestingStartDate: "' + (emp.vestingStartDate || emp.grantDate || '') + '"\n';
        script += '  }' + (i < employees.length - 1 ? ',' : '') + '\n';
      });
      script += '];\n\n';
    }
    
    // Advisor grant data
    if (advisors.length > 0) {
      script += '// Advisor/Consultant Grants\n';
      script += 'var ADVISOR_GRANTS = [\n';
      advisors.forEach((adv, i) => {
        let docName;
        if (adv.agreementType === 'consulting') {
          docName = 'Consulting Agreement - ' + (adv.advisorName || '');
        } else if (adv.agreementType === 'ipStockPurchase') {
          docName = 'Restricted Stock Purchase Agreement (IP Assignment) - ' + (adv.advisorName || '');
        } else {
          docName = 'Advisor Agreement - ' + (adv.advisorName || '');
        }
        script += '  {\n';
        script += '    documentName: "' + docName + '",\n';
        script += '    advisorName: "' + (adv.advisorName || '') + '",\n';
        script += '    advisorTitle: "' + (adv.advisorTitle || '') + '",\n';
        script += '    grantDate: "' + (adv.grantDate || '') + '",\n';
        script += '    shares: "' + (adv.shares || 0).toLocaleString() + '",\n';
        script += '    sharesWords: "' + numberToWords(adv.shares || 0) + '",\n';
        script += '    exercisePrice: "' + (adv.exercisePrice || 0).toFixed(4) + '",\n';
        script += '    vestingSchedule: "' + (adv.vestingSchedule || '') + '",\n';
        script += '    agreementType: "' + (adv.agreementType || 'advisor') + '",\n';
        // Additional fields for document generation
        script += '    address: "' + (adv.advisorAddress || '') + '",\n';
        script += '    email: "' + (adv.advisorEmail || '') + '",\n';
        script += '    monthlyHours: "' + (adv.monthlyHours || '') + '",\n';
        script += '    consultingFee: "' + (adv.consultingFee || '') + '",\n';
        script += '    hourlyRate: "' + (adv.hourlyRate || '') + '",\n';
        script += '    servicesDescription: "' + (adv.servicesDescription || '') + '",\n';
        script += '    scopeOfWork: "' + (adv.scopeOfWork || '').replace(/"/g, '\\"').replace(/\n/g, '\\n') + '",\n';
        script += '    areaOfExpertise: "' + (adv.areaOfExpertise || '') + '",\n';
        // IP Stock Purchase specific fields
        script += '    projectName: "' + (adv.projectName || '') + '",\n';
        script += '    descriptionOfAdvisorIPAssignment: "' + (adv.descriptionOfAdvisorIPAssignment || '').replace(/"/g, '\\"').replace(/\n/g, '\\n') + '",\n';
        script += '    domainNames: "' + (adv.domainNames || '') + '",\n';
        script += '    githubRepos: "' + (adv.githubRepos || '') + '",\n';
        script += '    socialAccounts: "' + (adv.socialAccounts || '') + '",\n';
        script += '    wordMarks: "' + (adv.wordMarks || '') + '"\n';
        script += '  }' + (i < advisors.length - 1 ? ',' : '') + '\n';
      });
      script += '];\n\n';
    }
    
    // Template document IDs for individual documents
    script += '// Template Document IDs for individual SAFE, Option, and Advisor documents\n';
    script += 'var TEMPLATE_DOCS = {\n';
    script += '  // SAFE Templates\n';
    script += '  safeValuationCap: "1JsJ9jp6wlfHvIm8E5oCDHvkpSbE5VpNVQoscPxhxCHo",\n';
    script += '  safeMFN: "1qCiwnJ322P2tb82yEfctVrrHKcov8vG42DmHvpW9E4I",\n';
    script += '  // Standard Option Agreements (exercise after vesting)\n';
    script += '  optionStandardISO: "1x89Y2Mg-iTaR_U-JCXlhkqINj4ROitzjTbf-iwsE9u8",\n';
    script += '  optionStandardNSO: "1x89Y2Mg-iTaR_U-JCXlhkqINj4ROitzjTbf-iwsE9u8",\n';
    script += '  // Early Exercise Option Agreements (83(b) eligible)\n';
    script += '  optionEarlyExerciseISO: "1D5aRWWMPwhs4GquFPgUAik0Bebg7W8MZYlK4XAg0948",\n';
    script += '  optionEarlyExerciseNSO: "1D5aRWWMPwhs4GquFPgUAik0Bebg7W8MZYlK4XAg0948",\n';
    script += '  // Exercise Agreements (forms to exercise options)\n';
    script += '  exerciseAgreementStandard: "1zaqiAzxxmnZSYX4orFXeq9PZIDdSao4VXDo0PHWEPsY",\n';
    script += '  exerciseAgreementEarly: "1rKgEDNeHHfMO_RR53FF3qN1DFpBchA_SQwWOmfKADZ0",\n';
    script += '  // Equity Plan Forms\n';
    script += '  equityPlanRSPA: "16RLxihUti_lFmqNU90S0vNHGv2RryENnBBeifAXO7og",\n';
    script += '  // Advisor/Consultant Templates\n';
    script += '  advisorAgreement: "1og2bZfpgSnZkpHStlqd5WkcJRk1Uxbz2OUJqX-d56sc",\n';
    script += '  consultingAgreement: "1TGfltvdYuDCk6_nuLWPW4C9LUbfEq-U0xHv7DjYpMHE",\n';
    script += '  corporateConsultingAgreement: "1cmIuwP4MG-QznfMz_h7Hb_tB-Z7crYa6mMN-Skz4VAk",\n';
    script += '  ipStockPurchaseAgreement: "1dLNVsW2MukPDwYVGmgPNg8426ugo6bHUMnYHUbdDcxs",\n';
    script += '  // Employment Templates\n';
    script += '  offerLetter: "1p8nuSZRX5PmOJuuEcm19IK6LzmScukt5LFFgDEgOgPY",\n';
    script += '  eiaca: "16AUnfBuYHU6L5vR4uID1kvL3UiZ6yhsQL92eCTon3_M"\n';
    script += '};\n\n';
    
    // Debug function to test access
    script += '// ==========================================\n';
    script += '// DEBUG FUNCTION - Run this first to test access\n';
    script += '// ==========================================\n';
    script += 'function testFolderAccess() {\n';
    script += '  Logger.log("=== TESTING FOLDER & TEMPLATE ACCESS ===");\n';
    script += '  Logger.log("");\n';
    script += '  var errors = 0;\n';
    script += '  \n';
    script += '  // Test VENTURES folder\n';
    script += '  Logger.log("1. Testing VENTURES folder...");\n';
    script += '  try {\n';
    script += '    var venturesFolder = DriveApp.getFolderById(VENTURES_FOLDER_ID);\n';
    script += '    Logger.log("   ✓ VENTURES folder: " + venturesFolder.getName());\n';
    script += '    Logger.log("     URL: " + venturesFolder.getUrl());\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("   ✗ VENTURES folder FAILED: " + e.message);\n';
    script += '    Logger.log("     ID: " + VENTURES_FOLDER_ID);\n';
    script += '    errors++;\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Test template subfolders\n';
    script += '  Logger.log("");\n';
    script += '  Logger.log("2. Testing TEMPLATE subfolders...");\n';
    script += '  var subNames = Object.keys(TEMPLATE_SUBFOLDERS);\n';
    script += '  for (var i = 0; i < subNames.length; i++) {\n';
    script += '    var subName = subNames[i];\n';
    script += '    var subId = TEMPLATE_SUBFOLDERS[subName].id;\n';
    script += '    try {\n';
    script += '      var folder = DriveApp.getFolderById(subId);\n';
    script += '      var fileCount = 0;\n';
    script += '      var files = folder.getFiles();\n';
    script += '      while (files.hasNext()) { files.next(); fileCount++; }\n';
    script += '      Logger.log("   ✓ " + subName + " (" + fileCount + " files)");\n';
    script += '    } catch (e) {\n';
    script += '      Logger.log("   ✗ " + subName + " FAILED: " + e.message);\n';
    script += '      Logger.log("     ID: " + subId);\n';
    script += '      errors++;\n';
    script += '    }\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Test individual document templates\n';
    script += '  Logger.log("");\n';
    script += '  Logger.log("3. Testing individual document templates...");\n';
    script += '  var templates = {\n';
    script += '    "SAFE Valuation Cap": TEMPLATE_DOCS.safeValuationCap,\n';
    script += '    "SAFE MFN": TEMPLATE_DOCS.safeMFN,\n';
    script += '    "Option Standard ISO": TEMPLATE_DOCS.optionStandardISO,\n';
    script += '    "Option Early Exercise ISO": TEMPLATE_DOCS.optionEarlyExerciseISO,\n';
    script += '    "Exercise Agreement (Standard)": TEMPLATE_DOCS.exerciseAgreementStandard,\n';
    script += '    "Exercise Agreement (Early)": TEMPLATE_DOCS.exerciseAgreementEarly,\n';
    script += '    "Equity Plan RSPA": TEMPLATE_DOCS.equityPlanRSPA,\n';
    script += '    "Advisor Agreement": TEMPLATE_DOCS.advisorAgreement,\n';
    script += '    "Consulting Agreement (Individual)": TEMPLATE_DOCS.consultingAgreement,\n';
    script += '    "Consulting Agreement (Corporate)": TEMPLATE_DOCS.corporateConsultingAgreement,\n';
    script += '    "IP Stock Purchase": TEMPLATE_DOCS.ipStockPurchaseAgreement,\n';
    script += '    "Offer Letter": TEMPLATE_DOCS.offerLetter,\n';
    script += '    "EIACA": TEMPLATE_DOCS.eiaca\n';
    script += '  };\n';
    script += '  for (var name in templates) {\n';
    script += '    var id = templates[name];\n';
    script += '    if (id.indexOf("YOUR_") === 0) {\n';
    script += '      Logger.log("   ⚠ " + name + ": Not configured (placeholder ID)");\n';
    script += '      continue;\n';
    script += '    }\n';
    script += '    try {\n';
    script += '      var file = DriveApp.getFileById(id);\n';
    script += '      Logger.log("   ✓ " + name + ": " + file.getName());\n';
    script += '    } catch (e) {\n';
    script += '      Logger.log("   ✗ " + name + " FAILED: " + e.message);\n';
    script += '      Logger.log("     ID: " + id);\n';
    script += '      errors++;\n';
    script += '    }\n';
    script += '  }\n';
    script += '  \n';
    script += '  Logger.log("");\n';
    script += '  Logger.log("=== TEST COMPLETE ===");\n';
    script += '  if (errors === 0) {\n';
    script += '    Logger.log("All tests passed! You can now run createVentureDocuments().");\n';
    script += '  } else {\n';
    script += '    Logger.log("Found " + errors + " error(s). Please fix access issues before running.");\n';
    script += '    Logger.log("Make sure your Google account has Editor access to all folders and files.");\n';
    script += '  }\n';
    script += '}\n\n';
    
    // Diagnostic function to test placeholders
    script += '// ==========================================\n';
    script += '// DIAGNOSTIC: Test if templates have {{PLACEHOLDER}} syntax\n';
    script += '// Run this to verify templates are ready for replacement\n';
    script += '// ==========================================\n';
    script += 'function testPlaceholders() {\n';
    script += '  Logger.log("=== TESTING PLACEHOLDER SYNTAX IN TEMPLATES ===\\n");\n';
    script += '  \n';
    script += '  // Test a few templates to see what patterns they have\n';
    script += '  var testTemplates = {\n';
    script += '    "Certificate of Incorporation": "1cc3hGCGW8tnhbMTuK3rZqF7YF1NQZIjiYJqPADQUa5k",\n';
    script += '    "Restricted Stock Purchase Agreement": "1sq-4D29iapvWMReYbqgay7cHTSunlV4T2hswfnKY4Xw",\n';
    script += '    "SAFE Valuation Cap": TEMPLATE_DOCS.safeValuationCap,\n';
    script += '    "IP Stock Purchase (for Advisors)": TEMPLATE_DOCS.ipStockPurchaseAgreement\n';
    script += '  };\n';
    script += '  \n';
    script += '  for (var templateName in testTemplates) {\n';
    script += '    var templateId = testTemplates[templateName];\n';
    script += '    Logger.log("Testing: " + templateName);\n';
    script += '    \n';
    script += '    try {\n';
    script += '      var doc = DocumentApp.openById(templateId);\n';
    script += '      var body = doc.getBody();\n';
    script += '      \n';
    script += '      // Test for standard placeholders\n';
    script += '      var standardPatterns = [\n';
    script += '        { name: "COMPANY_NAME", pattern: "\\\\{\\\\{COMPANY_NAME\\\\}\\\\}" },\n';
    script += '        { name: "STATE_OF_INCORPORATION", pattern: "\\\\{\\\\{STATE_OF_INCORPORATION\\\\}\\\\}" },\n';
    script += '        { name: "COMPANY\\\\_NAME (backslash)", pattern: "\\\\{\\\\{COMPANY\\\\_NAME\\\\}\\\\}" }\n';
    script += '      ];\n';
    script += '      \n';
    script += '      var foundCount = 0;\n';
    script += '      for (var i = 0; i < standardPatterns.length; i++) {\n';
    script += '        var test = standardPatterns[i];\n';
    script += '        if (body.findText(test.pattern)) {\n';
    script += '          Logger.log("  ✓ Found: " + test.name);\n';
    script += '          foundCount++;\n';
    script += '        }\n';
    script += '      }\n';
    script += '      \n';
    script += '      // Check for old hardcoded text\n';
    script += '      var oldPatterns = ["Mechro, Inc", "Jacob Johnson", "GVS Founders"];\n';
    script += '      var hasOldText = false;\n';
    script += '      for (var j = 0; j < oldPatterns.length; j++) {\n';
    script += '        if (body.findText(oldPatterns[j])) {\n';
    script += '          Logger.log("  ⚠ WARNING: Found OLD hardcoded text: " + oldPatterns[j]);\n';
    script += '          hasOldText = true;\n';
    script += '        }\n';
    script += '      }\n';
    script += '      \n';
    script += '      if (foundCount === 0 && !hasOldText) {\n';
    script += '        Logger.log("  ⚠ No standard placeholders found - may use different placeholder names");\n';
    script += '      } else if (foundCount > 0) {\n';
    script += '        Logger.log("  → Template is READY for replacements");\n';
    script += '      }\n';
    script += '      \n';
    script += '      if (hasOldText) {\n';
    script += '        Logger.log("  → This template needs to be STANDARDIZED first");\n';
    script += '        Logger.log("    Run: TemplatePlaceholderStandardizer_v2.gs -> standardizeAllTemplates()");\n';
    script += '      }\n';
    script += '      \n';
    script += '      doc.saveAndClose();\n';
    script += '    } catch (e) {\n';
    script += '      Logger.log("  ✗ ERROR: " + e.message);\n';
    script += '    }\n';
    script += '    Logger.log("");\n';
    script += '  }\n';
    script += '  \n';
    script += '  Logger.log("=== PLACEHOLDER TEST COMPLETE ===");\n';
    script += '  Logger.log("");\n';
    script += '  Logger.log("NEXT STEPS:");\n';
    script += '  Logger.log("1. If templates show OLD hardcoded text, run the standardizer first");\n';
    script += '  Logger.log("2. If templates are READY, run createVentureDocuments()");\n';
    script += '}\n\n';
    
    // Helper function to find or create folder
    script += '// Helper: Find existing folder or create new one\n';
    script += 'function getOrCreateFolder(parent, folderName) {\n';
    script += '  if (!parent) {\n';
    script += '    throw new Error("Parent folder is undefined. Check that VENTURES_FOLDER_ID exists and you have access.");\n';
    script += '  }\n';
    script += '  var folders = parent.getFoldersByName(folderName);\n';
    script += '  if (folders.hasNext()) {\n';
    script += '    return folders.next();\n';
    script += '  }\n';
    script += '  return parent.createFolder(folderName);\n';
    script += '}\n\n';
    
    // Helper function to find existing document
    script += '// Helper: Find existing document in folder\n';
    script += 'function findExistingDoc(folder, docName) {\n';
    script += '  var files = folder.getFilesByName(docName);\n';
    script += '  if (files.hasNext()) {\n';
    script += '    return files.next();\n';
    script += '  }\n';
    script += '  return null;\n';
    script += '}\n\n';
    
    // Main function
    script += 'function createVentureDocuments() {\n';
    script += '  Logger.log("Creating documents for: " + VENTURE_NAME);\n';
    script += '  Logger.log("Overwrite mode: " + (OVERWRITE_EXISTING ? "ON" : "OFF"));\n';
    script += '  \n';
    script += '  var venturesFolder;\n';
    script += '  try {\n';
    script += '    venturesFolder = DriveApp.getFolderById(VENTURES_FOLDER_ID);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access VENTURES folder with ID: " + VENTURES_FOLDER_ID);\n';
    script += '    Logger.log("Make sure the folder exists and you have edit access.");\n';
    script += '    Logger.log("You can find the folder ID in the URL: https://drive.google.com/drive/folders/[FOLDER_ID]");\n';
    script += '    throw new Error("Cannot access VENTURES folder. See logs for details.");\n';
    script += '  }\n';
    script += '  \n';
    script += '  if (!venturesFolder) {\n';
    script += '    throw new Error("VENTURES folder not found. Check VENTURES_FOLDER_ID: " + VENTURES_FOLDER_ID);\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Find or create venture folder (never delete existing)\n';
    script += '  var ventureFolder = getOrCreateFolder(venturesFolder, VENTURE_NAME);\n';
    script += '  Logger.log("Using venture folder: " + ventureFolder.getUrl());\n';
    script += '  \n';
    script += '  var subNames = Object.keys(TEMPLATE_SUBFOLDERS);\n';
    script += '  var total = 0;\n';
    script += '  var skipped = 0;\n';
    script += '  var updated = 0;\n';
    script += '  \n';
    script += '  for (var i = 0; i < subNames.length; i++) {\n';
    script += '    var subName = subNames[i];\n';
    script += '    var subConfig = TEMPLATE_SUBFOLDERS[subName];\n';
    script += '    var subId = subConfig.id;\n';
    script += '    var newFolderName = subConfig.newName;\n';
    script += '    var category = subConfig.category;\n';
    script += '    \n';
    script += '    // Check if this category should be generated\n';
    script += '    if (!GENERATE[category]) {\n';
    script += '      Logger.log("SKIPPING category: " + category);\n';
    script += '      continue;\n';
    script += '    }\n';
    script += '    \n';
    script += '    // Skip SAFE Templates folder if we are generating individual SAFEs\n';
    script += '    // (individual SAFEs are filled with investor data, templates are blank)\n';
    script += '    if (category === "safeTemplates" && GENERATE.individualSafes) {\n';
    script += '      Logger.log("SKIPPING SAFE Templates (using individual filled SAFEs instead)");\n';
    script += '      continue;\n';
    script += '    }\n';
    script += '    \n';
    script += '    Logger.log("Processing: " + subName + " -> " + newFolderName);\n';
    script += '    var newSub = getOrCreateFolder(ventureFolder, newFolderName);\n';
    script += '    \n';
    script += '    var templateSub;\n';
    script += '    try {\n';
    script += '      templateSub = DriveApp.getFolderById(subId);\n';
    script += '    } catch (e) {\n';
    script += '      Logger.log("ERROR: Could not access template folder: " + subName + " (ID: " + subId + ")");\n';
    script += '      Logger.log("Error: " + e.message);\n';
    script += '      Logger.log("Make sure you have access to the TEMPLATES folder and all subfolders.");\n';
    script += '      continue;\n';
    script += '    }\n';
    script += '    if (!templateSub) {\n';
    script += '      Logger.log("ERROR: Template folder not found: " + subName);\n';
    script += '      continue;\n';
    script += '    }\n';
    script += '    \n';
    script += '    var files = templateSub.getFiles();\n';
    script += '    \n';
    script += '    while (files.hasNext()) {\n';
    script += '      var file = files.next();\n';
    script += '      // Strip "Template" from file names in various positions\n';
    script += '      var baseName = file.getName()\n';
    script += '        .replace(/^Gitwit - Template - /i, "")\n';
    script += '        .replace(/^Template - /i, "")\n';
    script += '        .replace(/^Template- /i, "")\n';
    script += '        .replace(/ - Template$/i, "")\n';
    script += '        .replace(/ Template$/i, "")\n';
    script += '        .replace(/Template /i, "")\n';
    script += '        .replace(/ \\(Template\\)/i, "")\n';
    script += '        .replace(/\\(Template\\) /i, "")\n';
    script += '        .trim();\n';
    script += '      var newName = VENTURE_NAME + " - " + baseName;\n';
    script += '      \n';
    script += '      // Check if document already exists\n';
    script += '      var existingDoc = findExistingDoc(newSub, newName);\n';
    script += '      \n';
    script += '      if (existingDoc && !OVERWRITE_EXISTING) {\n';
    script += '        Logger.log("  SKIPPED (exists): " + newName);\n';
    script += '        skipped++;\n';
    script += '        continue;\n';
    script += '      }\n';
    script += '      \n';
    script += '      if (existingDoc && OVERWRITE_EXISTING) {\n';
    script += '        // Delete existing and create new\n';
    script += '        existingDoc.setTrashed(true);\n';
    script += '        Logger.log("  REPLACING: " + newName);\n';
    script += '        updated++;\n';
    script += '      }\n';
    script += '      \n';
    script += '      var copy = file.makeCopy(newName, newSub);\n';
    script += '      if (file.getMimeType() === "application/vnd.google-apps.document") {\n';
    script += '        applyReplacements(copy.getId());\n';
    script += '      }\n';
    script += '      Logger.log("  Created: " + newName);\n';
    script += '      total++;\n';
    script += '    }\n';
    script += '  }\n';
    script += '  \n';
    
    // Generate individual SAFE documents
    if (safes.length > 0) {
      script += '  // Generate individual SAFE documents\n';
      script += '  if (GENERATE.individualSafes && typeof SAFE_INVESTORS !== "undefined") {\n';
      script += '    var safesFolder = getOrCreateFolder(ventureFolder, VENTURE_NAME + " - SAFE Agreements - Executed");\n';
      script += '    for (var s = 0; s < SAFE_INVESTORS.length; s++) {\n';
      script += '      var investor = SAFE_INVESTORS[s];\n';
      script += '      // Select template based on safeTemplate type\n';
      script += '      var templateId = investor.safeTemplate === "mfn" ? TEMPLATE_DOCS.safeMFN : TEMPLATE_DOCS.safeValuationCap;\n';
      script += '      if (templateId.indexOf("YOUR_") === 0) {\n';
      script += '        Logger.log("  SKIPPED SAFE for " + investor.investorName + " - template ID not configured");\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      // Build document name: VentureName - DocumentType - PersonName\n';
      script += '      var safeName = VENTURE_NAME + " - " + investor.documentName;\n';
      script += '      var existingSafe = findExistingDoc(safesFolder, safeName);\n';
      script += '      if (existingSafe && !OVERWRITE_EXISTING) {\n';
      script += '        Logger.log("  SKIPPED (exists): " + safeName);\n';
      script += '        skipped++;\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      if (existingSafe && OVERWRITE_EXISTING) {\n';
      script += '        existingSafe.setTrashed(true);\n';
      script += '        updated++;\n';
      script += '      }\n';
      script += '      var safeTemplate;\n';
      script += '      try {\n';
      script += '        safeTemplate = DriveApp.getFileById(templateId);\n';
      script += '      } catch (e) {\n';
      script += '        Logger.log("  ERROR: Could not access SAFE template (ID: " + templateId + "): " + e.message);\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      var safeCopy = safeTemplate.makeCopy(safeName, safesFolder);\n';
      script += '      applySafeReplacements(safeCopy.getId(), investor);\n';
      script += '      Logger.log("  Created: " + safeName);\n';
      script += '      total++;\n';
      script += '    }\n';
      script += '  }\n';
    }
    
    // Generate individual employee option documents
    if (employees.length > 0) {
      script += '  \n';
      script += '  // Generate individual Employee Option Agreements\n';
      script += '  if (GENERATE.individualOptions && typeof EMPLOYEE_GRANTS !== "undefined") {\n';
      script += '    var optionsFolder = getOrCreateFolder(ventureFolder, VENTURE_NAME + " - Employee Option Agreements - Executed");\n';
      script += '    for (var e = 0; e < EMPLOYEE_GRANTS.length; e++) {\n';
      script += '      var employee = EMPLOYEE_GRANTS[e];\n';
      script += '      // Select template based on both grant type and option agreement type\n';
      script += '      var templateId;\n';
      script += '      if (employee.optionAgreementType === "earlyExercise") {\n';
      script += '        templateId = employee.grantType === "ISO" ? TEMPLATE_DOCS.optionEarlyExerciseISO : TEMPLATE_DOCS.optionEarlyExerciseNSO;\n';
      script += '      } else {\n';
      script += '        templateId = employee.grantType === "ISO" ? TEMPLATE_DOCS.optionStandardISO : TEMPLATE_DOCS.optionStandardNSO;\n';
      script += '      }\n';
      script += '      if (templateId.indexOf("YOUR_") === 0) {\n';
      script += '        Logger.log("  SKIPPED Option Agreement for " + employee.employeeName + " - template ID not configured");\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      // Build document name: VentureName - DocumentType - PersonName\n';
      script += '      var optionName = VENTURE_NAME + " - " + employee.documentName;\n';
      script += '      var existingOption = findExistingDoc(optionsFolder, optionName);\n';
      script += '      if (existingOption && !OVERWRITE_EXISTING) {\n';
      script += '        Logger.log("  SKIPPED (exists): " + optionName);\n';
      script += '        skipped++;\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      if (existingOption && OVERWRITE_EXISTING) {\n';
      script += '        existingOption.setTrashed(true);\n';
      script += '        updated++;\n';
      script += '      }\n';
      script += '      var optionTemplate;\n';
      script += '      try {\n';
      script += '        optionTemplate = DriveApp.getFileById(templateId);\n';
      script += '      } catch (e) {\n';
      script += '        Logger.log("  ERROR: Could not access Option template (ID: " + templateId + "): " + e.message);\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      var optionCopy = optionTemplate.makeCopy(optionName, optionsFolder);\n';
      script += '      applyEmployeeReplacements(optionCopy.getId(), employee);\n';
      script += '      Logger.log("  Created: " + optionName);\n';
      script += '      total++;\n';
      script += '    }\n';
      script += '  }\n';
    }
    
    // Generate individual advisor documents
    if (advisors.length > 0) {
      script += '  \n';
      script += '  // Generate individual Advisor/Consultant Agreements\n';
      script += '  if (GENERATE.individualAdvisors && typeof ADVISOR_GRANTS !== "undefined") {\n';
      script += '    var advisorsFolder = getOrCreateFolder(ventureFolder, VENTURE_NAME + " - Advisor and Consultant Agreements - Executed");\n';
      script += '    for (var a = 0; a < ADVISOR_GRANTS.length; a++) {\n';
      script += '      var advisor = ADVISOR_GRANTS[a];\n';
      script += '      // Select template based on agreement type\n';
      script += '      var templateId;\n';
      script += '      if (advisor.agreementType === "consulting") {\n';
      script += '        templateId = TEMPLATE_DOCS.consultingAgreement;\n';
      script += '      } else if (advisor.agreementType === "ipStockPurchase") {\n';
      script += '        templateId = TEMPLATE_DOCS.ipStockPurchaseAgreement;\n';
      script += '      } else {\n';
      script += '        templateId = TEMPLATE_DOCS.advisorAgreement;\n';
      script += '      }\n';
      script += '      if (templateId.indexOf("YOUR_") === 0) {\n';
      script += '        Logger.log("  SKIPPED Agreement for " + advisor.advisorName + " - template ID not configured");\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      // Build document name: VentureName - DocumentType - PersonName\n';
      script += '      var advisorDocName = VENTURE_NAME + " - " + advisor.documentName;\n';
      script += '      var existingAdvisor = findExistingDoc(advisorsFolder, advisorDocName);\n';
      script += '      if (existingAdvisor && !OVERWRITE_EXISTING) {\n';
      script += '        Logger.log("  SKIPPED (exists): " + advisorDocName);\n';
      script += '        skipped++;\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      if (existingAdvisor && OVERWRITE_EXISTING) {\n';
      script += '        existingAdvisor.setTrashed(true);\n';
      script += '        updated++;\n';
      script += '      }\n';
      script += '      var advisorTemplate;\n';
      script += '      try {\n';
      script += '        advisorTemplate = DriveApp.getFileById(templateId);\n';
      script += '      } catch (e) {\n';
      script += '        Logger.log("  ERROR: Could not access Advisor template (ID: " + templateId + "): " + e.message);\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      var advisorCopy = advisorTemplate.makeCopy(advisorDocName, advisorsFolder);\n';
      script += '      applyAdvisorReplacements(advisorCopy.getId(), advisor);\n';
      script += '      Logger.log("  Created: " + advisorDocName);\n';
      script += '      total++;\n';
      script += '    }\n';
      script += '  }\n';
    }
    
    script += '  \n';
    script += '  Logger.log("========================================");\n';
    script += '  Logger.log("COMPLETE!");\n';
    script += '  Logger.log("  Created: " + total + " files");\n';
    script += '  Logger.log("  Updated: " + updated + " files");\n';
    script += '  Logger.log("  Skipped: " + skipped + " files (already exist)");\n';
    script += '  Logger.log("Folder: " + ventureFolder.getUrl());\n';
    script += '}\n\n';
    
    // Helper to escape regex special characters
    script += '// Helper: Escape special regex characters for replaceText\n';
    script += 'function escapeRegex(str) {\n';
    script += '  return str.replace(/[\\$\\.\\*\\+\\?\\^\\{\\}\\[\\]\\\\\\|\\(\\)]/g, "\\\\$&");\n';
    script += '}\n\n';
    
    // Color constants
    script += '// Highlight colors for visual QA\n';
    script += 'var HIGHLIGHT_GREEN = "#90EE90"; // Light green - successfully replaced\n';
    script += 'var HIGHLIGHT_RED = "#FFB6C1";   // Light red/pink - unfilled placeholder\n';
    script += 'var HIGHLIGHT_YELLOW = "#FFFF00"; // Yellow - warning\n\n';
    
    // Helper function to highlight text
    script += '/**\n';
    script += ' * Find and highlight all instances of a pattern in the document\n';
    script += ' */\n';
    script += 'function highlightPattern(body, pattern, color) {\n';
    script += '  var found = body.findText(pattern);\n';
    script += '  while (found) {\n';
    script += '    var elem = found.getElement();\n';
    script += '    var start = found.getStartOffset();\n';
    script += '    var end = found.getEndOffsetInclusive();\n';
    script += '    if (elem.editAsText) {\n';
    script += '      elem.editAsText().setBackgroundColor(start, end, color);\n';
    script += '    }\n';
    script += '    found = body.findText(pattern, found);\n';
    script += '  }\n';
    script += '}\n\n';
    
    // Helper function to clear all background colors from a document
    script += '/**\n';
    script += ' * Clear all background highlighting from the document\n';
    script += ' * This removes any pre-existing yellow/colored highlights from templates\n';
    script += ' */\n';
    script += 'function clearAllHighlights(body) {\n';
    script += '  var paragraphs = body.getParagraphs();\n';
    script += '  for (var i = 0; i < paragraphs.length; i++) {\n';
    script += '    var para = paragraphs[i];\n';
    script += '    if (para.editAsText) {\n';
    script += '      var text = para.editAsText();\n';
    script += '      var len = text.getText().length;\n';
    script += '      if (len > 0) {\n';
    script += '        text.setBackgroundColor(0, len - 1, null);\n';
    script += '      }\n';
    script += '    }\n';
    script += '  }\n';
    script += '  // Also clear highlights in tables\n';
    script += '  var tables = body.getTables();\n';
    script += '  for (var t = 0; t < tables.length; t++) {\n';
    script += '    var table = tables[t];\n';
    script += '    for (var r = 0; r < table.getNumRows(); r++) {\n';
    script += '      var row = table.getRow(r);\n';
    script += '      for (var c = 0; c < row.getNumCells(); c++) {\n';
    script += '        var cell = row.getCell(c);\n';
    script += '        var cellText = cell.editAsText();\n';
    script += '        var cellLen = cellText.getText().length;\n';
    script += '        if (cellLen > 0) {\n';
    script += '          cellText.setBackgroundColor(0, cellLen - 1, null);\n';
    script += '        }\n';
    script += '      }\n';
    script += '    }\n';
    script += '  }\n';
    script += '}\n\n';
    
    // Helper function to replace text and highlight ONLY the replaced instances (not all occurrences of the value)
    script += '/**\n';
    script += ' * Find and replace a pattern, highlighting ONLY the replaced text (not all occurrences of the value)\n';
    script += ' * This prevents short values like "0" from highlighting every "0" in the document\n';
    script += ' */\n';
    script += 'function replaceAndHighlight(body, pattern, value, color) {\n';
    script += '  var found = body.findText(pattern);\n';
    script += '  var count = 0;\n';
    script += '  while (found) {\n';
    script += '    var elem = found.getElement();\n';
    script += '    var start = found.getStartOffset();\n';
    script += '    var end = found.getEndOffsetInclusive();\n';
    script += '    \n';
    script += '    // Replace the text\n';
    script += '    var text = elem.editAsText();\n';
    script += '    text.deleteText(start, end);\n';
    script += '    text.insertText(start, value);\n';
    script += '    \n';
    script += '    // Highlight ONLY the newly inserted text\n';
    script += '    if (color && value.length > 0) {\n';
    script += '      text.setBackgroundColor(start, start + value.length - 1, color);\n';
    script += '    }\n';
    script += '    \n';
    script += '    count++;\n';
    script += '    // Find next occurrence (search from beginning since positions shifted)\n';
    script += '    found = body.findText(pattern);\n';
    script += '  }\n';
    script += '  return count;\n';
    script += '}\n\n';
    
    // Helper function to highlight unfilled placeholders in red
    script += '/**\n';
    script += ' * Scan document for any remaining {{PLACEHOLDER}} patterns, underscores, and bracketed text, highlight in red\n';
    script += ' */\n';
    script += 'function highlightUnfilledPlaceholders(body) {\n';
    script += '  // Pattern to match any remaining {{...}} placeholders\n';
    script += '  var pattern = "\\\\{\\\\{[A-Z_]+\\\\}\\\\}";\n';
    script += '  highlightPattern(body, pattern, HIGHLIGHT_RED);\n';
    script += '  \n';
    script += '  // Also check for backslash-escaped version\n';
    script += '  var patternEscaped = "\\\\{\\\\{[A-Z_\\\\\\\\]+\\\\}\\\\}";\n';
    script += '  highlightPattern(body, patternEscaped, HIGHLIGHT_RED);\n';
    script += '  \n';
    script += '  // Highlight underscore placeholders (2 or more consecutive underscores)\n';
    script += '  // These are common in legal templates as fill-in-the-blank fields\n';
    script += '  var underscorePattern = "_{2,}";\n';
    script += '  highlightPattern(body, underscorePattern, HIGHLIGHT_RED);\n';
    script += '  \n';
    script += '  // CRITICAL: Highlight ALL variations of "to be completed" - case insensitive\n';
    script += '  // This must catch [to be completed], [To Be Completed], [TO BE COMPLETED], etc.\n';
    script += '  var toBePatterns = [\n';
    script += '    "\\\\[to be completed\\\\]",\n';
    script += '    "\\\\[To be completed\\\\]",\n';
    script += '    "\\\\[To Be Completed\\\\]",\n';
    script += '    "\\\\[TO BE COMPLETED\\\\]",\n';
    script += '    "\\\\[to be updated\\\\]",\n';
    script += '    "\\\\[To be updated\\\\]",\n';
    script += '    "\\\\[To Be Updated\\\\]",\n';
    script += '    "\\\\[TO BE UPDATED\\\\]",\n';
    script += '    "\\\\[to be determined\\\\]",\n';
    script += '    "\\\\[To be determined\\\\]",\n';
    script += '    "\\\\[To Be Determined\\\\]",\n';
    script += '    "\\\\[TO BE DETERMINED\\\\]",\n';
    script += '    "\\\\[to be inserted\\\\]",\n';
    script += '    "\\\\[To be inserted\\\\]",\n';
    script += '    "\\\\[To Be Inserted\\\\]",\n';
    script += '    "\\\\[TO BE INSERTED\\\\]",\n';
    script += '    "\\\\[to be provided\\\\]",\n';
    script += '    "\\\\[To be provided\\\\]",\n';
    script += '    "\\\\[To Be Provided\\\\]",\n';
    script += '    "\\\\[TO BE PROVIDED\\\\]",\n';
    script += '    "\\\\[to be filled\\\\]",\n';
    script += '    "\\\\[To be filled\\\\]",\n';
    script += '    "\\\\[To Be Filled\\\\]",\n';
    script += '    "\\\\[TO BE FILLED\\\\]",\n';
    script += '    "\\\\[TO BE[^\\\\]]*\\\\]",\n';
    script += '    "\\\\[To Be[^\\\\]]*\\\\]",\n';
    script += '    "\\\\[to be[^\\\\]]*\\\\]"\n';
    script += '  ];\n';
    script += '  for (var t = 0; t < toBePatterns.length; t++) {\n';
    script += '    highlightPattern(body, toBePatterns[t], HIGHLIGHT_RED);\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Highlight other bracketed placeholders\n';
    script += '  var bracketPatterns = [\n';
    script += '    "\\\\[BLANK\\\\]",\n';
    script += '    "\\\\[blank\\\\]",\n';
    script += '    "\\\\[Blank\\\\]",\n';
    script += '    "\\\\[INSERT[^\\\\]]*\\\\]",\n';
    script += '    "\\\\[Insert[^\\\\]]*\\\\]",\n';
    script += '    "\\\\[insert[^\\\\]]*\\\\]",\n';
    script += '    "\\\\[TBD\\\\]",\n';
    script += '    "\\\\[tbd\\\\]",\n';
    script += '    "\\\\[Tbd\\\\]",\n';
    script += '    "\\\\[DATE\\\\]",\n';
    script += '    "\\\\[date\\\\]",\n';
    script += '    "\\\\[Date\\\\]",\n';
    script += '    "\\\\[NAME\\\\]",\n';
    script += '    "\\\\[name\\\\]",\n';
    script += '    "\\\\[Name\\\\]",\n';
    script += '    "\\\\[ADDRESS\\\\]",\n';
    script += '    "\\\\[address\\\\]",\n';
    script += '    "\\\\[Address\\\\]",\n';
    script += '    "\\\\[AMOUNT\\\\]",\n';
    script += '    "\\\\[amount\\\\]",\n';
    script += '    "\\\\[Amount\\\\]",\n';
    script += '    "\\\\[NUMBER\\\\]",\n';
    script += '    "\\\\[number\\\\]",\n';
    script += '    "\\\\[Number\\\\]",\n';
    script += '    "\\\\[SIGNATURE\\\\]",\n';
    script += '    "\\\\[signature\\\\]",\n';
    script += '    "\\\\[Signature\\\\]",\n';
    script += '    "\\\\[_+\\\\]"  // [___] pattern\n';
    script += '  ];\n';
    script += '  for (var i = 0; i < bracketPatterns.length; i++) {\n';
    script += '    highlightPattern(body, bracketPatterns[i], HIGHLIGHT_RED);\n';
    script += '  }\n';
    script += '}\n\n';
    
    // Base replacements function - uses {{PLACEHOLDER}} syntax
    script += '/**\n';
    script += ' * Apply placeholder replacements to a document\n';
    script += ' * Handles both {{PLACEHOLDER}} and {{PLACEHOLDER\\_}} patterns (with/without backslash escapes)\n';
    script += ' * Highlights: GREEN = successfully replaced, RED = unfilled placeholder\n';
    script += ' */\n';
    script += 'function applyReplacements(docId) {\n';
    script += '  try {\n';
    script += '    var doc = DocumentApp.openById(docId);\n';
    script += '    var body = doc.getBody();\n';
    script += '    \n';
    script += '    // Clear any pre-existing highlights (yellow from templates)\n';
    script += '    clearAllHighlights(body);\n';
    script += '    \n';
    script += '    var replacementsMade = 0;\n';
    script += '    var notFound = [];\n';
    script += '    \n';
    script += '    // Process each placeholder replacement\n';
    script += '    var keys = Object.keys(FIELD_REPLACEMENTS);\n';
    script += '    for (var j = 0; j < keys.length; j++) {\n';
    script += '      var placeholder = keys[j];\n';
    script += '      var value = FIELD_REPLACEMENTS[placeholder];\n';
    script += '      \n';
    script += '      // Skip empty values or signature placeholders\n';
    script += '      if (!value || value === "" || value === "__________________") {\n';
    script += '        continue;\n';
    script += '      }\n';
    script += '      \n';
    script += '      // Try multiple patterns to handle potential backslash escaping in Google Docs\n';
    script += '      // Pattern 1: Standard {{PLACEHOLDER}} - escaped braces for regex\n';
    script += '      var pattern1 = placeholder.replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
    script += '      \n';
    script += '      // Pattern 2: With backslash-escaped underscores {{PLACEHOLDER\\_NAME}}\n';
    script += '      // This handles Google Docs Markdown-style escaping\n';
    script += '      var pattern2 = placeholder.replace(/_/g, "\\\\_").replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
    script += '      \n';
    script += '      var found = false;\n';
    script += '      \n';
    script += '      // Try pattern 1 first (standard) - use replaceAndHighlight for targeted green highlighting\n';
    script += '      var count1 = replaceAndHighlight(body, pattern1, value, HIGHLIGHT_GREEN);\n';
    script += '      if (count1 > 0) {\n';
    script += '        replacementsMade += count1;\n';
    script += '        found = true;\n';
    script += '      }\n';
    script += '      \n';
    script += '      // Try pattern 2 if pattern 1 not found (backslash-escaped)\n';
    script += '      if (!found && pattern1 !== pattern2) {\n';
    script += '        var count2 = replaceAndHighlight(body, pattern2, value, HIGHLIGHT_GREEN);\n';
    script += '        if (count2 > 0) {\n';
    script += '          replacementsMade += count2;\n';
    script += '          found = true;\n';
    script += '        }\n';
    script += '      }\n';
    script += '      \n';
    script += '      if (!found) {\n';
    script += '        notFound.push(placeholder);\n';
    script += '      }\n';
    script += '    }\n';
    script += '    \n';
    script += '    // Special handling for GVS IP Assignment - highlight in red if not provided\n';
    script += '    var gvsIPDescription = FIELD_REPLACEMENTS["{{DESCRIPTION_OF_GVS_IP_ASSIGNMENT}}"] || "";\n';
    script += '    if (!gvsIPDescription) {\n';
    script += '      // Replace with red-highlighted placeholder text\n';
    script += '      replaceAndHighlight(body, "{{DESCRIPTION_OF_GVS_IP_ASSIGNMENT}}", "[GVS IP ASSIGNMENT DESCRIPTION REQUIRED - See Formation RSPA]", HIGHLIGHT_RED);\n';
    script += '      // Also try backslash-escaped version\n';
    script += '      replaceAndHighlight(body, "{{DESCRIPTION\\\\_OF\\\\_GVS\\\\_IP\\\\_ASSIGNMENT}}", "[GVS IP ASSIGNMENT DESCRIPTION REQUIRED - See Formation RSPA]", HIGHLIGHT_RED);\n';
    script += '      Logger.log("    WARNING: GVS IP Assignment description not provided - highlighted in RED");\n';
    script += '    }\n';
    script += '    \n';
    script += '    // Highlight any remaining unfilled placeholders in red\n';
    script += '    highlightUnfilledPlaceholders(body);\n';
    script += '    \n';
    script += '    doc.saveAndClose();\n';
    script += '    Logger.log("    Replacements made: " + replacementsMade + " / " + keys.length);\n';
    script += '    if (notFound.length > 0 && notFound.length <= 10) {\n';
    script += '      Logger.log("    Not found in doc: " + notFound.join(", "));\n';
    script += '    } else if (notFound.length > 10) {\n';
    script += '      Logger.log("    Not found in doc: " + notFound.length + " placeholders (templates may need standardizing)");\n';
    script += '    }\n';
    script += '  } catch (e) { \n';
    script += '    Logger.log("ERROR in applyReplacements: " + e.message); \n';
    script += '  }\n';
    script += '}\n\n';
    
    // SAFE replacements function - uses {{PLACEHOLDER}} syntax
    if (safes.length > 0) {
      script += '/**\n';
      script += ' * SAFE Document Field Replacements - {{PLACEHOLDER}} syntax\n';
      script += ' * Handles both standard and backslash-escaped patterns\n';
      script += ' * Highlights: GREEN = successfully replaced, RED = unfilled placeholder\n';
      script += ' */\n';
      script += 'function applySafeReplacements(docId, investor) {\n';
      script += '  try {\n';
      script += '    var doc = DocumentApp.openById(docId);\n';
      script += '    var body = doc.getBody();\n';
      script += '    \n';
      script += '    // Clear any pre-existing highlights (yellow from templates)\n';
      script += '    clearAllHighlights(body);\n';
      script += '    \n';
      script += '    var replacementsMade = 0;\n';
      script += '    var replacedValues = []; // Track values for highlighting\n';
      script += '    \n';
      script += '    // Helper function to try both patterns and do replacement with targeted highlighting\n';
      script += '    function doReplace(placeholder, value) {\n';
      script += '      if (value === undefined || value === null) value = "";\n';
      script += '      value = String(value);\n';
      script += '      if (value === "" || value === "__________________") return false;\n';
      script += '      \n';
      script += '      // Pattern 1: Standard {{PLACEHOLDER}}\n';
      script += '      var pattern1 = placeholder.replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
      script += '      // Pattern 2: Backslash-escaped {{PLACEHOLDER\\_NAME}}\n';
      script += '      var pattern2 = placeholder.replace(/_/g, "\\\\_").replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
      script += '      \n';
      script += '      // Use replaceAndHighlight for targeted green highlighting (only highlights the replaced text)\n';
      script += '      var count1 = replaceAndHighlight(body, pattern1, value, HIGHLIGHT_GREEN);\n';
      script += '      if (count1 > 0) {\n';
      script += '        replacementsMade += count1;\n';
      script += '        return true;\n';
      script += '      }\n';
      script += '      if (pattern1 !== pattern2) {\n';
      script += '        var count2 = replaceAndHighlight(body, pattern2, value, HIGHLIGHT_GREEN);\n';
      script += '        if (count2 > 0) {\n';
      script += '          replacementsMade += count2;\n';
      script += '          return true;\n';
      script += '        }\n';
      script += '      }\n';
      script += '      return false;\n';
      script += '    }\n';
      script += '    \n';
      script += '    // First apply all base company replacements\n';
      script += '    var keys = Object.keys(FIELD_REPLACEMENTS);\n';
      script += '    for (var j = 0; j < keys.length; j++) {\n';
      script += '      var placeholder = keys[j];\n';
      script += '      var value = FIELD_REPLACEMENTS[placeholder];\n';
      script += '      if (value && value !== "" && value !== "__________________") {\n';
      script += '        doReplace(placeholder, value);\n';
      script += '      }\n';
      script += '    }\n';
      script += '    \n';
      script += '    // Investor-specific replacements\n';
      script += '    doReplace("{{INVESTOR_NAME}}", investor.investorName);\n';
      script += '    doReplace("{{PURCHASE_AMOUNT}}", "$" + investor.amount);\n';
      script += '    doReplace("{{PURCHASE_AMOUNT_WORDS}}", investor.amountWords + " dollars");\n';
      script += '    doReplace("{{VALUATION_CAP}}", "$" + investor.valuationCap);\n';
      script += '    doReplace("{{VALUATION_CAP_WORDS}}", investor.valuationCapWords || "");\n';
      script += '    doReplace("{{DISCOUNT_RATE}}", investor.discount + "%");\n';
      script += '    doReplace("{{INVESTOR_JURISDICTION}}", investor.jurisdiction || VENTURE_DATA.state);\n';
      script += '    doReplace("{{INVESTOR_ADDRESS}}", investor.address || "");\n';
      script += '    doReplace("{{INVESTOR_EMAIL}}", investor.email || "");\n';
      script += '    doReplace("{{EFFECTIVE_DATE}}", investor.date);\n';
      script += '    \n';
      script += '    // Highlight any remaining unfilled placeholders in red\n';
      script += '    highlightUnfilledPlaceholders(body);\n';
      script += '    \n';
      script += '    doc.saveAndClose();\n';
      script += '    Logger.log("    Applied " + replacementsMade + " replacements for: " + investor.investorName);\n';
      script += '  } catch (e) { \n';
      script += '    Logger.log("ERROR in applySafeReplacements: " + e.message); \n';
      script += '  }\n';
      script += '}\n\n';
    }
    
    // Employee option replacements function - uses {{PLACEHOLDER}} syntax
    if (employees.length > 0) {
      script += '/**\n';
      script += ' * Employee Option Agreement Field Replacements - {{PLACEHOLDER}} syntax\n';
      script += ' * Handles both standard and backslash-escaped patterns\n';
      script += ' * Highlights: GREEN = successfully replaced, RED = unfilled placeholder\n';
      script += ' */\n';
      script += 'function applyEmployeeReplacements(docId, employee) {\n';
      script += '  try {\n';
      script += '    var doc = DocumentApp.openById(docId);\n';
      script += '    var body = doc.getBody();\n';
      script += '    \n';
      script += '    // Clear any pre-existing highlights (yellow from templates)\n';
      script += '    clearAllHighlights(body);\n';
      script += '    \n';
      script += '    var replacementsMade = 0;\n';
      script += '    var replacedValues = []; // Track values for highlighting\n';
      script += '    \n';
      script += '    // Helper function to try both patterns and do replacement with targeted highlighting\n';
      script += '    function doReplace(placeholder, value) {\n';
      script += '      if (value === undefined || value === null) value = "";\n';
      script += '      value = String(value);\n';
      script += '      if (value === "" || value === "__________________") return false;\n';
      script += '      \n';
      script += '      // Pattern 1: Standard {{PLACEHOLDER}}\n';
      script += '      var pattern1 = placeholder.replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
      script += '      // Pattern 2: Backslash-escaped {{PLACEHOLDER\\_NAME}}\n';
      script += '      var pattern2 = placeholder.replace(/_/g, "\\\\_").replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
      script += '      \n';
      script += '      // Use replaceAndHighlight for targeted green highlighting (only highlights the replaced text)\n';
      script += '      var count1 = replaceAndHighlight(body, pattern1, value, HIGHLIGHT_GREEN);\n';
      script += '      if (count1 > 0) {\n';
      script += '        replacementsMade += count1;\n';
      script += '        return true;\n';
      script += '      }\n';
      script += '      if (pattern1 !== pattern2) {\n';
      script += '        var count2 = replaceAndHighlight(body, pattern2, value, HIGHLIGHT_GREEN);\n';
      script += '        if (count2 > 0) {\n';
      script += '          replacementsMade += count2;\n';
      script += '          return true;\n';
      script += '        }\n';
      script += '      }\n';
      script += '      return false;\n';
      script += '    }\n';
      script += '    \n';
      script += '    // First apply all base company replacements\n';
      script += '    var keys = Object.keys(FIELD_REPLACEMENTS);\n';
      script += '    for (var j = 0; j < keys.length; j++) {\n';
      script += '      var placeholder = keys[j];\n';
      script += '      var value = FIELD_REPLACEMENTS[placeholder];\n';
      script += '      if (value && value !== "" && value !== "__________________") {\n';
      script += '        doReplace(placeholder, value);\n';
      script += '      }\n';
      script += '    }\n';
      script += '    \n';
      script += '    // Employee-specific replacements\n';
      script += '    doReplace("{{OPTIONEE_NAME}}", employee.employeeName);\n';
      script += '    doReplace("{{EMPLOYEE_NAME}}", employee.employeeName);\n';
      script += '    doReplace("{{PERSON_FULL_NAME}}", employee.employeeName);\n';
      script += '    doReplace("{{EMPLOYEE_TITLE}}", employee.employeeTitle || "");\n';
      script += '    doReplace("{{OPTIONEE_TITLE}}", employee.employeeTitle || "");\n';
      script += '    doReplace("{{NUMBER_OF_OPTION_SHARES}}", employee.shares);\n';
      script += '    doReplace("{{NUMBER_OF_SHARES}}", employee.shares);\n';
      script += '    doReplace("{{SHARES_WORDS}}", employee.sharesWords);\n';
      script += '    doReplace("{{EXERCISE_PRICE}}", "$" + employee.exercisePrice);\n';
      script += '    doReplace("{{DOLLAR_AMOUNT}}", "$" + employee.exercisePrice);\n';
      script += '    \n';
      script += '    // Calculate total exercise value\n';
      script += '    var totalValue = (parseFloat(employee.shares.replace(/,/g, "")) * parseFloat(employee.exercisePrice)).toFixed(2);\n';
      script += '    doReplace("{{TOTAL_EXERCISE_PRICE}}", "$" + totalValue);\n';
      script += '    doReplace("{{AGGREGATE_EXERCISE_PRICE}}", "$" + totalValue);\n';
      script += '    \n';
      script += '    // Date replacements\n';
      script += '    doReplace("{{GRANT_DATE}}", employee.grantDate);\n';
      script += '    doReplace("{{VESTING_START_DATE}}", employee.vestingStartDate || employee.grantDate);\n';
      script += '    doReplace("{{EFFECTIVE_DATE}}", employee.grantDate);\n';
      script += '    \n';
      script += '    // Vesting details\n';
      script += '    doReplace("{{VESTING_SCHEDULE}}", employee.vestingSchedule);\n';
      script += '    doReplace("{{CLIFF_PERIOD_YEARS}}", "one");\n';
      script += '    doReplace("{{TOTAL_VESTING_YEARS}}", "four");\n';
      script += '    doReplace("{{MONTHLY_VESTING_FRACTION}}", "1/48th");\n';
      script += '    doReplace("{{CLIFF_VESTING_FRACTION}}", "1/4th");\n';
      script += '    \n';
      script += '    // Grant type\n';
      script += '    doReplace("{{GRANT_TYPE}}", employee.grantType);\n';
      script += '    doReplace("{{OPTION_TYPE}}", employee.grantType === "ISO" ? "Incentive Stock Option" : "Non-Qualified Stock Option");\n';
      script += '    \n';
      script += '    // Contact info (if available)\n';
      script += '    doReplace("{{OPTIONEE_ADDRESS}}", employee.address || "");\n';
      script += '    doReplace("{{OPTIONEE_EMAIL}}", employee.email || "");\n';
      script += '    \n';
      script += '    // Highlight any remaining unfilled placeholders in red\n';
      script += '    highlightUnfilledPlaceholders(body);\n';
      script += '    \n';
      script += '    doc.saveAndClose();\n';
      script += '    Logger.log("    Applied " + replacementsMade + " replacements for: " + employee.employeeName);\n';
      script += '  } catch (e) { \n';
      script += '    Logger.log("ERROR in applyEmployeeReplacements: " + e.message); \n';
      script += '  }\n';
      script += '}\n\n';
    }
    
    // Advisor replacements function - uses {{PLACEHOLDER}} syntax
    if (advisors.length > 0) {
      script += '/**\n';
      script += ' * Advisor/Consultant Agreement Field Replacements - {{PLACEHOLDER}} syntax\n';
      script += ' * For IP Stock Purchase: Uses the founder RSPA template but replaces founder placeholders with advisor data\n';
      script += ' * Handles both standard and backslash-escaped patterns\n';
      script += ' * Highlights: GREEN = successfully replaced, RED = unfilled placeholder\n';
      script += ' */\n';
      script += 'function applyAdvisorReplacements(docId, advisor) {\n';
      script += '  try {\n';
      script += '    var doc = DocumentApp.openById(docId);\n';
      script += '    var body = doc.getBody();\n';
      script += '    \n';
      script += '    // Clear any pre-existing highlights (yellow from templates)\n';
      script += '    clearAllHighlights(body);\n';
      script += '    \n';
      script += '    var replacementsMade = 0;\n';
      script += '    var replacedValues = []; // Track values for highlighting\n';
      script += '    \n';
      script += '    // Helper function to try both patterns and do replacement with targeted highlighting\n';
      script += '    function doReplace(placeholder, value) {\n';
      script += '      if (value === undefined || value === null) value = "";\n';
      script += '      value = String(value);\n';
      script += '      if (value === "" || value === "__________________") return false;\n';
      script += '      \n';
      script += '      // Pattern 1: Standard {{PLACEHOLDER}}\n';
      script += '      var pattern1 = placeholder.replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
      script += '      // Pattern 2: Backslash-escaped {{PLACEHOLDER\\_NAME}}\n';
      script += '      var pattern2 = placeholder.replace(/_/g, "\\\\_").replace(/\\{/g, "\\\\{").replace(/\\}/g, "\\\\}");\n';
      script += '      \n';
      script += '      // Use replaceAndHighlight for targeted green highlighting (only highlights the replaced text)\n';
      script += '      var count1 = replaceAndHighlight(body, pattern1, value, HIGHLIGHT_GREEN);\n';
      script += '      if (count1 > 0) {\n';
      script += '        replacementsMade += count1;\n';
      script += '        return true;\n';
      script += '      }\n';
      script += '      if (pattern1 !== pattern2) {\n';
      script += '        var count2 = replaceAndHighlight(body, pattern2, value, HIGHLIGHT_GREEN);\n';
      script += '        if (count2 > 0) {\n';
      script += '          replacementsMade += count2;\n';
      script += '          return true;\n';
      script += '        }\n';
      script += '      }\n';
      script += '      return false;\n';
      script += '    }\n';
      script += '    \n';
      script += '    // For IP Stock Purchase, we use the founder RSPA template\n';
      script += '    // Replace founder placeholders with advisor data BEFORE applying base replacements\n';
      script += '    if (advisor.agreementType === "ipStockPurchase") {\n';
      script += '      // Calculate total purchase price\n';
      script += '      var totalPurchasePrice = (parseFloat(advisor.shares.replace(/,/g, "")) * parseFloat(advisor.exercisePrice)).toFixed(2);\n';
      script += '      \n';
      script += '      // Replace founder-specific placeholders with advisor data\n';
      script += '      doReplace("{{FOUNDER_ENTITY_NAME}}", advisor.advisorName);\n';
      script += '      doReplace("{{FOUNDER_NAME}}", advisor.advisorName);\n';
      script += '      doReplace("{{FOUNDER_COMMON_SHARES}}", advisor.shares);\n';
      script += '      doReplace("{{FOUNDER_FF_PREFERRED_SHARES}}", "0");\n';
      script += '      doReplace("{{FF_PREFERRED_SHARES_AUTHORIZED}}", "0");\n';
      script += '      doReplace("{{FOUNDER_COMMON_PURCHASE_PRICE}}", "$" + totalPurchasePrice);\n';
      script += '      doReplace("{{FOUNDER_FF_PREFERRED_PURCHASE_PRICE}}", "$0.00");\n';
      script += '      doReplace("{{TOTAL_FOUNDER_PURCHASE_PRICE}}", "$" + totalPurchasePrice);\n';
      script += '      doReplace("{{AGGREGATE_PURCHASE_PRICE}}", "$" + totalPurchasePrice);\n';
      script += '      doReplace("{{NUMBER_OF_SHARES}}", advisor.shares);\n';
      script += '      doReplace("{{PRICE_PER_SHARE}}", "$" + advisor.exercisePrice);\n';
      script += '      \n';
      script += '      // Replace GVS Founders II LLC (the template placeholder) with advisor name\n';
      script += '      replaceAndHighlight(body, "GVS FOUNDERS II LLC", advisor.advisorName.toUpperCase(), HIGHLIGHT_GREEN);\n';
      script += '      replaceAndHighlight(body, "GVS Founders II LLC", advisor.advisorName, HIGHLIGHT_GREEN);\n';
      script += '      \n';
      script += '      // Replace person name in signature block\n';
      script += '      doReplace("{{PERSON_NAME}}", VENTURE_DATA.incorporatorName || VENTURE_DATA.initialDirectorName);\n';
      script += '      \n';
      script += '      // Project name (used in Project Technology description)\n';
      script += '      var projectInfo = advisor.projectName || "[Project Name]";\n';
      script += '      doReplace("{{INVESTOR_JURISDICTION}}", projectInfo);\n';
      script += '      \n';
      script += '      // Description of Advisor IP Assignment - highlight in red if not provided\n';
      script += '      var advisorIPDescription = advisor.descriptionOfAdvisorIPAssignment || "";\n';
      script += '      if (advisorIPDescription) {\n';
      script += '        replaceAndHighlight(body, "{{DESCRIPTION_OF_ADVISOR_IP_ASSIGNMENT}}", advisorIPDescription, HIGHLIGHT_GREEN);\n';
      script += '      } else {\n';
      script += '        replaceAndHighlight(body, "{{DESCRIPTION_OF_ADVISOR_IP_ASSIGNMENT}}", "[ADVISOR IP ASSIGNMENT DESCRIPTION REQUIRED]", HIGHLIGHT_RED);\n';
      script += '      }\n';
      script += '      \n';
      script += '      // Replace [Input] placeholders in Exhibit A\n';
      script += '      var defaultFillIn = advisor.projectName ? "See attached schedule" : "[To be completed]";\n';
      script += '      replaceAndHighlight(body, "\\\\[Input\\\\]", defaultFillIn, defaultFillIn === "[To be completed]" ? HIGHLIGHT_RED : HIGHLIGHT_GREEN);\n';
      script += '      \n';
      script += '      Logger.log("    Applied IP Stock Purchase (RSPA) replacements for: " + advisor.advisorName);\n';
      script += '      Logger.log("      Project: " + projectInfo);\n';
      script += '      Logger.log("      Advisor IP Description: " + (advisorIPDescription ? "Provided" : "NOT PROVIDED - HIGHLIGHTED RED"));\n';
      script += '      Logger.log("      Shares: " + advisor.shares + " @ $" + advisor.exercisePrice + " = $" + totalPurchasePrice);\n';
      script += '    }\n';
      script += '    \n';
      script += '    // Apply base company replacements\n';
      script += '    var keys = Object.keys(FIELD_REPLACEMENTS);\n';
      script += '    for (var j = 0; j < keys.length; j++) {\n';
      script += '      var placeholder = keys[j];\n';
      script += '      var value = FIELD_REPLACEMENTS[placeholder];\n';
      script += '      // Skip founder placeholders for IP Stock Purchase (already handled above)\n';
      script += '      if (advisor.agreementType === "ipStockPurchase" && placeholder.indexOf("FOUNDER") !== -1) {\n';
      script += '        continue;\n';
      script += '      }\n';
      script += '      if (value && value !== "" && value !== "__________________") {\n';
      script += '        doReplace(placeholder, value);\n';
      script += '      }\n';
      script += '    }\n';
      script += '    \n';
      script += '    // Advisor-specific replacements (for Advisor and Consulting agreements)\n';
      script += '    if (advisor.agreementType !== "ipStockPurchase") {\n';
      script += '      doReplace("{{ADVISOR_NAME}}", advisor.advisorName);\n';
      script += '      doReplace("{{CONSULTANT_NAME}}", advisor.advisorName);\n';
      script += '      doReplace("{{PERSON_FULL_NAME}}", advisor.advisorName);\n';
      script += '      doReplace("{{PERSON_NAME}}", advisor.advisorName);\n';
      script += '      doReplace("{{ADVISOR_TITLE}}", advisor.advisorTitle || "Advisor");\n';
      script += '      doReplace("{{CONSULTANT_TITLE}}", advisor.advisorTitle || "Consultant");\n';
      script += '      doReplace("{{ADVISOR_SHARES}}", advisor.shares);\n';
      script += '      doReplace("{{CONSULTANT_SHARES}}", advisor.shares);\n';
      script += '      doReplace("{{NUMBER_OF_SHARES}}", advisor.shares);\n';
      script += '      doReplace("{{EQUITY_GRANT_SHARES}}", advisor.shares);\n';
      script += '      doReplace("{{SHARES_WORDS}}", advisor.sharesWords);\n';
      script += '      doReplace("{{EXERCISE_PRICE}}", "$" + advisor.exercisePrice);\n';
      script += '      doReplace("{{PRICE_PER_SHARE}}", "$" + advisor.exercisePrice);\n';
      script += '      \n';
      script += '      // Calculate total value\n';
      script += '      var totalValue = (parseFloat(advisor.shares.replace(/,/g, "")) * parseFloat(advisor.exercisePrice)).toFixed(2);\n';
      script += '      doReplace("{{TOTAL_PURCHASE_PRICE}}", "$" + totalValue);\n';
      script += '      doReplace("{{AGGREGATE_PURCHASE_PRICE}}", "$" + totalValue);\n';
      script += '    }\n';
      script += '    \n';
      script += '    // Date replacements (all agreement types)\n';
      script += '    doReplace("{{GRANT_DATE}}", advisor.grantDate);\n';
      script += '    doReplace("{{EFFECTIVE_DATE}}", advisor.grantDate);\n';
      script += '    doReplace("{{VESTING_START_DATE}}", advisor.grantDate);\n';
      script += '    doReplace("{{VESTING_SCHEDULE}}", advisor.vestingSchedule);\n';
      script += '    \n';
      script += '    // Advisor vesting (typically 2 years monthly)\n';
      script += '    doReplace("{{TOTAL_VESTING_PERIOD}}", "two");\n';
      script += '    doReplace("{{MONTHLY_VESTING_FRACTION}}", "1/24th");\n';
      script += '    \n';
      script += '    // Contact info (if available)\n';
      script += '    doReplace("{{ADVISOR_ADDRESS}}", advisor.address || "");\n';
      script += '    doReplace("{{ADVISOR_EMAIL}}", advisor.email || "");\n';
      script += '    doReplace("{{CONSULTANT_ADDRESS}}", advisor.address || "");\n';
      script += '    doReplace("{{CONSULTANT_EMAIL}}", advisor.email || "");\n';
      script += '    \n';
      script += '    // Consulting-specific fields\n';
      script += '    doReplace("{{MONTHLY_HOURS}}", advisor.monthlyHours || "5-10");\n';
      script += '    doReplace("{{CONSULTING_FEE}}", advisor.consultingFee || "");\n';
      script += '    doReplace("{{HOURLY_RATE}}", advisor.hourlyRate || "");\n';
      script += '    doReplace("{{SERVICES_DESCRIPTION}}", advisor.servicesDescription || "Strategic advisory services");\n';
      script += '    doReplace("{{SCOPE_OF_WORK}}", advisor.scopeOfWork || "");\n';
      script += '    doReplace("{{AREA_OF_EXPERTISE}}", advisor.areaOfExpertise || "");\n';
      script += '    \n';
      script += '    // Highlight any remaining unfilled placeholders in red\n';
      script += '    highlightUnfilledPlaceholders(body);\n';
      script += '    \n';
      script += '    doc.saveAndClose();\n';
      script += '    Logger.log("    Applied " + replacementsMade + " replacements for: " + advisor.advisorName);\n';
      script += '  } catch (e) { \n';
      script += '    Logger.log("ERROR in applyAdvisorReplacements: " + e.message); \n';
      script += '  }\n';
      script += '}\n';
    }
    
    return script;
  };

  // Helper function to add document generation audit log entry
  const addAuditLogEntry = async (venture, options) => {
    const docs = options.docs || {};
    const timestamp = new Date().toISOString();
    
    // Get list of documents being generated
    const documentNames = [];
    
    // Formation documents
    const formationDocNames = {
      certificateOfIncorporation: 'Certificate of Incorporation',
      bylaws: 'Bylaws',
      actionOfIncorporator: 'Action of Incorporator',
      organizationalResolutions: 'Organizational Resolutions',
      restrictedStockPurchaseAgreement: 'Restricted Stock Purchase Agreement',
      equityIncentivePlan: 'Equity Incentive Plan',
      equityPlanStockholderConsent: 'Equity Plan Stockholder Consent',
    };
    
    const templateDocNames = {
      safeMFN: 'SAFE (MFN) Template',
      safeValuationCap: 'SAFE (Valuation Cap) Template',
      immediatelyExercisableOption: 'Option Agreement (Early Exercise) Template',
      nonImmediatelyExercisableOption: 'Option Agreement (Standard) Template',
      equityPlanRSPA: 'Restricted Stock Purchase Agreement Template',
      exerciseAgreementStandard: 'Exercise Agreement (Standard) Template',
      exerciseAgreementEarly: 'Exercise Agreement (Early) Template',
      offerLetter: 'Offer Letter Template',
      eiaca: 'EIACA Template',
      advisorAgreement: 'Advisor Agreement Template',
      consultingAgreement: 'Consulting Agreement Template',
      corporateConsultingAgreement: 'Corporate Consulting Agreement Template',
      ipStockPurchaseAgreement: 'IP Stock Purchase Agreement Template',
    };
    
    // Add formation docs
    Object.entries(formationDocNames).forEach(([key, name]) => {
      if (docs[key]) documentNames.push(name);
    });
    
    // Add template docs
    Object.entries(templateDocNames).forEach(([key, name]) => {
      if (docs[key]) documentNames.push(name);
    });
    
    // Add individual SAFEs
    if (options.individualSafes) {
      (venture.fundingRounds || []).filter(f => f.type === 'SAFE').forEach(safe => {
        const templateType = safe.safeTemplate === 'mfn' ? 'MFN' : 'Valuation Cap';
        documentNames.push(`${venture.legalName} - Post-Money SAFE (${templateType}) - ${safe.investorName}`);
      });
    }
    
    // Add individual employee grants
    if (options.individualOptions) {
      (venture.employeeGrants || []).forEach(grant => {
        const agreementType = grant.optionAgreementType === 'earlyExercise' ? 'Early Exercise' : 'Standard';
        documentNames.push(`${venture.legalName} - Option Agreement (${agreementType}) - ${grant.employeeName}`);
      });
    }
    
    // Add individual advisor agreements
    if (options.individualAdvisors) {
      (venture.advisorGrants || []).forEach(grant => {
        const agreementType = grant.agreementType === 'consulting' ? 'Consulting Agreement' :
                              grant.agreementType === 'corporateConsulting' ? 'Corporate Consulting Agreement' :
                              grant.agreementType === 'ipStockPurchase' ? 'Restricted Stock Purchase Agreement (IP Assignment)' :
                              'Advisor Agreement';
        documentNames.push(`${venture.legalName} - ${agreementType} - ${grant.advisorName}`);
      });
    }
    
    // Create audit entry
    const auditEntry = {
      generatedAt: timestamp,
      documentsGenerated: documentNames,
      overwriteEnabled: options.overwrite === true,
      dataSnapshot: {
        legalName: venture.legalName,
        state: venture.state,
        totalSAFEs: (venture.fundingRounds || []).filter(f => f.type === 'SAFE').length,
        totalEmployees: (venture.employeeGrants || []).length,
        totalAdvisors: (venture.advisorGrants || []).length,
        presidentName: venture.presidentName || '[not set]',
        secretaryName: venture.secretaryName || '[not set]',
        treasurerName: venture.treasurerName || '[not set]',
      }
    };
    
    // Update venture with audit log
    const updatedVenture = {
      ...venture,
      documentAuditLog: [...(venture.documentAuditLog || []), auditEntry]
    };
    
    // Save to storage
    try {
      await window.storage.set(`venture:${venture.id}`, JSON.stringify(updatedVenture));
      setVentures(prev => prev.map(v => v.id === venture.id ? updatedVenture : v));
      if (selectedVenture?.id === venture.id) {
        setSelectedVenture(updatedVenture);
      }
    } catch (e) {
      console.error('Failed to save audit log:', e);
    }
    
    return auditEntry;
  };

  // Helper function to convert numbers to words
  const numberToWords = (num) => {
    if (num === 0) return 'zero';
    const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
    const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
    const scales = ['', 'thousand', 'million', 'billion'];
    
    const convertHundreds = (n) => {
      let result = '';
      if (n >= 100) {
        result += ones[Math.floor(n / 100)] + ' hundred';
        n %= 100;
        if (n > 0) result += ' ';
      }
      if (n >= 20) {
        result += tens[Math.floor(n / 10)];
        n %= 10;
        if (n > 0) result += '-' + ones[n];
      } else if (n > 0) {
        result += ones[n];
      }
      return result;
    };
    
    let result = '';
    let scaleIndex = 0;
    while (num > 0) {
      const chunk = num % 1000;
      if (chunk > 0) {
        const chunkWords = convertHundreds(chunk);
        if (scaleIndex > 0) {
          result = chunkWords + ' ' + scales[scaleIndex] + (result ? ' ' + result : '');
        } else {
          result = chunkWords + (result ? ' ' + result : '');
        }
      }
      num = Math.floor(num / 1000);
      scaleIndex++;
    }
    return result;
  };

  // Generate script for a single SAFE document
  const generateSingleSafeScript = (venture, safe, overwrite = true) => {
    const name = venture.legalName || '';
    const investorName = safe.investorName || 'Investor';
    const safeTemplate = safe.safeTemplate || 'valuationCap';
    // Document name: VentureName - DocumentType - PersonName
    const docName = name + ' - ' + (safeTemplate === 'mfn' 
      ? 'Post-Money SAFE (MFN) - ' + investorName
      : 'Post-Money SAFE (Valuation Cap) - ' + investorName);
    
    let script = '/**\n';
    script += ' * INDIVIDUAL SAFE DOCUMENT GENERATOR\n';
    script += ' * Company: ' + name + '\n';
    script += ' * Investor: ' + investorName + '\n';
    script += ' * SAFE Type: ' + (safeTemplate === 'mfn' ? 'MFN (Most Favored Nation)' : 'Valuation Cap') + '\n';
    script += ' * Amount: $' + (safe.amount || 0).toLocaleString() + '\n';
    if (safeTemplate !== 'mfn') {
      script += ' * Valuation Cap: $' + (safe.valuationCap || 0).toLocaleString() + '\n';
    }
    script += ' * Overwrite Mode: ' + (overwrite ? 'ON' : 'OFF') + '\n';
    script += ' */\n\n';
    
    script += 'var VENTURE_NAME = "' + name + '";\n';
    script += 'var VENTURES_FOLDER_ID = "1wq9rS06o9_tPkFWHnVIJn1wJ6JFuMHSR";\n';
    script += 'var DOC_NAME = "' + docName + '";\n';
    script += 'var OVERWRITE_EXISTING = ' + overwrite + ';\n\n';
    
    script += '// SAFE Template IDs\n';
    script += 'var SAFE_TEMPLATE_VALUATION_CAP = "1JsJ9jp6wlfHvIm8E5oCDHvkpSbE5VpNVQoscPxhxCHo";\n';
    script += 'var SAFE_TEMPLATE_MFN = "1qCiwnJ322P2tb82yEfctVrrHKcov8vG42DmHvpW9E4I";\n';
    script += 'var SAFE_TEMPLATE_TYPE = "' + safeTemplate + '"; // valuationCap or mfn\n\n';
    
    script += 'var INVESTOR_DATA = {\n';
    script += '  investorName: "' + investorName + '",\n';
    script += '  date: "' + (safe.date || '') + '",\n';
    script += '  amount: "' + (safe.amount || 0).toLocaleString() + '",\n';
    script += '  amountWords: "' + numberToWords(safe.amount || 0) + '",\n';
    script += '  valuationCap: "' + (safe.valuationCap || 0).toLocaleString() + '",\n';
    script += '  discount: "' + (safe.discount || 0) + '",\n';
    script += '  safeTemplate: "' + safeTemplate + '"\n';
    script += '};\n\n';
    
    script += 'function getOrCreateFolder(parent, folderName) {\n';
    script += '  if (!parent) {\n';
    script += '    throw new Error("Parent folder is undefined. Check that VENTURES_FOLDER_ID exists and you have access.");\n';
    script += '  }\n';
    script += '  var folders = parent.getFoldersByName(folderName);\n';
    script += '  return folders.hasNext() ? folders.next() : parent.createFolder(folderName);\n';
    script += '}\n\n';
    
    script += 'function findExistingDoc(folder, docName) {\n';
    script += '  var files = folder.getFilesByName(docName);\n';
    script += '  return files.hasNext() ? files.next() : null;\n';
    script += '}\n\n';
    
    script += 'function createSafeDocument() {\n';
    script += '  Logger.log("Creating SAFE for: " + INVESTOR_DATA.investorName);\n';
    script += '  Logger.log("SAFE Type: " + (SAFE_TEMPLATE_TYPE === "mfn" ? "MFN" : "Valuation Cap"));\n';
    script += '  \n';
    script += '  var venturesFolder;\n';
    script += '  try {\n';
    script += '    venturesFolder = DriveApp.getFolderById(VENTURES_FOLDER_ID);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access VENTURES folder with ID: " + VENTURES_FOLDER_ID);\n';
    script += '    Logger.log("Make sure the folder exists and you have edit access.");\n';
    script += '    throw new Error("Cannot access VENTURES folder. See logs for details.");\n';
    script += '  }\n';
    script += '  if (!venturesFolder) {\n';
    script += '    throw new Error("VENTURES folder not found. Check VENTURES_FOLDER_ID: " + VENTURES_FOLDER_ID);\n';
    script += '  }\n';
    script += '  \n';
    script += '  var ventureFolder = getOrCreateFolder(venturesFolder, VENTURE_NAME);\n';
    script += '  var safesFolder = getOrCreateFolder(ventureFolder, VENTURE_NAME + " - SAFE Agreements - Executed");\n';
    script += '  \n';
    script += '  // Check for existing\n';
    script += '  var existing = findExistingDoc(safesFolder, DOC_NAME);\n';
    script += '  if (existing && OVERWRITE_EXISTING) {\n';
    script += '    existing.setTrashed(true);\n';
    script += '    Logger.log("Replacing existing document");\n';
    script += '  } else if (existing) {\n';
    script += '    Logger.log("Document already exists - skipping");\n';
    script += '    return;\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Select template based on safeTemplate type\n';
    script += '  var templateId = SAFE_TEMPLATE_TYPE === "mfn" ? SAFE_TEMPLATE_MFN : SAFE_TEMPLATE_VALUATION_CAP;\n';
    script += '  if (templateId.indexOf("YOUR_") === 0) {\n';
    script += '    Logger.log("ERROR: Please update the template ID in the script");\n';
    script += '    return;\n';
    script += '  }\n';
    script += '  \n';
    script += '  var template;\n';
    script += '  try {\n';
    script += '    template = DriveApp.getFileById(templateId);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access SAFE template (ID: " + templateId + ")");\n';
    script += '    Logger.log("Error: " + e.message);\n';
    script += '    Logger.log("Make sure you have access to the TEMPLATES folder.");\n';
    script += '    throw new Error("Cannot access SAFE template. See logs for details.");\n';
    script += '  }\n';
    script += '  var copy = template.makeCopy(DOC_NAME, safesFolder);\n';
    script += '  \n';
    script += '  // Apply replacements\n';
    script += '  var doc = DocumentApp.openById(copy.getId());\n';
    script += '  var body = doc.getBody();\n';
    script += '  \n';
    script += '  // Company name (escape the period)\n';
    script += '  body.replaceText("Mechro, Inc\\\\.", VENTURE_NAME);\n';
    script += '  body.replaceText("MECHRO, INC\\\\.", VENTURE_NAME.toUpperCase());\n';
    script += '  body.replaceText("\\\\[COMPANY NAME\\\\]", VENTURE_NAME);\n';
    script += '  body.replaceText("\\\\[COMPANY\\\\]", VENTURE_NAME);\n';
    script += '  \n';
    script += '  // Officer and address\n';
    script += '  body.replaceText("Jacob Johnson", "' + (venture.incorporatorName || venture.initialDirectorName || '') + '");\n';
    script += '  body.replaceText("301 E Archer St\\\\., Tulsa, Oklahoma 74120", "' + (venture.principalOfficeAddress || '') + '");\n';
    script += '  \n';
    script += '  // Investor info\n';
    script += '  body.replaceText("\\\\[Investor Name\\\\]", INVESTOR_DATA.investorName);\n';
    script += '  body.replaceText("\\\\[INVESTOR NAME\\\\]", INVESTOR_DATA.investorName);\n';
    script += '  body.replaceText("\\\\[INVESTOR\\\\]", INVESTOR_DATA.investorName);\n';
    script += '  body.replaceText("\\\\[PURCHASER\\\\]", INVESTOR_DATA.investorName);\n';
    script += '  // MFN template specific investor placeholder\n';
    script += '  body.replaceText("Archer Pre-Seed II LLC", INVESTOR_DATA.investorName);\n';
    script += '  \n';
    script += '  // Amount (escape $ sign and handle various formats)\n';
    script += '  body.replaceText("\\\\$1,000,000", "$" + INVESTOR_DATA.amount);\n';
    script += '  body.replaceText("\\\\$\\\\[15,000\\\\]", "$" + INVESTOR_DATA.amount);\n';
    script += '  body.replaceText("\\\\[PURCHASE AMOUNT\\\\]", "$" + INVESTOR_DATA.amount);\n';
    script += '  body.replaceText("\\\\[AMOUNT\\\\]", "$" + INVESTOR_DATA.amount);\n';
    script += '  body.replaceText("\\\\[INVESTMENT AMOUNT\\\\]", "$" + INVESTOR_DATA.amount);\n';
    script += '  body.replaceText("\\\\[AMOUNT IN WORDS\\\\]", INVESTOR_DATA.amountWords + " dollars");\n';
    script += '  \n';
    script += '  // Valuation cap (escape $ sign and handle multiple defaults)\n';
    script += '  body.replaceText("\\\\$5,500,000", "$" + INVESTOR_DATA.valuationCap);\n';
    script += '  body.replaceText("\\\\$5,000,000", "$" + INVESTOR_DATA.valuationCap);\n';
    script += '  body.replaceText("\\\\$10,000,000", "$" + INVESTOR_DATA.valuationCap);\n';
    script += '  body.replaceText("\\\\[VALUATION CAP\\\\]", "$" + INVESTOR_DATA.valuationCap);\n';
    script += '  body.replaceText("\\\\[POST-MONEY VALUATION CAP\\\\]", "$" + INVESTOR_DATA.valuationCap);\n';
    script += '  body.replaceText("\\\\[CAP\\\\]", "$" + INVESTOR_DATA.valuationCap);\n';
    script += '  \n';
    script += '  body.replaceText("\\\\[DISCOUNT\\\\]", INVESTOR_DATA.discount + "%");\n';
    script += '  body.replaceText("\\\\[DISCOUNT RATE\\\\]", INVESTOR_DATA.discount + "%");\n';
    script += '  body.replaceText("\\\\[DATE\\\\]", INVESTOR_DATA.date);\n';
    script += '  body.replaceText("\\\\[EFFECTIVE DATE\\\\]", INVESTOR_DATA.date);\n';
    script += '  body.replaceText("\\\\[SIGNING DATE\\\\]", INVESTOR_DATA.date);\n';
    script += '  body.replaceText("December ___, 2025", INVESTOR_DATA.date);\n';
    script += '  body.replaceText("\\\\[___________\\\\]", INVESTOR_DATA.date);\n';
    script += '  \n';
    script += '  doc.saveAndClose();\n';
    script += '  Logger.log("SUCCESS! Created: " + DOC_NAME);\n';
    script += '  Logger.log("Location: " + safesFolder.getUrl());\n';
    script += '}\n';
    
    return script;
  };

  // Generate script for a single Employee Option document
  const generateSingleEmployeeScript = (venture, employee, overwrite = true) => {
    const name = venture.legalName || '';
    const employeeName = employee.employeeName || 'Employee';
    const grantType = employee.grantType || 'ISO';
    const optionAgreementType = employee.optionAgreementType || 'standard';
    // Document name matches UI exactly
    const docName = optionAgreementType === 'earlyExercise'
      ? 'Early Exercise Stock Option Agreement (' + grantType + ') - ' + employeeName
      : 'Stock Option Agreement (' + grantType + ') - ' + employeeName;
    
    let script = '/**\n';
    script += ' * INDIVIDUAL EMPLOYEE OPTION AGREEMENT GENERATOR\n';
    script += ' * Company: ' + name + '\n';
    script += ' * Employee: ' + employeeName + '\n';
    script += ' * Option Type: ' + (grantType === 'ISO' ? 'Incentive Stock Option' : 'Non-Qualified Stock Option') + '\n';
    script += ' * Agreement Type: ' + (optionAgreementType === 'earlyExercise' ? 'Early Exercise (83(b) eligible)' : 'Standard (exercise after vesting)') + '\n';
    script += ' * Shares: ' + (employee.shares || 0).toLocaleString() + '\n';
    script += ' * Exercise Price: $' + (employee.exercisePrice || 0).toFixed(4) + '\n';
    script += ' * Overwrite Mode: ' + (overwrite ? 'ON' : 'OFF') + '\n';
    script += ' */\n\n';
    
    script += 'var VENTURE_NAME = "' + name + '";\n';
    script += 'var VENTURES_FOLDER_ID = "1wq9rS06o9_tPkFWHnVIJn1wJ6JFuMHSR";\n';
    script += 'var DOC_NAME = "' + docName + '";\n';
    script += 'var OVERWRITE_EXISTING = ' + overwrite + ';\n\n';
    
    script += '// Option Agreement Template IDs\n';
    script += '// Standard options (exercise after vesting)\n';
    script += 'var OPTION_TEMPLATE_STANDARD_ISO = "1x89Y2Mg-iTaR_U-JCXlhkqINj4ROitzjTbf-iwsE9u8";\n';
    script += 'var OPTION_TEMPLATE_STANDARD_NSO = "1x89Y2Mg-iTaR_U-JCXlhkqINj4ROitzjTbf-iwsE9u8";\n';
    script += '// Early exercise options (83(b) eligible)\n';
    script += 'var OPTION_TEMPLATE_EARLY_EXERCISE_ISO = "1D5aRWWMPwhs4GquFPgUAik0Bebg7W8MZYlK4XAg0948";\n';
    script += 'var OPTION_TEMPLATE_EARLY_EXERCISE_NSO = "1D5aRWWMPwhs4GquFPgUAik0Bebg7W8MZYlK4XAg0948";\n\n';
    
    script += 'var EMPLOYEE_DATA = {\n';
    script += '  employeeName: "' + employeeName + '",\n';
    script += '  grantDate: "' + (employee.grantDate || '') + '",\n';
    script += '  shares: "' + (employee.shares || 0).toLocaleString() + '",\n';
    script += '  sharesWords: "' + numberToWords(employee.shares || 0) + '",\n';
    script += '  exercisePrice: "' + (employee.exercisePrice || 0).toFixed(4) + '",\n';
    script += '  vestingSchedule: "' + (employee.vestingSchedule || '') + '",\n';
    script += '  grantType: "' + grantType + '",\n';
    script += '  optionAgreementType: "' + optionAgreementType + '"\n';
    script += '};\n\n';
    
    script += 'function getOrCreateFolder(parent, folderName) {\n';
    script += '  if (!parent) {\n';
    script += '    throw new Error("Parent folder is undefined. Check that VENTURES_FOLDER_ID exists and you have access.");\n';
    script += '  }\n';
    script += '  var folders = parent.getFoldersByName(folderName);\n';
    script += '  return folders.hasNext() ? folders.next() : parent.createFolder(folderName);\n';
    script += '}\n\n';
    
    script += 'function findExistingDoc(folder, docName) {\n';
    script += '  var files = folder.getFilesByName(docName);\n';
    script += '  return files.hasNext() ? files.next() : null;\n';
    script += '}\n\n';
    
    script += 'function createOptionDocument() {\n';
    script += '  Logger.log("Creating Option Agreement for: " + EMPLOYEE_DATA.employeeName);\n';
    script += '  Logger.log("Type: " + EMPLOYEE_DATA.grantType + " - " + (EMPLOYEE_DATA.optionAgreementType === "earlyExercise" ? "Early Exercise" : "Standard"));\n';
    script += '  \n';
    script += '  var venturesFolder;\n';
    script += '  try {\n';
    script += '    venturesFolder = DriveApp.getFolderById(VENTURES_FOLDER_ID);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access VENTURES folder with ID: " + VENTURES_FOLDER_ID);\n';
    script += '    Logger.log("Make sure the folder exists and you have edit access.");\n';
    script += '    throw new Error("Cannot access VENTURES folder. See logs for details.");\n';
    script += '  }\n';
    script += '  if (!venturesFolder) {\n';
    script += '    throw new Error("VENTURES folder not found. Check VENTURES_FOLDER_ID: " + VENTURES_FOLDER_ID);\n';
    script += '  }\n';
    script += '  \n';
    script += '  var ventureFolder = getOrCreateFolder(venturesFolder, VENTURE_NAME);\n';
    script += '  var optionsFolder = getOrCreateFolder(ventureFolder, VENTURE_NAME + " - Employee Option Agreements - Executed");\n';
    script += '  \n';
    script += '  // Check for existing\n';
    script += '  var existing = findExistingDoc(optionsFolder, DOC_NAME);\n';
    script += '  if (existing && OVERWRITE_EXISTING) {\n';
    script += '    existing.setTrashed(true);\n';
    script += '    Logger.log("Replacing existing document");\n';
    script += '  } else if (existing) {\n';
    script += '    Logger.log("Document already exists - skipping");\n';
    script += '    return;\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Select template based on grant type AND agreement type\n';
    script += '  var templateId;\n';
    script += '  if (EMPLOYEE_DATA.optionAgreementType === "earlyExercise") {\n';
    script += '    templateId = EMPLOYEE_DATA.grantType === "ISO" ? OPTION_TEMPLATE_EARLY_EXERCISE_ISO : OPTION_TEMPLATE_EARLY_EXERCISE_NSO;\n';
    script += '  } else {\n';
    script += '    templateId = EMPLOYEE_DATA.grantType === "ISO" ? OPTION_TEMPLATE_STANDARD_ISO : OPTION_TEMPLATE_STANDARD_NSO;\n';
    script += '  }\n';
    script += '  if (templateId.indexOf("YOUR_") === 0) {\n';
    script += '    Logger.log("ERROR: Please update the template ID in the script");\n';
    script += '    return;\n';
    script += '  }\n';
    script += '  \n';
    script += '  var template;\n';
    script += '  try {\n';
    script += '    template = DriveApp.getFileById(templateId);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access Option template (ID: " + templateId + ")");\n';
    script += '    Logger.log("Error: " + e.message);\n';
    script += '    Logger.log("Make sure you have access to the TEMPLATES folder.");\n';
    script += '    throw new Error("Cannot access Option template. See logs for details.");\n';
    script += '  }\n';
    script += '  var copy = template.makeCopy(DOC_NAME, optionsFolder);\n';
    script += '  \n';
    script += '  // Apply replacements\n';
    script += '  var doc = DocumentApp.openById(copy.getId());\n';
    script += '  var body = doc.getBody();\n';
    script += '  \n';
    script += '  // Company name (escape the period)\n';
    script += '  body.replaceText("Mechro, Inc\\\\.", VENTURE_NAME);\n';
    script += '  body.replaceText("MECHRO, INC\\\\.", VENTURE_NAME.toUpperCase());\n';
    script += '  body.replaceText("\\\\[COMPANY NAME\\\\]", VENTURE_NAME);\n';
    script += '  body.replaceText("\\\\[COMPANY\\\\]", VENTURE_NAME);\n';
    script += '  \n';
    script += '  // Equity Plan reference - handle various formats\n';
    script += '  body.replaceText("2025 Equity Incentive Plan", "' + (venture.equityPlanYear || '2025') + ' Equity Incentive Plan");\n';
    script += '  body.replaceText("2025 EQUITY INCENTIVE PLAN", "' + (venture.equityPlanYear || '2025') + ' EQUITY INCENTIVE PLAN");\n';
    script += '  \n';
    script += '  // Par value replacement (escape $ and .)\n';
    script += '  body.replaceText("\\\\$0\\\\.00001", "$' + (venture.parValue || '0.00001') + '");\n';
    script += '  \n';
    script += '  // Employee info - bracket format\n';
    script += '  body.replaceText("\\\\[EMPLOYEE NAME\\\\]", EMPLOYEE_DATA.employeeName);\n';
    script += '  body.replaceText("\\\\[OPTIONEE\\\\]", EMPLOYEE_DATA.employeeName);\n';
    script += '  body.replaceText("\\\\[OPTIONEE NAME\\\\]", EMPLOYEE_DATA.employeeName);\n';
    script += '  body.replaceText("\\\\[PARTICIPANT\\\\]", EMPLOYEE_DATA.employeeName);\n';
    script += '  \n';
    script += '  // Template underscore placeholders for option agreements\n';
    script += '  body.replaceText("Optionee:\\\\s*_+", "Optionee: " + EMPLOYEE_DATA.employeeName);\n';
    script += '  \n';
    script += '  body.replaceText("\\\\[NUMBER OF SHARES\\\\]", EMPLOYEE_DATA.shares);\n';
    script += '  body.replaceText("\\\\[SHARES\\\\]", EMPLOYEE_DATA.shares);\n';
    script += '  body.replaceText("\\\\[SHARES IN WORDS\\\\]", EMPLOYEE_DATA.sharesWords);\n';
    script += '  \n';
    script += '  // Exercise price - multiple formats\n';
    script += '  body.replaceText("\\\\[EXERCISE PRICE\\\\]", "$" + EMPLOYEE_DATA.exercisePrice);\n';
    script += '  body.replaceText("\\\\[PRICE PER SHARE\\\\]", "$" + EMPLOYEE_DATA.exercisePrice);\n';
    script += '  body.replaceText("\\\\$____ per share", "$" + EMPLOYEE_DATA.exercisePrice + " per share");\n';
    script += '  body.replaceText("Exercise Price Per Share:\\\\s*\\\\$_+", "Exercise Price Per Share: $" + EMPLOYEE_DATA.exercisePrice);\n';
    script += '  \n';
    script += '  // Calculate total exercise value\n';
    script += '  var totalValue = (parseFloat(EMPLOYEE_DATA.shares.replace(/,/g, "")) * parseFloat(EMPLOYEE_DATA.exercisePrice)).toFixed(2);\n';
    script += '  body.replaceText("\\\\[TOTAL EXERCISE PRICE\\\\]", "$" + totalValue);\n';
    script += '  body.replaceText("\\\\[AGGREGATE EXERCISE PRICE\\\\]", "$" + totalValue);\n';
    script += '  \n';
    script += '  body.replaceText("\\\\[GRANT DATE\\\\]", EMPLOYEE_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[DATE OF GRANT\\\\]", EMPLOYEE_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[EFFECTIVE DATE\\\\]", EMPLOYEE_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[VESTING SCHEDULE\\\\]", EMPLOYEE_DATA.vestingSchedule);\n';
    script += '  body.replaceText("\\\\[VESTING COMMENCEMENT DATE\\\\]", EMPLOYEE_DATA.grantDate);\n';
    script += '  // Template underscore format for dates\n';
    script += '  body.replaceText("Date of Grant:\\\\s*_+", "Date of Grant: " + EMPLOYEE_DATA.grantDate);\n';
    script += '  body.replaceText("Vesting Start Date:\\\\s*_+", "Vesting Start Date: " + EMPLOYEE_DATA.grantDate);\n';
    script += '  body.replaceText("Maximum Number of Shares.*\\\\(the.*Shares.*\\\\).*:\\\\s*_+", "Maximum Number of Shares Subject to this Option (the \\"Shares\\"): " + EMPLOYEE_DATA.shares);\n';
    script += '  \n';
    script += '  body.replaceText("\\\\[GRANT TYPE\\\\]", EMPLOYEE_DATA.grantType);\n';
    script += '  body.replaceText("\\\\[TYPE OF OPTION\\\\]", EMPLOYEE_DATA.grantType === "ISO" ? "Incentive Stock Option" : "Non-Qualified Stock Option");\n';
    script += '  body.replaceText("\\\\[OPTION TYPE\\\\]", EMPLOYEE_DATA.grantType === "ISO" ? "Incentive Stock Option" : "Non-Qualified Stock Option");\n';
    script += '  \n';
    script += '  doc.saveAndClose();\n';
    script += '  Logger.log("SUCCESS! Created: " + DOC_NAME);\n';
    script += '  Logger.log("Location: " + optionsFolder.getUrl());\n';
    script += '}\n';
    
    return script;
  };

  // Generate script for a single Advisor Agreement document
  const generateSingleAdvisorScript = (venture, advisor, overwrite = true) => {
    const name = venture.legalName || '';
    const advisorName = advisor.advisorName || 'Advisor';
    const agreementType = advisor.agreementType || 'advisor';
    // Document name: VentureName - DocumentType - PersonName
    let docName;
    let agreementDescription;
    if (agreementType === 'consulting') {
      docName = name + ' - Consulting Agreement - ' + advisorName;
      agreementDescription = 'Consulting Agreement (Independent Contractor)';
    } else if (agreementType === 'ipStockPurchase') {
      docName = name + ' - Restricted Stock Purchase Agreement (IP Assignment) - ' + advisorName;
      agreementDescription = 'Restricted Stock Purchase for IP Assignment (83(b) election required)';
    } else {
      docName = name + ' - Advisor Agreement - ' + advisorName;
      agreementDescription = 'Strategic Advisor Agreement';
    }
    
    let script = '/**\n';
    script += ' * INDIVIDUAL ADVISOR/CONSULTANT AGREEMENT GENERATOR\n';
    script += ' * Company: ' + name + '\n';
    script += ' * Name: ' + advisorName + '\n';
    script += ' * Agreement Type: ' + agreementDescription + '\n';
    script += ' * Shares: ' + (advisor.shares || 0).toLocaleString() + '\n';
    script += ' * ' + (agreementType === 'ipStockPurchase' ? 'Purchase Price' : 'Exercise Price') + ': $' + (advisor.exercisePrice || 0).toFixed(4) + '\n';
    script += ' * Overwrite Mode: ' + (overwrite ? 'ON' : 'OFF') + '\n';
    script += ' */\n\n';
    
    script += 'var VENTURE_NAME = "' + name + '";\n';
    script += 'var VENTURES_FOLDER_ID = "1wq9rS06o9_tPkFWHnVIJn1wJ6JFuMHSR";\n';
    script += 'var DOC_NAME = "' + docName + '";\n';
    script += 'var OVERWRITE_EXISTING = ' + overwrite + ';\n\n';
    
    script += '// Agreement Template IDs\n';
    script += 'var TEMPLATE_ADVISOR = "1og2bZfpgSnZkpHStlqd5WkcJRk1Uxbz2OUJqX-d56sc";\n';
    script += 'var TEMPLATE_CONSULTING = "1cmIuwP4MG-QznfMz_h7Hb_tB-Z7crYa6mMN-Skz4VAk";\n';
    script += 'var TEMPLATE_IP_STOCK_PURCHASE = "1dLNVsW2MukPDwYVGmgPNg8426ugo6bHUMnYHUbdDcxs";\n';
    script += 'var AGREEMENT_TYPE = "' + agreementType + '"; // advisor, consulting, or ipStockPurchase\n\n';
    
    script += 'var ADVISOR_DATA = {\n';
    script += '  advisorName: "' + advisorName + '",\n';
    script += '  grantDate: "' + (advisor.grantDate || '') + '",\n';
    script += '  shares: "' + (advisor.shares || 0).toLocaleString() + '",\n';
    script += '  sharesWords: "' + numberToWords(advisor.shares || 0) + '",\n';
    script += '  exercisePrice: "' + (advisor.exercisePrice || 0).toFixed(4) + '",\n';
    script += '  vestingSchedule: "' + (advisor.vestingSchedule || '') + '",\n';
    script += '  agreementType: "' + agreementType + '"\n';
    script += '};\n\n';
    
    script += 'function getOrCreateFolder(parent, folderName) {\n';
    script += '  if (!parent) {\n';
    script += '    throw new Error("Parent folder is undefined. Check that VENTURES_FOLDER_ID exists and you have access.");\n';
    script += '  }\n';
    script += '  var folders = parent.getFoldersByName(folderName);\n';
    script += '  return folders.hasNext() ? folders.next() : parent.createFolder(folderName);\n';
    script += '}\n\n';
    
    script += 'function findExistingDoc(folder, docName) {\n';
    script += '  var files = folder.getFilesByName(docName);\n';
    script += '  return files.hasNext() ? files.next() : null;\n';
    script += '}\n\n';
    
    script += 'function createAdvisorDocument() {\n';
    script += '  Logger.log("Creating Agreement for: " + ADVISOR_DATA.advisorName);\n';
    script += '  Logger.log("Agreement Type: " + AGREEMENT_TYPE);\n';
    script += '  \n';
    script += '  var venturesFolder;\n';
    script += '  try {\n';
    script += '    venturesFolder = DriveApp.getFolderById(VENTURES_FOLDER_ID);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access VENTURES folder with ID: " + VENTURES_FOLDER_ID);\n';
    script += '    Logger.log("Make sure the folder exists and you have edit access.");\n';
    script += '    throw new Error("Cannot access VENTURES folder. See logs for details.");\n';
    script += '  }\n';
    script += '  if (!venturesFolder) {\n';
    script += '    throw new Error("VENTURES folder not found. Check VENTURES_FOLDER_ID: " + VENTURES_FOLDER_ID);\n';
    script += '  }\n';
    script += '  \n';
    script += '  var ventureFolder = getOrCreateFolder(venturesFolder, VENTURE_NAME);\n';
    script += '  var advisorsFolder = getOrCreateFolder(ventureFolder, VENTURE_NAME + " - Advisor and Consultant Agreements - Executed");\n';
    script += '  \n';
    script += '  // Check for existing\n';
    script += '  var existing = findExistingDoc(advisorsFolder, DOC_NAME);\n';
    script += '  if (existing && OVERWRITE_EXISTING) {\n';
    script += '    existing.setTrashed(true);\n';
    script += '    Logger.log("Replacing existing document");\n';
    script += '  } else if (existing) {\n';
    script += '    Logger.log("Document already exists - skipping");\n';
    script += '    return;\n';
    script += '  }\n';
    script += '  \n';
    script += '  // Select template based on agreement type\n';
    script += '  var templateId;\n';
    script += '  if (AGREEMENT_TYPE === "consulting") {\n';
    script += '    templateId = TEMPLATE_CONSULTING;\n';
    script += '  } else if (AGREEMENT_TYPE === "ipStockPurchase") {\n';
    script += '    templateId = TEMPLATE_IP_STOCK_PURCHASE;\n';
    script += '  } else {\n';
    script += '    templateId = TEMPLATE_ADVISOR;\n';
    script += '  }\n';
    script += '  if (templateId.indexOf("YOUR_") === 0) {\n';
    script += '    Logger.log("ERROR: Please update the template ID in the script");\n';
    script += '    return;\n';
    script += '  }\n';
    script += '  \n';
    script += '  var template;\n';
    script += '  try {\n';
    script += '    template = DriveApp.getFileById(templateId);\n';
    script += '  } catch (e) {\n';
    script += '    Logger.log("ERROR: Could not access Advisor template (ID: " + templateId + ")");\n';
    script += '    Logger.log("Error: " + e.message);\n';
    script += '    Logger.log("Make sure you have access to the TEMPLATES folder.");\n';
    script += '    throw new Error("Cannot access Advisor template. See logs for details.");\n';
    script += '  }\n';
    script += '  var copy = template.makeCopy(DOC_NAME, advisorsFolder);\n';
    script += '  \n';
    script += '  // Apply replacements\n';
    script += '  var doc = DocumentApp.openById(copy.getId());\n';
    script += '  var body = doc.getBody();\n';
    script += '  \n';
    script += '  // Company name (escape the period)\n';
    script += '  body.replaceText("Mechro, Inc\\\\.", VENTURE_NAME);\n';
    script += '  body.replaceText("MECHRO, INC\\\\.", VENTURE_NAME.toUpperCase());\n';
    script += '  body.replaceText("\\\\[COMPANY NAME\\\\]", VENTURE_NAME);\n';
    script += '  body.replaceText("\\\\[COMPANY\\\\]", VENTURE_NAME);\n';
    script += '  \n';
    script += '  // Advisor/Consultant info - bracket format\n';
    script += '  body.replaceText("\\\\[ADVISOR NAME\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[ADVISOR\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[CONSULTANT NAME\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[CONSULTANT\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[PURCHASER NAME\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[PURCHASER\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[SERVICE PROVIDER\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[CONTRACTOR\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  // Actual advisor agreement template uses these formats\n';
    script += '  body.replaceText("\\\\[Full Name\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[First Name\\\\]", ADVISOR_DATA.advisorName.split(" ")[0]);\n';
    script += '  // Consulting agreement header placeholders\n';
    script += '  body.replaceText("\\\\[CORPORATE CONSULTANT\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[INDIVIDUAL CONSULTANT\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  body.replaceText("\\\\[Contractor Name\\\\]", ADVISOR_DATA.advisorName);\n';
    script += '  \n';
    script += '  // Address replacements for consulting agreements\n';
    script += '  body.replaceText("301 E Archer St\\\\., Tulsa, Oklahoma 74120", "' + (venture.principalOfficeAddress || '') + '");\n';
    script += '  \n';
    script += '  // Share info\n';
    script += '  body.replaceText("\\\\[NUMBER OF SHARES\\\\]", ADVISOR_DATA.shares);\n';
    script += '  body.replaceText("\\\\[SHARES\\\\]", ADVISOR_DATA.shares);\n';
    script += '  body.replaceText("\\\\[SHARES IN WORDS\\\\]", ADVISOR_DATA.sharesWords);\n';
    script += '  body.replaceText("\\\\[TOTAL SHARES\\\\]", ADVISOR_DATA.shares);\n';
    script += '  body.replaceText("\\\\[EXERCISE PRICE\\\\]", "$" + ADVISOR_DATA.exercisePrice);\n';
    script += '  body.replaceText("\\\\[PURCHASE PRICE\\\\]", "$" + ADVISOR_DATA.exercisePrice);\n';
    script += '  body.replaceText("\\\\[PRICE PER SHARE\\\\]", "$" + ADVISOR_DATA.exercisePrice);\n';
    script += '  body.replaceText("\\\\[PER SHARE PRICE\\\\]", "$" + ADVISOR_DATA.exercisePrice);\n';
    script += '  \n';
    script += '  // Calculate total purchase/exercise value\n';
    script += '  var totalValue = (parseFloat(ADVISOR_DATA.shares.replace(/,/g, "")) * parseFloat(ADVISOR_DATA.exercisePrice)).toFixed(2);\n';
    script += '  body.replaceText("\\\\[TOTAL PURCHASE PRICE\\\\]", "$" + totalValue);\n';
    script += '  body.replaceText("\\\\[TOTAL EXERCISE PRICE\\\\]", "$" + totalValue);\n';
    script += '  body.replaceText("\\\\[AGGREGATE PURCHASE PRICE\\\\]", "$" + totalValue);\n';
    script += '  \n';
    script += '  body.replaceText("\\\\[GRANT DATE\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[EFFECTIVE DATE\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[DATE\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[SIGNING DATE\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  // Consulting agreement uses [*Date*] format\n';
    script += '  body.replaceText("\\\\[\\\\*Date\\\\*\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[Agreement Date\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  // Underscore date placeholders\n';
    script += '  body.replaceText("entered into as of _+", "entered into as of " + ADVISOR_DATA.grantDate);\n';
    script += '  body.replaceText("effective as of _+", "effective as of " + ADVISOR_DATA.grantDate);\n';
    script += '  body.replaceText("\\\\[VESTING SCHEDULE\\\\]", ADVISOR_DATA.vestingSchedule);\n';
    script += '  body.replaceText("\\\\[VESTING COMMENCEMENT DATE\\\\]", ADVISOR_DATA.grantDate);\n';
    script += '  \n';
    script += '  doc.saveAndClose();\n';
    script += '  Logger.log("SUCCESS! Created: " + DOC_NAME);\n';
    script += '  Logger.log("Location: " + advisorsFolder.getUrl());\n';
    if (agreementType === 'ipStockPurchase') {
      script += '  Logger.log("REMINDER: 83(b) election must be filed within 30 days of signing!");\n';
    }
    script += '}\n';
    
    return script;
  };

  const addVenture = async () => {
    if (!newVenture.legalName || !newVenture.foundedDate) {
      alert('Please fill in Legal Name and Founded Date');
      return;
    }
    const venture = { ...newVenture, id: Date.now().toString() };
    try {
      await window.storage.set('venture:' + venture.id, JSON.stringify(venture));
      setVentures([...ventures, venture]);
      setNewVenture({...defaultVenture});
      setShowNewVenture(false);
      // Mark as unsynced
      markUnsyncedChange();
    } catch { alert('Failed to save venture'); }
  };

  const updateVenture = async (updated) => {
    try {
      await window.storage.set('venture:' + updated.id, JSON.stringify(updated));
      setVentures(ventures.map(v => v.id === updated.id ? updated : v));
      setSelectedVenture(updated);
      // Mark as unsynced
      markUnsyncedChange();
    } catch { alert('Failed to update'); }
  };

  // Save paid-in capital inline from home page
  const savePaidInCapital = async (ventureId, value) => {
    setSavingPaidIn(prev => ({ ...prev, [ventureId]: true }));
    try {
      const venture = ventures.find(v => v.id === ventureId);
      if (!venture) return;
      
      const numValue = parseFloat(String(value).replace(/,/g, '')) || 0;
      const updated = {
        ...venture,
        paidInCapital: numValue,
        paidInCapitalUpdatedAt: new Date().toISOString()
      };
      
      await window.storage.set('venture:' + ventureId, JSON.stringify(updated));
      setVentures(ventures.map(v => v.id === ventureId ? updated : v));
      if (selectedVenture?.id === ventureId) setSelectedVenture(updated);
      
      // Clear the inline edit state for this venture
      setInlinePaidIn(prev => {
        const newState = { ...prev };
        delete newState[ventureId];
        return newState;
      });
    } catch { 
      alert('Failed to save paid-in capital'); 
    } finally {
      setSavingPaidIn(prev => ({ ...prev, [ventureId]: false }));
    }
  };

  const saveEditing = async () => {
    if (!editingVenture) return;
    await updateVenture(editingVenture);
    setIsEditing(false);
    setEditingVenture(null);
  };

  const executeDeleteVenture = async () => {
    if (!ventureToDelete || deleteConfirmText !== 'DELETE') return;
    try {
      const ventureId = ventureToDelete.id;
      await window.storage.delete('venture:' + ventureId);
      setVentures(ventures.filter(v => v.id !== ventureId));
      if (selectedVenture?.id === ventureId) setSelectedVenture(null);
      setShowDeleteConfirm(false);
      setVentureToDelete(null);
      setDeleteConfirmText('');
      // Mark as unsynced
      markUnsyncedChange();
    } catch { alert('Failed to delete'); }
  };

  // Add funding round
  const addFundingRound = async () => {
    if (!newFunding.investorName || !newFunding.date || newFunding.amount <= 0) {
      alert('Please fill in investor name, date, and amount');
      return;
    }
    const round = { ...newFunding, id: Date.now().toString() };
    const updated = {
      ...selectedVenture,
      fundingRounds: [...(selectedVenture.fundingRounds || []), round]
    };
    await updateVenture(updated);
    setNewFunding({...defaultFundingRound});
    setShowAddFunding(false);
  };

  // Delete funding round
  const deleteFundingRound = async (roundId) => {
    const updated = {
      ...selectedVenture,
      fundingRounds: (selectedVenture.fundingRounds || []).filter(r => r.id !== roundId)
    };
    await updateVenture(updated);
    setEntryDeleteConfirm(null);
    setEntryDeleteText('');
  };

  // Edit funding round
  const saveFundingEdit = async () => {
    if (!editingFunding) return;
    const updated = {
      ...selectedVenture,
      fundingRounds: (selectedVenture.fundingRounds || []).map(r => 
        r.id === editingFunding.id ? editingFunding : r
      )
    };
    await updateVenture(updated);
    setEditingFunding(null);
  };

  // Add employee grant
  const addEmployeeGrant = async () => {
    if (!newEmployee.employeeName || !newEmployee.grantDate || newEmployee.shares <= 0) {
      alert('Please fill in employee name, grant date, and shares');
      return;
    }
    const grant = { ...newEmployee, id: Date.now().toString() };
    const updated = {
      ...selectedVenture,
      employeeGrants: [...(selectedVenture.employeeGrants || []), grant]
    };
    await updateVenture(updated);
    setNewEmployee({...defaultEmployeeGrant});
    setShowAddEmployee(false);
  };

  // Delete employee grant
  const deleteEmployeeGrant = async (grantId) => {
    const updated = {
      ...selectedVenture,
      employeeGrants: (selectedVenture.employeeGrants || []).filter(g => g.id !== grantId)
    };
    await updateVenture(updated);
    setEntryDeleteConfirm(null);
    setEntryDeleteText('');
  };

  // Edit employee grant
  const saveEmployeeEdit = async () => {
    if (!editingEmployee) return;
    const updated = {
      ...selectedVenture,
      employeeGrants: (selectedVenture.employeeGrants || []).map(g => 
        g.id === editingEmployee.id ? editingEmployee : g
      )
    };
    await updateVenture(updated);
    setEditingEmployee(null);
  };

  // Add advisor grant
  const addAdvisorGrant = async () => {
    if (!newAdvisor.advisorName || !newAdvisor.grantDate || newAdvisor.shares <= 0) {
      alert('Please fill in advisor name, grant date, and shares');
      return;
    }
    const grant = { ...newAdvisor, id: Date.now().toString() };
    const updated = {
      ...selectedVenture,
      advisorGrants: [...(selectedVenture.advisorGrants || []), grant]
    };
    await updateVenture(updated);
    setNewAdvisor({...defaultAdvisorGrant});
    setShowAddAdvisor(false);
  };

  // Delete advisor grant
  const deleteAdvisorGrant = async (grantId) => {
    const updated = {
      ...selectedVenture,
      advisorGrants: (selectedVenture.advisorGrants || []).filter(g => g.id !== grantId)
    };
    await updateVenture(updated);
    setEntryDeleteConfirm(null);
    setEntryDeleteText('');
  };

  // Edit advisor grant
  const saveAdvisorEdit = async () => {
    if (!editingAdvisor) return;
    const updated = {
      ...selectedVenture,
      advisorGrants: (selectedVenture.advisorGrants || []).map(g => 
        g.id === editingAdvisor.id ? editingAdvisor : g
      )
    };
    await updateVenture(updated);
    setEditingAdvisor(null);
  };

  const calculateEquity = (v) => {
    const founderShares = (v.founderCommonShares || 0) + (v.founderFFPreferredShares || 0);
    const employeeShares = (v.employeeGrants || []).reduce((sum, g) => sum + (g.shares || 0), 0);
    const advisorShares = (v.advisorGrants || []).reduce((sum, g) => sum + (g.shares || 0), 0);
    
    // Priced round investor shares
    const pricedRoundShares = (v.fundingRounds || [])
      .filter(r => r.type === 'Priced Round')
      .reduce((sum, r) => sum + (r.sharesIssued || 0), 0);
    
    // Base outstanding shares (before SAFE conversion)
    const baseOutstanding = founderShares + employeeShares + advisorShares + pricedRoundShares;
    
    // Calculate SAFE implied ownership
    // Post-money SAFEs: ownership % = investment / valuation cap
    // Pre-money SAFEs: ownership % = investment / (valuation cap + investment)
    const safes = (v.fundingRounds || []).filter(r => r.type === 'SAFE');
    let totalSafeOwnership = 0;
    const safeDetails = safes.map(safe => {
      const amount = safe.amount || 0;
      const cap = safe.valuationCap || 0;
      const discount = safe.discount || 0;
      const isPostMoney = safe.valuationType !== 'Pre-Money';
      
      let ownershipPct = 0;
      if (cap > 0) {
        if (isPostMoney) {
          // Post-money SAFE: ownership = investment / post-money cap
          ownershipPct = (amount / cap) * 100;
        } else {
          // Pre-money SAFE: ownership = investment / (pre-money cap + investment)
          ownershipPct = (amount / (cap + amount)) * 100;
        }
      }
      // Note: discount-only SAFEs convert at next round price minus discount
      // We can't calculate until there's a priced round, so we show 0% for now
      
      totalSafeOwnership += ownershipPct;
      return { ...safe, impliedOwnership: ownershipPct };
    });
    
    // Calculate priced round implied ownership
    const pricedRounds = (v.fundingRounds || []).filter(r => r.type === 'Priced Round');
    let totalPricedOwnership = 0;
    const pricedDetails = pricedRounds.map(round => {
      const amount = round.amount || 0;
      const valuation = round.valuation || 0;
      const isPostMoney = round.valuationType !== 'Pre-Money';
      
      let ownershipPct = 0;
      if (valuation > 0) {
        if (isPostMoney) {
          // Post-money: ownership = investment / post-money valuation
          ownershipPct = (amount / valuation) * 100;
        } else {
          // Pre-money: ownership = investment / (pre-money + investment)
          ownershipPct = (amount / (valuation + amount)) * 100;
        }
      } else if (round.sharesIssued > 0 && baseOutstanding > 0) {
        // Fallback: calculate from shares if valuation not provided
        const totalAfterRound = baseOutstanding + round.sharesIssued;
        ownershipPct = (round.sharesIssued / totalAfterRound) * 100;
      }
      
      totalPricedOwnership += ownershipPct;
      return { ...round, impliedOwnership: ownershipPct };
    });
    
    // Total investor ownership (SAFEs + Priced Rounds)
    const totalInvestorOwnership = totalSafeOwnership + totalPricedOwnership;
    
    // Calculate ownership percentages on fully-diluted basis
    // Fully diluted assumes all SAFEs convert at their cap
    const totalOwnershipClaimed = totalInvestorOwnership;
    const remainingOwnership = Math.max(0, 100 - totalOwnershipClaimed);
    
    // Distribute remaining ownership among founder, employees, advisors proportionally
    const nonInvestorShares = founderShares + employeeShares + advisorShares;
    
    let founderOwnership, employeeOwnership, advisorOwnership;
    if (nonInvestorShares > 0 && totalOwnershipClaimed < 100) {
      const founderRatio = founderShares / nonInvestorShares;
      const employeeRatio = employeeShares / nonInvestorShares;
      const advisorRatio = advisorShares / nonInvestorShares;
      
      founderOwnership = (founderRatio * remainingOwnership).toFixed(1);
      employeeOwnership = (employeeRatio * remainingOwnership).toFixed(1);
      advisorOwnership = (advisorRatio * remainingOwnership).toFixed(1);
    } else if (totalOwnershipClaimed >= 100) {
      founderOwnership = '0.0';
      employeeOwnership = '0.0';
      advisorOwnership = '0.0';
    } else {
      founderOwnership = '100.0';
      employeeOwnership = '0.0';
      advisorOwnership = '0.0';
    }
    
    // Total raised
    const totalRaised = (v.fundingRounds || []).reduce((sum, r) => sum + (r.amount || 0), 0);
    
    // Latest valuation - from most recent funding round (last added)
    // For post-money SAFEs, the valuation cap IS the post-money valuation
    const allRounds = v.fundingRounds || [];
    let latestValuation = 0;
    let latestRoundType = null;
    if (allRounds.length > 0) {
      const latestRound = allRounds[allRounds.length - 1]; // Most recent = last added
      if (latestRound.type === 'SAFE') {
        // For SAFEs, the valuation cap IS the post-money valuation
        latestValuation = latestRound.valuationCap || 0;
        latestRoundType = 'SAFE';
      } else {
        // For priced rounds, calculate post-money valuation
        const val = latestRound.valuation || 0;
        const amt = latestRound.amount || 0;
        const isPost = latestRound.valuationType !== 'Pre-Money';
        latestValuation = isPost ? val : val + amt;
        latestRoundType = 'Priced';
      }
    }
    
    // Option pool calculations
    const optionPoolTotal = v.optionPoolShares || 0;
    const optionPoolUsed = employeeShares + advisorShares;
    const optionPoolAvailable = Math.max(0, optionPoolTotal - optionPoolUsed);
    
    // Equity given up = total investor ownership
    const totalEquityGivenUp = totalInvestorOwnership.toFixed(1);
    const equityToInvestors = totalInvestorOwnership.toFixed(1);
    const equityToSafes = totalSafeOwnership.toFixed(1);
    const equityToPriced = totalPricedOwnership.toFixed(1);
    const equityToEmployees = employeeOwnership;
    const equityToAdvisors = advisorOwnership;
    
    return { 
      founderShares, employeeShares, advisorShares, 
      founderCommonShares: v.founderCommonShares || 0,
      founderFFPreferredShares: v.founderFFPreferredShares || 0,
      totalOutstanding: baseOutstanding,
      founderOwnership, 
      totalRaised, 
      latestValuation,
      latestRoundType,
      sharesRemaining: (v.totalSharesAuthorized || 0) - baseOutstanding,
      optionPoolTotal, optionPoolUsed, optionPoolAvailable,
      equityToInvestors, equityToSafes, equityToPriced,
      equityToEmployees, equityToAdvisors, totalEquityGivenUp,
      safeDetails, pricedDetails,
      totalSafeOwnership, totalPricedOwnership
    };
  };

  const totalInvested = ventures.reduce((sum, v) => sum + (v.fundingRounds || []).reduce((s, r) => s + (r.amount || 0), 0), 0);

  // TVPI Calculations - uses calculated values from funding rounds and equity
  const calculateVentureTVPI = (venture) => {
    const paidIn = venture.paidInCapital || 0;
    if (paidIn <= 0) return null; // Return null if no capital paid in
    
    const equity = calculateEquity(venture);
    const valuation = equity.latestValuation || 0;
    const equityPct = parseFloat(equity.founderOwnership || 0) / 100;
    
    const currentValue = valuation * equityPct;
    return currentValue / paidIn;
  };

  const calculateVentureCurrentValue = (venture) => {
    const equity = calculateEquity(venture);
    const valuation = equity.latestValuation || 0;
    const equityPct = parseFloat(equity.founderOwnership || 0) / 100;
    return valuation * equityPct;
  };

  // Get derived TVPI data for a venture
  const getVentureTVPIData = (venture) => {
    const equity = calculateEquity(venture);
    return {
      latestValuation: equity.latestValuation || 0,
      equityPercentage: parseFloat(equity.founderOwnership || 0),
      currentValue: (equity.latestValuation || 0) * (parseFloat(equity.founderOwnership || 0) / 100)
    };
  };

  // Overall fund TVPI (includes non-venture studio costs)
  const venturePaidInCapital = ventures.reduce((sum, v) => sum + (v.paidInCapital || 0), 0);
  const totalPaidInCapital = venturePaidInCapital + (nonVentureStudioCost || 0);
  const totalCurrentValue = ventures.reduce((sum, v) => sum + calculateVentureCurrentValue(v), 0);
  const overallTVPI = totalPaidInCapital > 0 ? totalCurrentValue / totalPaidInCapital : null;

  // VENTURE DETAIL VIEW
  if (selectedVenture) {
    const equity = calculateEquity(selectedVenture);
    
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
        {/* Toast Notification */}
        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
        
        {/* Sticky Navigation Bar */}
        <div className="bg-white border-b shadow-sm sticky top-0 z-40">
          <div className="max-w-6xl mx-auto px-6 py-3 flex justify-between items-center">
            <button 
              onClick={() => setSelectedVenture(null)} 
              className="flex items-center gap-2 text-slate-600 hover:text-slate-900 transition-colors group"
            >
              <ArrowLeft className="w-4 h-4 group-hover:-translate-x-1 transition-transform" /> 
              <span className="text-sm font-medium">All Ventures</span>
            </button>
            <div className="flex items-center gap-2">
              <button 
                onClick={() => { setEditingVenture({...selectedVenture}); setIsEditing(true); }} 
                className="px-3 py-1.5 text-slate-600 hover:bg-slate-100 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5"
              >
                <Pencil className="w-3.5 h-3.5" /> Edit
              </button>
              <button 
                onClick={() => { setVentureToDelete(selectedVenture); setDeleteConfirmText(''); setShowDeleteConfirm(true); }} 
                className="px-3 py-1.5 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5"
              >
                <Trash2 className="w-3.5 h-3.5" /> Delete
              </button>
            </div>
          </div>
        </div>

        <div className="max-w-6xl mx-auto p-6">
          {/* Company Header Card - Simplified */}
          <div className="bg-white rounded-2xl border shadow-sm p-6 mb-6">
            <div className="flex items-center gap-5">
              <div className="p-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg">
                <Building2 className="w-10 h-10 text-white" />
              </div>
              <div className="flex-1">
                <div className="flex items-center gap-3">
                  <h1 className="text-2xl font-bold text-slate-900">{selectedVenture.legalName}</h1>
                  <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                    selectedVenture.status === 'Active' ? 'bg-emerald-100 text-emerald-700' :
                    selectedVenture.status === 'Acquired' ? 'bg-blue-100 text-blue-700' :
                    selectedVenture.status === 'Closed' ? 'bg-slate-100 text-slate-600' :
                    'bg-amber-100 text-amber-700'
                  }`}>{selectedVenture.status || 'Active'}</span>
                </div>
                <p className="text-slate-500 mt-1">{selectedVenture.state} Corporation • Founded {selectedVenture.foundedDate}</p>
              </div>
              <a 
                href={selectedVenture.driveFolderUrl || "https://drive.google.com/drive/folders/1wq9rS06o9_tPkFWHnVIJn1wJ6JFuMHSR"}
                target="_blank"
                rel="noopener noreferrer"
                className="px-4 py-2 border border-slate-200 rounded-lg text-sm text-slate-600 hover:bg-slate-50 flex items-center gap-2 transition-colors"
              >
                <FolderOpen className="w-4 h-4" />
                Google Drive
              </a>
            </div>
          </div>

          {/* Equity & Investment Dashboard */}
          <div className="bg-gradient-to-r from-slate-800 via-slate-900 to-slate-800 rounded-2xl p-6 mb-6 text-white shadow-xl">
            <div className="flex items-center justify-between mb-5">
              <h2 className="text-lg font-semibold flex items-center gap-2">
                <PieChart className="w-5 h-5 text-blue-400" /> 
                Equity & Investment Summary
              </h2>
              <div className="text-xs text-slate-400">Fully diluted basis</div>
            </div>
            
            {/* Key Metrics Row */}
            <div className="grid grid-cols-5 gap-4 mb-5">
              <div className="bg-white/10 rounded-xl p-4 backdrop-blur">
                <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">Our Ownership</div>
                <div className="text-2xl font-bold text-white">{equity.founderOwnership}%</div>
              </div>
              <div className="bg-white/10 rounded-xl p-4 backdrop-blur">
                <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">Post-Money Val</div>
                <div className="text-2xl font-bold text-white">{equity.latestValuation > 0 ? '$' + (equity.latestValuation / 1000000).toFixed(1) + 'M' : '—'}</div>
              </div>
              <div className="bg-white/10 rounded-xl p-4 backdrop-blur">
                <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">Total Raised</div>
                <div className="text-2xl font-bold text-emerald-400">${(equity.totalRaised / 1000000).toFixed(2)}M</div>
              </div>
              <div className="bg-white/10 rounded-xl p-4 backdrop-blur">
                <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">Paid-In Capital</div>
                <div className="text-2xl font-bold text-white">${((selectedVenture.paidInCapital || 0) / 1000).toFixed(0)}K</div>
              </div>
              <div className="bg-white/10 rounded-xl p-4 backdrop-blur">
                <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">TVPI</div>
                <div className={`text-2xl font-bold ${calculateVentureTVPI(selectedVenture) !== null && calculateVentureTVPI(selectedVenture) >= 1 ? 'text-emerald-400' : calculateVentureTVPI(selectedVenture) !== null ? 'text-red-400' : 'text-white'}`}>
                  {calculateVentureTVPI(selectedVenture) !== null ? calculateVentureTVPI(selectedVenture).toFixed(2) + 'x' : '—'}
                </div>
              </div>
            </div>
            
            {/* Ownership Breakdown */}
            <div className="grid grid-cols-5 gap-4 pt-4 border-t border-white/10">
              <div><div className="text-slate-500 text-xs">To Investors</div><div className="text-lg font-semibold">{equity.equityToInvestors}%</div></div>
              <div><div className="text-slate-500 text-xs">Via SAFEs</div><div className="text-lg font-semibold">{equity.equityToSafes}%</div></div>
              <div><div className="text-slate-500 text-xs">Via Priced</div><div className="text-lg font-semibold">{equity.equityToPriced}%</div></div>
              <div><div className="text-slate-500 text-xs">To Employees</div><div className="text-lg font-semibold">{equity.equityToEmployees}%</div></div>
              <div><div className="text-slate-500 text-xs">To Advisors</div><div className="text-lg font-semibold">{equity.equityToAdvisors}%</div></div>
            </div>
          </div>

          {/* People Sections */}
          <div className="space-y-4 mb-6">
            {/* Funding Rounds */}
            <CollapsibleSection 
              title="SAFE Investors & Funding Rounds" 
              icon={DollarSign} 
              iconColor="green" 
              badge={(selectedVenture.fundingRounds || []).length > 0 ? `${(selectedVenture.fundingRounds || []).length}` : null}
              action={
                <button onClick={() => setShowAddFunding(true)} className="px-3 py-1.5 bg-green-600 text-white rounded-lg flex items-center gap-1 text-sm hover:bg-green-700 transition-colors">
                  <Plus className="w-4 h-4" /> Add
                </button>
              }
            >
              {(selectedVenture.fundingRounds || []).length === 0 ? (
                <EmptyState
                  icon={DollarSign}
                  iconColor="green"
                  title="No funding rounds yet"
                  description="Record SAFE agreements or priced equity rounds to track investor ownership."
                  action={() => setShowAddFunding(true)}
                  actionLabel="Add First Round"
                />
              ) : (
                <div className="space-y-3 mt-4">
                  {(selectedVenture.fundingRounds || []).map(round => {
                    const detail = round.type === 'SAFE' 
                      ? (equity.safeDetails || []).find(d => d.id === round.id)
                      : (equity.pricedDetails || []).find(d => d.id === round.id);
                    const impliedOwnership = detail?.impliedOwnership || 0;
                    
                    return (
                      <div key={round.id} className="p-4 bg-slate-50 rounded-xl border hover:bg-slate-100 transition-colors">
                        <div className="flex items-center justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="font-semibold text-slate-900">{round.investorName}</span>
                              <span className={`px-2 py-0.5 rounded text-xs font-medium ${round.type === 'SAFE' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`}>
                                {round.type}
                              </span>
                              {round.type === 'SAFE' && (
                                <span className={`text-xs px-2 py-0.5 rounded ${round.safeTemplate === 'mfn' ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700'}`}>
                                  {round.safeTemplate === 'mfn' ? 'MFN' : 'Val Cap'}
                                </span>
                              )}
                            </div>
                            <div className="text-sm text-slate-500 mt-0.5">{round.date}</div>
                          </div>
                          <div className="flex items-center gap-4">
                            <div className="text-right">
                              <div className="font-semibold text-slate-900">${(round.amount || 0).toLocaleString()}</div>
                              {impliedOwnership > 0 && <div className="text-sm text-blue-600">{impliedOwnership.toFixed(2)}%</div>}
                            </div>
                            <div className="flex gap-1">
                              {round.type === 'SAFE' && (
                                <button 
                                  onClick={() => {
                                    setIndividualDocType('safe');
                                    setIndividualDocData(round);
                                    setIndividualOverwrite(true);
                                    setShowIndividualGenerate(true);
                                  }}
                                  className="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg"
                                  title="Generate SAFE"
                                >
                                  <FileOutput className="w-4 h-4" />
                                </button>
                              )}
                              <button onClick={() => setEditingFunding({...round})} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg">
                                <Pencil className="w-4 h-4" />
                              </button>
                              <button onClick={() => setEntryDeleteConfirm({ type: 'funding', id: round.id, name: round.investorName })} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg">
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </CollapsibleSection>

            {/* Employee Grants */}
            <CollapsibleSection 
              title="Employee Option Grants" 
              icon={Users} 
              iconColor="purple" 
              badge={(selectedVenture.employeeGrants || []).length > 0 ? `${(selectedVenture.employeeGrants || []).length}` : null}
              action={
                <button onClick={() => setShowAddEmployee(true)} className="px-3 py-1.5 bg-purple-600 text-white rounded-lg flex items-center gap-1 text-sm hover:bg-purple-700 transition-colors">
                  <Plus className="w-4 h-4" /> Add
                </button>
              }
            >
              {(selectedVenture.employeeGrants || []).length === 0 ? (
                <EmptyState
                  icon={Users}
                  iconColor="purple"
                  title="No employee grants yet"
                  description="Issue stock options to employees under your equity plan."
                  action={() => setShowAddEmployee(true)}
                  actionLabel="Add First Grant"
                />
              ) : (
                <div className="space-y-3 mt-4">
                  {(selectedVenture.employeeGrants || []).map(grant => (
                    <div key={grant.id} className="p-4 bg-slate-50 rounded-xl border hover:bg-slate-100 transition-colors">
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-slate-900">{grant.employeeName}</span>
                            <span className={`px-2 py-0.5 rounded text-xs font-medium ${grant.grantType === 'ISO' ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-700'}`}>
                              {grant.grantType}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded ${grant.optionAgreementType === 'earlyExercise' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}`}>
                              {grant.optionAgreementType === 'earlyExercise' ? 'Early Exercise' : 'Standard'}
                            </span>
                          </div>
                          <div className="text-sm text-slate-500 mt-0.5">{grant.grantDate} • {grant.vestingSchedule}</div>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-right">
                            <div className="font-semibold text-slate-900">{(grant.shares || 0).toLocaleString()} shares</div>
                            <div className="text-sm text-slate-500">${grant.exercisePrice?.toFixed(4)}/share</div>
                          </div>
                          <div className="flex gap-1">
                            <button 
                              onClick={() => {
                                setIndividualDocType('employee');
                                setIndividualDocData(grant);
                                setIndividualOverwrite(true);
                                setShowIndividualGenerate(true);
                              }}
                              className="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg"
                            >
                              <FileOutput className="w-4 h-4" />
                            </button>
                            <button onClick={() => setEditingEmployee({...grant})} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg">
                              <Pencil className="w-4 h-4" />
                            </button>
                            <button onClick={() => setEntryDeleteConfirm({ type: 'employee', id: grant.id, name: grant.employeeName })} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CollapsibleSection>

            {/* Advisors */}
            <CollapsibleSection 
              title="Advisors & Consultants" 
              icon={UserCheck} 
              iconColor="orange" 
              badge={(selectedVenture.advisorGrants || []).length > 0 ? `${(selectedVenture.advisorGrants || []).length}` : null}
              action={
                <button onClick={() => setShowAddAdvisor(true)} className="px-3 py-1.5 bg-orange-600 text-white rounded-lg flex items-center gap-1 text-sm hover:bg-orange-700 transition-colors">
                  <Plus className="w-4 h-4" /> Add
                </button>
              }
            >
              {(selectedVenture.advisorGrants || []).length === 0 ? (
                <EmptyState
                  icon={UserCheck}
                  iconColor="orange"
                  title="No advisors or consultants yet"
                  description="Add advisory agreements, consulting contracts, or IP assignments."
                  action={() => setShowAddAdvisor(true)}
                  actionLabel="Add First Advisor"
                />
              ) : (
                <div className="space-y-3 mt-4">
                  {(selectedVenture.advisorGrants || []).map(grant => (
                    <div key={grant.id} className="p-4 bg-slate-50 rounded-xl border hover:bg-slate-100 transition-colors">
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-slate-900">{grant.advisorName}</span>
                            <span className={`text-xs px-2 py-0.5 rounded ${
                              grant.agreementType === 'consulting' ? 'bg-blue-100 text-blue-700' :
                              grant.agreementType === 'ipStockPurchase' ? 'bg-purple-100 text-purple-700' :
                              'bg-orange-100 text-orange-700'
                            }`}>
                              {grant.agreementType === 'consulting' ? 'Consulting' :
                               grant.agreementType === 'ipStockPurchase' ? 'IP Stock Purchase' :
                               'Advisor'}
                            </span>
                          </div>
                          <div className="text-sm text-slate-500 mt-0.5">{grant.grantDate} • {grant.vestingSchedule}</div>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-right">
                            <div className="font-semibold text-slate-900">{(grant.shares || 0).toLocaleString()} shares</div>
                            <div className="text-sm text-slate-500">${grant.exercisePrice?.toFixed(4)}/share</div>
                          </div>
                          <div className="flex gap-1">
                            <button 
                              onClick={() => {
                                setIndividualDocType('advisor');
                                setIndividualDocData(grant);
                                setIndividualOverwrite(true);
                                setShowIndividualGenerate(true);
                              }}
                              className="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg"
                            >
                              <FileOutput className="w-4 h-4" />
                            </button>
                            <button onClick={() => setEditingAdvisor({...grant})} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg">
                              <Pencil className="w-4 h-4" />
                            </button>
                            <button onClick={() => setEntryDeleteConfirm({ type: 'advisor', id: grant.id, name: grant.advisorName })} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CollapsibleSection>
          </div>

          {/* Company Details - Compact Grid */}
          <div className="grid grid-cols-4 gap-4 mb-6">
            <div className="bg-white p-4 rounded-xl border">
              <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Share Structure</div>
              <div className="space-y-1 text-sm">
                <div className="flex justify-between"><span className="text-slate-500">Authorized</span><span className="font-medium">{(selectedVenture.totalSharesAuthorized || 0).toLocaleString()}</span></div>
                <div className="flex justify-between"><span className="text-slate-500">Par Value</span><span className="font-medium">${selectedVenture.parValue}</span></div>
              </div>
            </div>
            <div className="bg-white p-4 rounded-xl border">
              <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Founder Stock</div>
              <div className="space-y-1 text-sm">
                <div className="flex justify-between"><span className="text-slate-500">Common</span><span className="font-medium">{(selectedVenture.founderCommonShares || 0).toLocaleString()}</span></div>
                <div className="flex justify-between"><span className="text-slate-500">FF Preferred</span><span className="font-medium">{(selectedVenture.founderFFPreferredShares || 0).toLocaleString()}</span></div>
              </div>
            </div>
            <div className="bg-white p-4 rounded-xl border">
              <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Option Pool</div>
              <div className="space-y-1 text-sm">
                <div className="flex justify-between"><span className="text-slate-500">Total</span><span className="font-medium">{(selectedVenture.optionPoolShares || 0).toLocaleString()}</span></div>
                <div className="flex justify-between"><span className="text-slate-500">Available</span><span className="font-medium text-emerald-600">{equity.optionPoolAvailable.toLocaleString()}</span></div>
              </div>
            </div>
            <div className="bg-white p-4 rounded-xl border">
              <div className="text-xs text-slate-500 uppercase tracking-wide mb-2">Officers</div>
              <div className="space-y-1 text-sm">
                <div className="flex justify-between"><span className="text-slate-500">Director</span><span className="font-medium truncate ml-2">{selectedVenture.initialDirectorName || '—'}</span></div>
                <div className="flex justify-between"><span className="text-slate-500">Incorporator</span><span className="font-medium truncate ml-2">{selectedVenture.incorporatorName || '—'}</span></div>
              </div>
            </div>
          </div>

          {/* Generate Documents CTA */}
          <div className="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-6 text-white shadow-xl mb-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-white/20 rounded-xl backdrop-blur">
                  <FileOutput className="w-8 h-8" />
                </div>
                <div>
                  <h3 className="text-xl font-bold">Generate Legal Documents</h3>
                  <p className="text-emerald-100 mt-1">Formation docs, SAFEs, option agreements — pre-filled with your data</p>
                </div>
              </div>
              <button 
                onClick={() => { 
                  setVentureToGenerate(selectedVenture);
                  setShowScriptSection(false);
                  setShowGeneratePrompt(true);
                }} 
                className="px-6 py-3 bg-white text-emerald-700 rounded-xl font-semibold hover:bg-emerald-50 transition-colors flex items-center gap-2 shadow-lg"
              >
                <Zap className="w-5 h-5" /> 
                Generate
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>

          {/* Document Generation Audit Log */}
          <div className="bg-white rounded-xl border shadow-sm">
            <button 
              onClick={() => setAuditLogExpanded(!auditLogExpanded)}
              className="w-full p-4 flex items-center justify-between text-left hover:bg-slate-50 transition-colors rounded-xl"
            >
              <div className="flex items-center gap-3">
                <div className="p-2 bg-slate-100 rounded-lg">
                  <Clock className="w-4 h-4 text-slate-600" />
                </div>
                <div>
                  <span className="font-medium text-slate-700">Document Generation History</span>
                  <span className="text-xs text-slate-500 ml-2">
                    {(selectedVenture.documentAuditLog || []).length} entr{(selectedVenture.documentAuditLog || []).length !== 1 ? 'ies' : 'y'}
                  </span>
                </div>
              </div>
              <ChevronDown className={`w-5 h-5 text-slate-400 transition-transform ${auditLogExpanded ? 'rotate-180' : ''}`} />
            </button>
            
            {auditLogExpanded && (
              <div className="border-t px-4 pb-4">
                {(selectedVenture.documentAuditLog || []).length === 0 ? (
                  <div className="py-8 text-center text-slate-500">
                    <Clock className="w-8 h-8 mx-auto mb-2 opacity-30" />
                    <p className="text-sm">No documents generated yet</p>
                    <p className="text-xs text-slate-400 mt-1">Click "Copy Script to Clipboard" to log document generation</p>
                  </div>
                ) : (
                  <div className="mt-4 space-y-4 max-h-[600px] overflow-y-auto">
                    {(selectedVenture.documentAuditLog || []).slice().reverse().map((entry, idx) => {
                      // Handle both old format (single fileName) and new format (documentsGenerated array)
                      const isNewFormat = entry.documentsGenerated && Array.isArray(entry.documentsGenerated);
                      const timestamp = new Date(entry.generatedAt).toLocaleString('en-US', {
                        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
                        hour: 'numeric', minute: '2-digit', hour12: true
                      });
                      
                      if (isNewFormat) {
                        // New batch format - show ALL documents
                        return (
                          <div key={idx} className="border rounded-xl overflow-hidden">
                            {/* Header */}
                            <div className="bg-gradient-to-r from-slate-100 to-slate-50 p-4 border-b">
                              <div className="flex items-center justify-between mb-2">
                                <div className="flex items-center gap-3">
                                  <div className="p-2 bg-emerald-100 rounded-lg">
                                    <FileOutput className="w-5 h-5 text-emerald-600" />
                                  </div>
                                  <div>
                                    <div className="font-semibold text-slate-800">
                                      Script Generated — {entry.documentsGenerated.length} Document{entry.documentsGenerated.length !== 1 ? 's' : ''}
                                    </div>
                                    <div className="text-xs text-slate-500">{timestamp}</div>
                                  </div>
                                </div>
                                <div className={`px-3 py-1 rounded-full text-xs font-medium ${
                                  entry.overwriteEnabled 
                                    ? 'bg-amber-100 text-amber-800 border border-amber-200' 
                                    : 'bg-emerald-100 text-emerald-800 border border-emerald-200'
                                }`}>
                                  {entry.overwriteEnabled ? '⚠️ Overwrite Mode' : '✓ Safe Mode (Skip Existing)'}
                                </div>
                              </div>
                              {entry.dataSnapshot && (
                                <div className="text-xs text-slate-600 mt-2 flex items-center gap-4">
                                  <span className="font-medium">Data snapshot:</span>
                                  <span>Company: {entry.dataSnapshot.legalName}</span>
                                  {entry.dataSnapshot.totalSAFEs > 0 && <span>{entry.dataSnapshot.totalSAFEs} SAFE{entry.dataSnapshot.totalSAFEs !== 1 ? 's' : ''}</span>}
                                  {entry.dataSnapshot.totalEmployees > 0 && <span>{entry.dataSnapshot.totalEmployees} employee{entry.dataSnapshot.totalEmployees !== 1 ? 's' : ''}</span>}
                                  {entry.dataSnapshot.totalAdvisors > 0 && <span>{entry.dataSnapshot.totalAdvisors} advisor{entry.dataSnapshot.totalAdvisors !== 1 ? 's' : ''}</span>}
                                </div>
                              )}
                            </div>
                            
                            {/* Document List - Show ALL */}
                            <div className="p-3 bg-white">
                              <div className="text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">Documents in this batch:</div>
                              <div className="space-y-1.5">
                                {entry.documentsGenerated.map((doc, docIdx) => {
                                  // Determine document type for icon coloring
                                  const isFormation = doc.includes('Certificate') || doc.includes('Bylaws') || doc.includes('Incorporator') || doc.includes('Resolution') || doc.includes('Equity Incentive Plan') || doc.includes('Stockholder Consent');
                                  const isSAFE = doc.includes('SAFE') || doc.includes('MFN') || doc.includes('Valuation Cap');
                                  const isEmployee = doc.includes('Option Agreement') || doc.includes('Exercise');
                                  const isAdvisor = doc.includes('Advisor') || doc.includes('Consulting') || doc.includes('IP Stock');
                                  
                                  const iconColor = isFormation ? 'text-blue-500' : 
                                                    isSAFE ? 'text-green-500' : 
                                                    isEmployee ? 'text-purple-500' : 
                                                    isAdvisor ? 'text-orange-500' : 'text-slate-500';
                                  const bgColor = isFormation ? 'bg-blue-50' : 
                                                  isSAFE ? 'bg-green-50' : 
                                                  isEmployee ? 'bg-purple-50' : 
                                                  isAdvisor ? 'bg-orange-50' : 'bg-slate-50';
                                  
                                  return (
                                    <div key={docIdx} className={`flex items-center gap-2 text-sm p-2 rounded-lg ${bgColor}`}>
                                      <FileText className={`w-4 h-4 flex-shrink-0 ${iconColor}`} />
                                      <span className="text-slate-700 flex-1">{doc}</span>
                                      <span className={`text-xs px-2 py-0.5 rounded ${
                                        entry.overwriteEnabled 
                                          ? 'bg-amber-100 text-amber-700' 
                                          : 'bg-slate-100 text-slate-600'
                                      }`}>
                                        {entry.overwriteEnabled ? 'overwrite' : 'skip if exists'}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          </div>
                        );
                      } else {
                        // Old single-document format
                        return (
                          <div key={idx} className="p-3 bg-slate-50 rounded-lg border text-sm">
                            <div className="flex items-start justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <FileText className="w-4 h-4 text-emerald-500" />
                                <span className="font-medium text-slate-800">{entry.fileName}</span>
                              </div>
                              <div className="text-xs text-slate-500">{timestamp}</div>
                            </div>
                            {entry.dataUsed && (
                              <div className="text-xs text-slate-600 bg-white p-2 rounded border mt-2">
                                <div className="font-medium text-slate-700 mb-1">Data used:</div>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                  {Object.entries(entry.dataUsed).slice(0, 6).map(([key, value]) => (
                                    <div key={key} className="truncate">
                                      <span className="text-slate-500">{key}:</span>{' '}
                                      <span className="text-slate-700">{typeof value === 'object' ? JSON.stringify(value) : String(value)}</span>
                                    </div>
                                  ))}
                                  {Object.keys(entry.dataUsed).length > 6 && (
                                    <div className="text-slate-400 italic col-span-2">+{Object.keys(entry.dataUsed).length - 6} more fields</div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      }
                    })}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Add Funding Round Modal */}
        {showAddFunding && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col">
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-green-100 rounded-lg">
                    <DollarSign className="w-5 h-5 text-green-600" />
                  </div>
                  <h2 className="text-lg font-semibold">Add Funding Round</h2>
                </div>
                <button onClick={() => setShowAddFunding(false)} className="p-2 hover:bg-slate-100 rounded transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto min-h-0">
                <SelectField label="Round Type" value={newFunding.type} onChange={e => setNewFunding({...newFunding, type: e.target.value})} options={['SAFE', 'Priced Round']} />
                <Field label="Investor Name *" value={newFunding.investorName} onChange={e => setNewFunding({...newFunding, investorName: e.target.value})} />
                <Field label="Date *" type="date" value={newFunding.date} onChange={e => setNewFunding({...newFunding, date: e.target.value})} />
                <NumberField label="Investment Amount ($) *" prefix="$" value={newFunding.amount} onChange={e => setNewFunding({...newFunding, amount: e.target.value})} />
                {newFunding.type === 'SAFE' ? (
                  <>
                    <div className="p-3 bg-green-50 rounded-lg border border-green-200">
                      <label className="block text-sm font-medium text-green-800 mb-2">Document Template</label>
                      <div className="space-y-2">
                        <label className="flex items-start gap-2 cursor-pointer">
                          <input 
                            type="radio" 
                            name="safeTemplate" 
                            checked={newFunding.safeTemplate === 'valuationCap'} 
                            onChange={() => setNewFunding({...newFunding, safeTemplate: 'valuationCap'})}
                            className="mt-1"
                          />
                          <div>
                            <div className="font-medium text-sm">Post-Money SAFE - Valuation Cap</div>
                            <div className="text-xs text-green-700">Most common. Sets maximum conversion price.</div>
                          </div>
                        </label>
                        <label className="flex items-start gap-2 cursor-pointer">
                          <input 
                            type="radio" 
                            name="safeTemplate" 
                            checked={newFunding.safeTemplate === 'mfn'} 
                            onChange={() => setNewFunding({...newFunding, safeTemplate: 'mfn'})}
                            className="mt-1"
                          />
                          <div>
                            <div className="font-medium text-sm">Post-Money SAFE - MFN Only</div>
                            <div className="text-xs text-green-700">No cap, but gets best terms offered to later investors.</div>
                          </div>
                        </label>
                      </div>
                    </div>
                    <SelectField label="Valuation Cap Type" value={newFunding.valuationType} onChange={e => setNewFunding({...newFunding, valuationType: e.target.value})} options={['Post-Money', 'Pre-Money']} />
                    <NumberField label="Valuation Cap ($)" prefix="$" value={newFunding.valuationCap} onChange={e => setNewFunding({...newFunding, valuationCap: e.target.value})} />
                    <NumberField label="Discount (%)" value={newFunding.discount} onChange={e => setNewFunding({...newFunding, discount: e.target.value})} />
                    {newFunding.valuationCap > 0 && newFunding.amount > 0 && (
                      <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="text-sm text-blue-800">
                          <strong>Implied Ownership:</strong>{' '}
                          {newFunding.valuationType === 'Pre-Money' 
                            ? ((newFunding.amount / (newFunding.valuationCap + newFunding.amount)) * 100).toFixed(2)
                            : ((newFunding.amount / newFunding.valuationCap) * 100).toFixed(2)
                          }%
                        </div>
                      </div>
                    )}
                  </>
                ) : (
                  <>
                    <SelectField label="Valuation Type" value={newFunding.valuationType} onChange={e => setNewFunding({...newFunding, valuationType: e.target.value})} options={['Post-Money', 'Pre-Money']} />
                    <NumberField label={newFunding.valuationType === 'Pre-Money' ? 'Pre-Money Valuation ($)' : 'Post-Money Valuation ($)'} prefix="$" value={newFunding.valuation} onChange={e => setNewFunding({...newFunding, valuation: e.target.value})} />
                    <NumberField label="Shares Issued" value={newFunding.sharesIssued} onChange={e => setNewFunding({...newFunding, sharesIssued: e.target.value})} />
                    <NumberField label="Price Per Share ($)" decimals={4} prefix="$" value={newFunding.pricePerShare} onChange={e => setNewFunding({...newFunding, pricePerShare: e.target.value})} />
                    {newFunding.valuation > 0 && newFunding.amount > 0 && (
                      <div className="p-3 bg-green-50 rounded-lg border border-green-200">
                        <div className="text-sm text-green-800">
                          <strong>Implied Ownership:</strong>{' '}
                          {newFunding.valuationType === 'Pre-Money' 
                            ? ((newFunding.amount / (newFunding.valuation + newFunding.amount)) * 100).toFixed(2)
                            : ((newFunding.amount / newFunding.valuation) * 100).toFixed(2)
                          }%
                          {newFunding.valuationType === 'Pre-Money' && (
                            <span className="ml-2 text-green-600">
                              (Post-Money: ${(newFunding.valuation + newFunding.amount).toLocaleString()})
                            </span>
                          )}
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0">
                <button onClick={() => setShowAddFunding(false)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={addFundingRound} className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Add Round</button>
              </div>
            </div>
          </div>
        )}

        {/* Edit Funding Round Modal */}
        {editingFunding && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col">
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-green-100 rounded-lg">
                    <DollarSign className="w-5 h-5 text-green-600" />
                  </div>
                  <h2 className="text-lg font-semibold">Edit Funding Round</h2>
                </div>
                <button onClick={() => setEditingFunding(null)} className="p-2 hover:bg-slate-100 rounded transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto min-h-0">
                <SelectField label="Round Type" value={editingFunding.type} onChange={e => setEditingFunding({...editingFunding, type: e.target.value})} options={['SAFE', 'Priced Round']} />
                <Field label="Investor Name *" value={editingFunding.investorName} onChange={e => setEditingFunding({...editingFunding, investorName: e.target.value})} />
                <Field label="Date *" type="date" value={editingFunding.date} onChange={e => setEditingFunding({...editingFunding, date: e.target.value})} />
                <NumberField label="Investment Amount ($) *" prefix="$" value={editingFunding.amount} onChange={e => setEditingFunding({...editingFunding, amount: e.target.value})} />
                {editingFunding.type === 'SAFE' ? (
                  <>
                    <div className="p-3 bg-green-50 rounded-lg border border-green-200">
                      <label className="block text-sm font-medium text-green-800 mb-2">Document Template</label>
                      <div className="space-y-2">
                        <label className="flex items-start gap-2 cursor-pointer">
                          <input 
                            type="radio" 
                            name="editSafeTemplate" 
                            checked={(editingFunding.safeTemplate || 'valuationCap') === 'valuationCap'} 
                            onChange={() => setEditingFunding({...editingFunding, safeTemplate: 'valuationCap'})}
                            className="mt-1"
                          />
                          <div>
                            <div className="font-medium text-sm">Post-Money SAFE - Valuation Cap</div>
                            <div className="text-xs text-green-700">Most common. Sets maximum conversion price.</div>
                          </div>
                        </label>
                        <label className="flex items-start gap-2 cursor-pointer">
                          <input 
                            type="radio" 
                            name="editSafeTemplate" 
                            checked={editingFunding.safeTemplate === 'mfn'} 
                            onChange={() => setEditingFunding({...editingFunding, safeTemplate: 'mfn'})}
                            className="mt-1"
                          />
                          <div>
                            <div className="font-medium text-sm">Post-Money SAFE - MFN Only</div>
                            <div className="text-xs text-green-700">No cap, but gets best terms offered to later investors.</div>
                          </div>
                        </label>
                      </div>
                    </div>
                    <SelectField label="Valuation Cap Type" value={editingFunding.valuationType || 'Post-Money'} onChange={e => setEditingFunding({...editingFunding, valuationType: e.target.value})} options={['Post-Money', 'Pre-Money']} />
                    <NumberField label="Valuation Cap ($)" prefix="$" value={editingFunding.valuationCap} onChange={e => setEditingFunding({...editingFunding, valuationCap: e.target.value})} />
                    <NumberField label="Discount (%)" value={editingFunding.discount} onChange={e => setEditingFunding({...editingFunding, discount: e.target.value})} />
                    {editingFunding.valuationCap > 0 && editingFunding.amount > 0 && (
                      <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <div className="text-sm text-blue-800">
                          <strong>Implied Ownership:</strong>{' '}
                          {(editingFunding.valuationType || 'Post-Money') === 'Pre-Money' 
                            ? ((editingFunding.amount / (editingFunding.valuationCap + editingFunding.amount)) * 100).toFixed(2)
                            : ((editingFunding.amount / editingFunding.valuationCap) * 100).toFixed(2)
                          }%
                        </div>
                      </div>
                    )}
                  </>
                ) : (
                  <>
                    <SelectField label="Valuation Type" value={editingFunding.valuationType || 'Post-Money'} onChange={e => setEditingFunding({...editingFunding, valuationType: e.target.value})} options={['Post-Money', 'Pre-Money']} />
                    <NumberField label={(editingFunding.valuationType || 'Post-Money') === 'Pre-Money' ? 'Pre-Money Valuation ($)' : 'Post-Money Valuation ($)'} prefix="$" value={editingFunding.valuation} onChange={e => setEditingFunding({...editingFunding, valuation: e.target.value})} />
                    <NumberField label="Shares Issued" value={editingFunding.sharesIssued} onChange={e => setEditingFunding({...editingFunding, sharesIssued: e.target.value})} />
                    <NumberField label="Price Per Share ($)" decimals={4} prefix="$" value={editingFunding.pricePerShare} onChange={e => setEditingFunding({...editingFunding, pricePerShare: e.target.value})} />
                    {editingFunding.valuation > 0 && editingFunding.amount > 0 && (
                      <div className="p-3 bg-green-50 rounded-lg border border-green-200">
                        <div className="text-sm text-green-800">
                          <strong>Implied Ownership:</strong>{' '}
                          {(editingFunding.valuationType || 'Post-Money') === 'Pre-Money' 
                            ? ((editingFunding.amount / (editingFunding.valuation + editingFunding.amount)) * 100).toFixed(2)
                            : ((editingFunding.amount / editingFunding.valuation) * 100).toFixed(2)
                          }%
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0">
                <button onClick={() => setEditingFunding(null)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={saveFundingEdit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
              </div>
            </div>
          </div>
        )}

        {/* Add Employee Grant Modal */}
        {showAddEmployee && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col">
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-purple-100 rounded-lg">
                    <Users className="w-5 h-5 text-purple-600" />
                  </div>
                  <h2 className="text-lg font-semibold">Add Employee Grant</h2>
                </div>
                <button onClick={() => setShowAddEmployee(false)} className="p-2 hover:bg-slate-100 rounded transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto min-h-0">
                <Field label="Employee Name *" value={newEmployee.employeeName} onChange={e => setNewEmployee({...newEmployee, employeeName: e.target.value})} />
                <Field label="Grant Date *" type="date" value={newEmployee.grantDate} onChange={e => setNewEmployee({...newEmployee, grantDate: e.target.value})} />
                <SelectField label="Grant Type (Tax Treatment)" value={newEmployee.grantType} onChange={e => setNewEmployee({...newEmployee, grantType: e.target.value})} options={['ISO', 'NSO']} />
                
                {/* Option Agreement Type Selection */}
                <div className="p-3 bg-purple-50 rounded-lg border border-purple-200">
                  <label className="block text-sm font-medium text-purple-800 mb-2">Option Agreement Type</label>
                  <div className="space-y-2">
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="optionAgreementType" 
                        checked={(newEmployee.optionAgreementType || 'standard') === 'standard'} 
                        onChange={() => setNewEmployee({...newEmployee, optionAgreementType: 'standard'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Standard Option Agreement</div>
                        <div className="text-xs text-purple-700">Can only exercise after vesting. Simpler, no upfront cost.</div>
                      </div>
                    </label>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="optionAgreementType" 
                        checked={newEmployee.optionAgreementType === 'earlyExercise'} 
                        onChange={() => setNewEmployee({...newEmployee, optionAgreementType: 'earlyExercise'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Early Exercise Option Agreement</div>
                        <div className="text-xs text-purple-700">Can exercise before vesting. Enables 83(b) election for tax benefits.</div>
                      </div>
                    </label>
                  </div>
                </div>

                <NumberField label="Number of Shares *" value={newEmployee.shares} onChange={e => setNewEmployee({...newEmployee, shares: e.target.value})} />
                <div>
                  <NumberField label="Exercise Price ($)" decimals={4} prefix="$" value={newEmployee.exercisePrice} onChange={e => setNewEmployee({...newEmployee, exercisePrice: e.target.value})} />
                  <p className="text-xs text-slate-500 mt-1">Usually set to Fair Market Value (FMV) at time of award, as determined by the Board.</p>
                </div>
                <SelectField 
                  label="Vesting Schedule" 
                  value={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(newEmployee.vestingSchedule) ? newEmployee.vestingSchedule : 'Other'} 
                  onChange={e => setNewEmployee({...newEmployee, vestingSchedule: e.target.value === 'Other' ? '' : e.target.value})} 
                  options={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate', 'Other']} 
                />
                {!['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(newEmployee.vestingSchedule) && (
                  <Field label="Custom Vesting Schedule" value={newEmployee.vestingSchedule} onChange={e => setNewEmployee({...newEmployee, vestingSchedule: e.target.value})} placeholder="Enter custom vesting schedule" />
                )}
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0">
                <button onClick={() => setShowAddEmployee(false)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={addEmployeeGrant} className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Add Grant</button>
              </div>
            </div>
          </div>
        )}

        {/* Edit Employee Grant Modal */}
        {editingEmployee && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col">
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-purple-100 rounded-lg">
                    <Users className="w-5 h-5 text-purple-600" />
                  </div>
                  <h2 className="text-lg font-semibold">Edit Employee Grant</h2>
                </div>
                <button onClick={() => setEditingEmployee(null)} className="p-2 hover:bg-slate-100 rounded transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto min-h-0">
                <Field label="Employee Name *" value={editingEmployee.employeeName} onChange={e => setEditingEmployee({...editingEmployee, employeeName: e.target.value})} />
                <Field label="Grant Date *" type="date" value={editingEmployee.grantDate} onChange={e => setEditingEmployee({...editingEmployee, grantDate: e.target.value})} />
                <SelectField label="Grant Type (Tax Treatment)" value={editingEmployee.grantType} onChange={e => setEditingEmployee({...editingEmployee, grantType: e.target.value})} options={['ISO', 'NSO']} />
                
                {/* Option Agreement Type Selection */}
                <div className="p-3 bg-purple-50 rounded-lg border border-purple-200">
                  <label className="block text-sm font-medium text-purple-800 mb-2">Option Agreement Type</label>
                  <div className="space-y-2">
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="editOptionAgreementType" 
                        checked={(editingEmployee.optionAgreementType || 'standard') === 'standard'} 
                        onChange={() => setEditingEmployee({...editingEmployee, optionAgreementType: 'standard'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Standard Option Agreement</div>
                        <div className="text-xs text-purple-700">Can only exercise after vesting. Simpler, no upfront cost.</div>
                      </div>
                    </label>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="editOptionAgreementType" 
                        checked={editingEmployee.optionAgreementType === 'earlyExercise'} 
                        onChange={() => setEditingEmployee({...editingEmployee, optionAgreementType: 'earlyExercise'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Early Exercise Option Agreement</div>
                        <div className="text-xs text-purple-700">Can exercise before vesting. Enables 83(b) election for tax benefits.</div>
                      </div>
                    </label>
                  </div>
                </div>

                <NumberField label="Number of Shares *" value={editingEmployee.shares} onChange={e => setEditingEmployee({...editingEmployee, shares: e.target.value})} />
                <div>
                  <NumberField label="Exercise Price ($)" decimals={4} prefix="$" value={editingEmployee.exercisePrice} onChange={e => setEditingEmployee({...editingEmployee, exercisePrice: e.target.value})} />
                  <p className="text-xs text-slate-500 mt-1">Usually set to Fair Market Value (FMV) at time of award, as determined by the Board.</p>
                </div>
                <SelectField 
                  label="Vesting Schedule" 
                  value={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(editingEmployee.vestingSchedule) ? editingEmployee.vestingSchedule : 'Other'} 
                  onChange={e => setEditingEmployee({...editingEmployee, vestingSchedule: e.target.value === 'Other' ? '' : e.target.value})} 
                  options={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate', 'Other']} 
                />
                {!['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(editingEmployee.vestingSchedule) && (
                  <Field label="Custom Vesting Schedule" value={editingEmployee.vestingSchedule} onChange={e => setEditingEmployee({...editingEmployee, vestingSchedule: e.target.value})} placeholder="Enter custom vesting schedule" />
                )}
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0">
                <button onClick={() => setEditingEmployee(null)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={saveEmployeeEdit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
              </div>
            </div>
          </div>
        )}

        {/* Add Advisor Grant Modal */}
        {showAddAdvisor && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col">
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-orange-100 rounded-lg">
                    <UserCheck className="w-5 h-5 text-orange-600" />
                  </div>
                  <h2 className="text-lg font-semibold">Add Advisor/Consultant</h2>
                </div>
                <button onClick={() => setShowAddAdvisor(false)} className="p-2 hover:bg-slate-100 rounded transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto min-h-0">
                <Field label="Name *" value={newAdvisor.advisorName} onChange={e => setNewAdvisor({...newAdvisor, advisorName: e.target.value})} />
                <Field label="Effective Date *" type="date" value={newAdvisor.grantDate} onChange={e => setNewAdvisor({...newAdvisor, grantDate: e.target.value})} />
                
                {/* Agreement Type Selection */}
                <div className="p-3 bg-orange-50 rounded-lg border border-orange-200">
                  <label className="block text-sm font-medium text-orange-800 mb-2">Agreement Type</label>
                  <div className="space-y-2">
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="agreementType" 
                        checked={(newAdvisor.agreementType || 'advisor') === 'advisor'} 
                        onChange={() => setNewAdvisor({...newAdvisor, agreementType: 'advisor'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Advisor Agreement</div>
                        <div className="text-xs text-orange-700">Strategic guidance and introductions. Light time commitment.</div>
                      </div>
                    </label>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="agreementType" 
                        checked={newAdvisor.agreementType === 'consulting'} 
                        onChange={() => setNewAdvisor({...newAdvisor, agreementType: 'consulting'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Consulting Agreement</div>
                        <div className="text-xs text-orange-700">Deliverable-based work. More substantial engagement.</div>
                      </div>
                    </label>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="agreementType" 
                        checked={newAdvisor.agreementType === 'ipStockPurchase'} 
                        onChange={() => setNewAdvisor({...newAdvisor, agreementType: 'ipStockPurchase'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Restricted Stock Purchase (IP Assignment)</div>
                        <div className="text-xs text-orange-700">Stock in exchange for intellectual property. Includes IP assignment.</div>
                      </div>
                    </label>
                  </div>
                </div>

                <NumberField label="Number of Shares *" value={newAdvisor.shares} onChange={e => setNewAdvisor({...newAdvisor, shares: e.target.value})} />
                <div>
                  <NumberField label={newAdvisor.agreementType === 'ipStockPurchase' ? 'Purchase Price per Share ($)' : 'Exercise Price ($)'} decimals={4} prefix="$" value={newAdvisor.exercisePrice} onChange={e => setNewAdvisor({...newAdvisor, exercisePrice: e.target.value})} />
                  <p className="text-xs text-slate-500 mt-1">
                    {newAdvisor.agreementType === 'ipStockPurchase' 
                      ? 'Usually set to par value for IP-for-stock transactions.'
                      : 'Usually set to Fair Market Value (FMV) at time of award, as determined by the Board.'}
                  </p>
                </div>
                <SelectField 
                  label="Vesting Schedule" 
                  value={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(newAdvisor.vestingSchedule) ? newAdvisor.vestingSchedule : 'Other'} 
                  onChange={e => setNewAdvisor({...newAdvisor, vestingSchedule: e.target.value === 'Other' ? '' : e.target.value})} 
                  options={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate', 'Other']} 
                />
                {!['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(newAdvisor.vestingSchedule) && (
                  <Field label="Custom Vesting Schedule" value={newAdvisor.vestingSchedule} onChange={e => setNewAdvisor({...newAdvisor, vestingSchedule: e.target.value})} placeholder="Enter custom vesting schedule" />
                )}
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0">
                <button onClick={() => setShowAddAdvisor(false)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={addAdvisorGrant} className="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Add Grant</button>
              </div>
            </div>
          </div>
        )}

        {/* Edit Advisor Grant Modal */}
        {editingAdvisor && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-lg w-full max-h-[90vh] flex flex-col">
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-orange-100 rounded-lg">
                    <UserCheck className="w-5 h-5 text-orange-600" />
                  </div>
                  <h2 className="text-lg font-semibold">Edit Advisor/Consultant</h2>
                </div>
                <button onClick={() => setEditingAdvisor(null)} className="p-2 hover:bg-slate-100 rounded transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <div className="p-5 space-y-4 flex-1 overflow-y-auto min-h-0">
                <Field label="Name *" value={editingAdvisor.advisorName} onChange={e => setEditingAdvisor({...editingAdvisor, advisorName: e.target.value})} />
                <Field label="Effective Date *" type="date" value={editingAdvisor.grantDate} onChange={e => setEditingAdvisor({...editingAdvisor, grantDate: e.target.value})} />
                
                {/* Agreement Type Selection */}
                <div className="p-3 bg-orange-50 rounded-lg border border-orange-200">
                  <label className="block text-sm font-medium text-orange-800 mb-2">Agreement Type</label>
                  <div className="space-y-2">
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="editAgreementType" 
                        checked={(editingAdvisor.agreementType || 'advisor') === 'advisor'} 
                        onChange={() => setEditingAdvisor({...editingAdvisor, agreementType: 'advisor'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Advisor Agreement</div>
                        <div className="text-xs text-orange-700">Strategic guidance and introductions. Light time commitment.</div>
                      </div>
                    </label>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="editAgreementType" 
                        checked={editingAdvisor.agreementType === 'consulting'} 
                        onChange={() => setEditingAdvisor({...editingAdvisor, agreementType: 'consulting'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Consulting Agreement</div>
                        <div className="text-xs text-orange-700">Deliverable-based work. More substantial engagement.</div>
                      </div>
                    </label>
                    <label className="flex items-start gap-2 cursor-pointer">
                      <input 
                        type="radio" 
                        name="editAgreementType" 
                        checked={editingAdvisor.agreementType === 'ipStockPurchase'} 
                        onChange={() => setEditingAdvisor({...editingAdvisor, agreementType: 'ipStockPurchase'})}
                        className="mt-1"
                      />
                      <div>
                        <div className="font-medium text-sm">Restricted Stock Purchase (IP Assignment)</div>
                        <div className="text-xs text-orange-700">Stock in exchange for intellectual property. Includes IP assignment.</div>
                      </div>
                    </label>
                  </div>
                </div>

                <NumberField label="Number of Shares *" value={editingAdvisor.shares} onChange={e => setEditingAdvisor({...editingAdvisor, shares: e.target.value})} />
                <div>
                  <NumberField label={(editingAdvisor.agreementType || 'advisor') === 'ipStockPurchase' ? 'Purchase Price per Share ($)' : 'Exercise Price ($)'} decimals={4} prefix="$" value={editingAdvisor.exercisePrice} onChange={e => setEditingAdvisor({...editingAdvisor, exercisePrice: e.target.value})} />
                  <p className="text-xs text-slate-500 mt-1">
                    {(editingAdvisor.agreementType || 'advisor') === 'ipStockPurchase' 
                      ? 'Usually set to par value for IP-for-stock transactions.'
                      : 'Usually set to Fair Market Value (FMV) at time of award, as determined by the Board.'}
                  </p>
                </div>
                <SelectField 
                  label="Vesting Schedule" 
                  value={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(editingAdvisor.vestingSchedule) ? editingAdvisor.vestingSchedule : 'Other'} 
                  onChange={e => setEditingAdvisor({...editingAdvisor, vestingSchedule: e.target.value === 'Other' ? '' : e.target.value})} 
                  options={['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate', 'Other']} 
                />
                {!['4 years with 1 year cliff', '5 years with 1 year cliff', '4 years monthly', '3 years with 1 year cliff', '2 years monthly', '2 years quarterly', '1 year monthly', 'Immediate'].includes(editingAdvisor.vestingSchedule) && (
                  <Field label="Custom Vesting Schedule" value={editingAdvisor.vestingSchedule} onChange={e => setEditingAdvisor({...editingAdvisor, vestingSchedule: e.target.value})} placeholder="Enter custom vesting schedule" />
                )}
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0">
                <button onClick={() => setEditingAdvisor(null)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={saveAdvisorEdit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
              </div>
            </div>
          </div>
        )}

        {/* Entry Delete Confirmation Modal */}
        {entryDeleteConfirm && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-md w-full p-6">
              <div className="flex items-center gap-2 text-red-600 mb-3">
                <AlertCircle className="w-5 h-5" />
                <h2 className="text-lg font-semibold">Delete Entry</h2>
              </div>
              <p className="text-slate-600 mb-4">Delete <strong>{entryDeleteConfirm.name}</strong>? This cannot be undone.</p>
              <input 
                type="text" 
                value={entryDeleteText} 
                onChange={e => setEntryDeleteText(e.target.value)} 
                className="w-full border rounded px-3 py-2 mb-4" 
                placeholder="Type DELETE to confirm" 
              />
              <div className="flex justify-end gap-2">
                <button onClick={() => { setEntryDeleteConfirm(null); setEntryDeleteText(''); }} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button 
                  onClick={() => {
                    if (entryDeleteText === 'DELETE') {
                      if (entryDeleteConfirm.type === 'funding') deleteFundingRound(entryDeleteConfirm.id);
                      else if (entryDeleteConfirm.type === 'employee') deleteEmployeeGrant(entryDeleteConfirm.id);
                      else if (entryDeleteConfirm.type === 'advisor') deleteAdvisorGrant(entryDeleteConfirm.id);
                    }
                  }} 
                  disabled={entryDeleteText !== 'DELETE'} 
                  className="px-4 py-2 bg-red-600 text-white rounded disabled:opacity-50"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Pre-Generation Modal - Collect Missing Fields */}
        {showPreGenerate && ventureToGenerate && (() => {
          const missingFields = getMissingFieldsForGeneration(ventureToGenerate, generateOptions);
          const hasAnyMissing = missingFields.hasOptional || missingFields.hasRequired;
          
          return hasAnyMissing ? (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[100]">
              <div className="bg-white rounded-xl max-w-3xl w-full flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
                <div className="p-5 border-b bg-amber-50 flex-shrink-0">
                  <div className="flex justify-between items-start">
                    <div>
                      <h2 className="text-lg font-semibold text-amber-900">Additional Details for Selected Documents</h2>
                      <p className="text-sm text-amber-700">
                        Fill in these optional fields to complete your documents, or use the skip checkboxes to leave them blank.
                      </p>
                      <p className="text-xs text-amber-600 mt-1">
                        <span className="font-medium">Tip:</span> Skipped fields will be <span className="bg-red-200 px-1 rounded">highlighted in red</span> in your documents for easy identification.
                      </p>
                    </div>
                    <button onClick={() => setShowPreGenerate(false)} className="p-2 hover:bg-amber-100 rounded">
                      <X className="w-5 h-5" />
                    </button>
                  </div>
                  {/* Skip All / Fill All Buttons */}
                  <div className="flex gap-2 mt-3">
                    <button
                      onClick={() => {
                        // Mark all fields as skipped by clearing all override data
                        setPreGenerateData({
                          effectiveDate: '',
                          presidentName: '',
                          secretaryName: '',
                          treasurerName: '',
                          fundingOverrides: {},
                          employeeOverrides: {},
                          advisorOverrides: {},
                        });
                        setSkippedFields(true);
                        setShowPreGenerate(false);
                        setShowScriptSection(true);
                      }}
                      className="px-3 py-1.5 text-xs bg-slate-600 text-white rounded hover:bg-slate-700 font-medium flex items-center gap-1"
                    >
                      <AlertCircle className="w-3 h-3" />
                      Skip All Fields
                    </button>
                  </div>
                </div>
                
                <div className="flex-1 overflow-y-auto min-h-0 p-5 space-y-6">
                  {/* Venture-level fields */}
                  {missingFields.venture.length > 0 && (
                    <div className="border rounded-lg p-4">
                      <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                        <Building2 className="w-4 h-4 text-blue-600" />
                        Company & Formation Details
                      </h3>
                      <div className="grid grid-cols-1 gap-4">
                        {missingFields.venture.map(f => (
                          <div key={f.field} className="flex items-start gap-3">
                            <div className="flex-1">
                              <label className="block text-sm text-slate-600 mb-1">
                                {f.label}
                                {f.required && <span className="text-red-500 ml-1">*</span>}
                              </label>
                              {f.field === 'descriptionOfGVSIPAssignment' ? (
                                <textarea
                                  value={preGenerateData[f.field] || ''}
                                  onChange={e => setPreGenerateData({...preGenerateData, [f.field]: e.target.value})}
                                  className={`w-full border rounded px-3 py-2 ${preGenerateData[f.field + '_skip'] ? 'bg-slate-100 text-slate-400' : ''}`}
                                  placeholder={f.hint}
                                  disabled={preGenerateData[f.field + '_skip']}
                                  rows={3}
                                />
                              ) : (
                                <input
                                  type="text"
                                  value={preGenerateData[f.field] || ''}
                                  onChange={e => setPreGenerateData({...preGenerateData, [f.field]: e.target.value})}
                                  className={`w-full border rounded px-3 py-2 ${preGenerateData[f.field + '_skip'] ? 'bg-slate-100 text-slate-400' : ''}`}
                                  placeholder={f.hint}
                                  disabled={preGenerateData[f.field + '_skip']}
                                />
                              )}
                            </div>
                            <label className="flex items-center gap-1.5 mt-7 text-xs text-slate-500 cursor-pointer whitespace-nowrap">
                              <input
                                type="checkbox"
                                checked={preGenerateData[f.field + '_skip'] || false}
                                onChange={e => setPreGenerateData({...preGenerateData, [f.field + '_skip']: e.target.checked, [f.field]: e.target.checked ? '' : preGenerateData[f.field]})}
                                className="rounded"
                              />
                              Skip
                            </label>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* SAFE investor fields */}
                  {missingFields.safes.length > 0 && (
                    <div className="border rounded-lg p-4">
                      <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                        <DollarSign className="w-4 h-4 text-green-600" />
                        SAFE Investor Details
                      </h3>
                      <div className="space-y-4">
                        {missingFields.safes.map(safe => (
                          <div key={safe.index} className="bg-slate-50 rounded p-3">
                            <div className="flex justify-between items-center mb-2">
                              <div className="font-medium text-sm text-slate-700">{safe.name}</div>
                              <button
                                onClick={() => {
                                  const skipAll = {};
                                  safe.fields.forEach(f => { skipAll[f.field + '_skip'] = true; });
                                  setPreGenerateData({
                                    ...preGenerateData,
                                    fundingOverrides: {
                                      ...preGenerateData.fundingOverrides,
                                      [safe.index]: { ...(preGenerateData.fundingOverrides[safe.index] || {}), ...skipAll }
                                    }
                                  });
                                }}
                                className="text-xs text-slate-500 hover:text-slate-700"
                              >
                                Skip all for this investor
                              </button>
                            </div>
                            <div className="grid grid-cols-1 gap-3">
                              {safe.fields.map(f => (
                                <div key={f.field} className="flex items-start gap-3">
                                  <div className="flex-1">
                                    <label className="block text-xs text-slate-500 mb-1">
                                      {f.label}
                                      {f.required && <span className="text-red-500 ml-1">*</span>}
                                    </label>
                                    <input
                                      type="text"
                                      value={(preGenerateData.fundingOverrides[safe.index] || {})[f.field] || ''}
                                      onChange={e => setPreGenerateData({
                                        ...preGenerateData,
                                        fundingOverrides: {
                                          ...preGenerateData.fundingOverrides,
                                          [safe.index]: {
                                            ...(preGenerateData.fundingOverrides[safe.index] || {}),
                                            [f.field]: e.target.value
                                          }
                                        }
                                      })}
                                      className={`w-full border rounded px-2 py-1 text-sm ${(preGenerateData.fundingOverrides[safe.index] || {})[f.field + '_skip'] ? 'bg-slate-100 text-slate-400' : ''}`}
                                      placeholder={f.hint}
                                      disabled={(preGenerateData.fundingOverrides[safe.index] || {})[f.field + '_skip']}
                                    />
                                  </div>
                                  <label className="flex items-center gap-1.5 mt-5 text-xs text-slate-500 cursor-pointer whitespace-nowrap">
                                    <input
                                      type="checkbox"
                                      checked={(preGenerateData.fundingOverrides[safe.index] || {})[f.field + '_skip'] || false}
                                      onChange={e => setPreGenerateData({
                                        ...preGenerateData,
                                        fundingOverrides: {
                                          ...preGenerateData.fundingOverrides,
                                          [safe.index]: {
                                            ...(preGenerateData.fundingOverrides[safe.index] || {}),
                                            [f.field + '_skip']: e.target.checked,
                                            [f.field]: e.target.checked ? '' : (preGenerateData.fundingOverrides[safe.index] || {})[f.field]
                                          }
                                        }
                                      })}
                                      className="rounded"
                                    />
                                    Skip
                                  </label>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Employee option fields */}
                  {missingFields.employees.length > 0 && (
                    <div className="border rounded-lg p-4">
                      <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                        <Users className="w-4 h-4 text-purple-600" />
                        Employee Option Details
                      </h3>
                      <div className="space-y-4">
                        {missingFields.employees.map(emp => (
                          <div key={emp.index} className="bg-slate-50 rounded p-3">
                            <div className="flex justify-between items-center mb-2">
                              <div className="font-medium text-sm text-slate-700">{emp.name}</div>
                              <button
                                onClick={() => {
                                  const skipAll = {};
                                  emp.fields.forEach(f => { skipAll[f.field + '_skip'] = true; });
                                  setPreGenerateData({
                                    ...preGenerateData,
                                    employeeOverrides: {
                                      ...preGenerateData.employeeOverrides,
                                      [emp.index]: { ...(preGenerateData.employeeOverrides[emp.index] || {}), ...skipAll }
                                    }
                                  });
                                }}
                                className="text-xs text-slate-500 hover:text-slate-700"
                              >
                                Skip all for this employee
                              </button>
                            </div>
                            <div className="grid grid-cols-1 gap-3">
                              {emp.fields.map(f => (
                                <div key={f.field} className="flex items-start gap-3">
                                  <div className="flex-1">
                                    <label className="block text-xs text-slate-500 mb-1">
                                      {f.label}
                                      {f.required && <span className="text-red-500 ml-1">*</span>}
                                    </label>
                                    <input
                                      type={f.field.includes('Date') ? 'date' : 'text'}
                                      value={(preGenerateData.employeeOverrides[emp.index] || {})[f.field] || ''}
                                      onChange={e => setPreGenerateData({
                                        ...preGenerateData,
                                        employeeOverrides: {
                                          ...preGenerateData.employeeOverrides,
                                          [emp.index]: {
                                            ...(preGenerateData.employeeOverrides[emp.index] || {}),
                                            [f.field]: e.target.value
                                          }
                                        }
                                      })}
                                      className={`w-full border rounded px-2 py-1 text-sm ${(preGenerateData.employeeOverrides[emp.index] || {})[f.field + '_skip'] ? 'bg-slate-100 text-slate-400' : ''}`}
                                      placeholder={f.hint}
                                      disabled={(preGenerateData.employeeOverrides[emp.index] || {})[f.field + '_skip']}
                                    />
                                  </div>
                                  <label className="flex items-center gap-1.5 mt-5 text-xs text-slate-500 cursor-pointer whitespace-nowrap">
                                    <input
                                      type="checkbox"
                                      checked={(preGenerateData.employeeOverrides[emp.index] || {})[f.field + '_skip'] || false}
                                      onChange={e => setPreGenerateData({
                                        ...preGenerateData,
                                        employeeOverrides: {
                                          ...preGenerateData.employeeOverrides,
                                          [emp.index]: {
                                            ...(preGenerateData.employeeOverrides[emp.index] || {}),
                                            [f.field + '_skip']: e.target.checked,
                                            [f.field]: e.target.checked ? '' : (preGenerateData.employeeOverrides[emp.index] || {})[f.field]
                                          }
                                        }
                                      })}
                                      className="rounded"
                                    />
                                    Skip
                                  </label>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* Advisor/Consultant fields */}
                  {missingFields.advisors.length > 0 && (
                    <div className="border rounded-lg p-4">
                      <h3 className="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                        <UserCheck className="w-4 h-4 text-teal-600" />
                        Advisor & Consultant Details
                      </h3>
                      <div className="space-y-4">
                        {missingFields.advisors.map(adv => (
                          <div key={adv.index} className="bg-slate-50 rounded p-3">
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <span className="font-medium text-sm text-slate-700">{adv.name}</span>
                                <span className={`text-xs px-2 py-0.5 rounded ${
                                  adv.agreementType === 'consulting' ? 'bg-orange-100 text-orange-700' :
                                  adv.agreementType === 'ipStockPurchase' ? 'bg-purple-100 text-purple-700' :
                                  'bg-teal-100 text-teal-700'
                                }`}>
                                  {adv.agreementType === 'consulting' ? 'Consulting Agreement' :
                                   adv.agreementType === 'ipStockPurchase' ? 'IP Stock Purchase' :
                                   'Advisor Agreement'}
                                </span>
                              </div>
                              <button
                                onClick={() => {
                                  const skipAll = {};
                                  adv.fields.forEach(f => { skipAll[f.field + '_skip'] = true; });
                                  setPreGenerateData({
                                    ...preGenerateData,
                                    advisorOverrides: {
                                      ...preGenerateData.advisorOverrides,
                                      [adv.index]: { ...(preGenerateData.advisorOverrides[adv.index] || {}), ...skipAll }
                                    }
                                  });
                                }}
                                className="text-xs text-slate-500 hover:text-slate-700"
                              >
                                Skip all for this advisor
                              </button>
                            </div>
                            <div className="grid grid-cols-1 gap-3">
                              {adv.fields.map(f => (
                                <div key={f.field} className="flex items-start gap-3">
                                  <div className={`flex-1 ${f.field === 'scopeOfWork' || f.field === 'servicesDescription' ? '' : ''}`}>
                                    <label className="block text-xs text-slate-500 mb-1">
                                      {f.label}
                                      {f.required && <span className="text-red-500 ml-1">*</span>}
                                    </label>
                                    {(f.field === 'scopeOfWork' || f.field === 'servicesDescription' || f.field === 'descriptionOfAdvisorIPAssignment') ? (
                                      <textarea
                                        value={(preGenerateData.advisorOverrides[adv.index] || {})[f.field] || ''}
                                        onChange={e => setPreGenerateData({
                                          ...preGenerateData,
                                          advisorOverrides: {
                                            ...preGenerateData.advisorOverrides,
                                            [adv.index]: {
                                              ...(preGenerateData.advisorOverrides[adv.index] || {}),
                                              [f.field]: e.target.value
                                            }
                                          }
                                        })}
                                        className={`w-full border rounded px-2 py-1 text-sm ${(preGenerateData.advisorOverrides[adv.index] || {})[f.field + '_skip'] ? 'bg-slate-100 text-slate-400' : ''}`}
                                        placeholder={f.hint}
                                        rows={f.field === 'descriptionOfAdvisorIPAssignment' ? 3 : 2}
                                        disabled={(preGenerateData.advisorOverrides[adv.index] || {})[f.field + '_skip']}
                                      />
                                    ) : (
                                      <input
                                        type="text"
                                        value={(preGenerateData.advisorOverrides[adv.index] || {})[f.field] || ''}
                                        onChange={e => setPreGenerateData({
                                          ...preGenerateData,
                                          advisorOverrides: {
                                            ...preGenerateData.advisorOverrides,
                                            [adv.index]: {
                                              ...(preGenerateData.advisorOverrides[adv.index] || {}),
                                              [f.field]: e.target.value
                                            }
                                          }
                                        })}
                                        className={`w-full border rounded px-2 py-1 text-sm ${(preGenerateData.advisorOverrides[adv.index] || {})[f.field + '_skip'] ? 'bg-slate-100 text-slate-400' : ''}`}
                                        placeholder={f.hint}
                                        disabled={(preGenerateData.advisorOverrides[adv.index] || {})[f.field + '_skip']}
                                      />
                                    )}
                                  </div>
                                  <label className="flex items-center gap-1.5 mt-5 text-xs text-slate-500 cursor-pointer whitespace-nowrap">
                                    <input
                                      type="checkbox"
                                      checked={(preGenerateData.advisorOverrides[adv.index] || {})[f.field + '_skip'] || false}
                                      onChange={e => setPreGenerateData({
                                        ...preGenerateData,
                                        advisorOverrides: {
                                          ...preGenerateData.advisorOverrides,
                                          [adv.index]: {
                                            ...(preGenerateData.advisorOverrides[adv.index] || {}),
                                            [f.field + '_skip']: e.target.checked,
                                            [f.field]: e.target.checked ? '' : (preGenerateData.advisorOverrides[adv.index] || {})[f.field]
                                          }
                                        }
                                      })}
                                      className="rounded"
                                    />
                                    Skip
                                  </label>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                
                <div className="p-5 border-t flex justify-between items-center flex-shrink-0 bg-slate-50">
                  <button 
                    onClick={() => setShowPreGenerate(false)} 
                    className="px-4 py-2 hover:bg-slate-200 rounded"
                  >
                    Back
                  </button>
                  <div className="flex gap-3">
                    <button 
                      onClick={async () => {
                        try {
                          // Apply the collected data to the venture
                          const updatedVenture = {...ventureToGenerate};
                          
                          // Check if any fields were skipped
                          let anySkipped = false;
                          
                          // Check venture-level skips
                          if (preGenerateData.presidentName_skip || preGenerateData.secretaryName_skip || 
                              preGenerateData.treasurerName_skip || preGenerateData.effectiveDate_skip) {
                            anySkipped = true;
                          }
                          
                          // Apply venture-level fields (only non-skipped ones)
                          if (preGenerateData.presidentName && !preGenerateData.presidentName_skip) {
                            updatedVenture.presidentName = preGenerateData.presidentName;
                          }
                          if (preGenerateData.secretaryName && !preGenerateData.secretaryName_skip) {
                            updatedVenture.secretaryName = preGenerateData.secretaryName;
                          }
                          if (preGenerateData.treasurerName && !preGenerateData.treasurerName_skip) {
                            updatedVenture.treasurerName = preGenerateData.treasurerName;
                          }
                          if (preGenerateData.effectiveDate && !preGenerateData.effectiveDate_skip) {
                            updatedVenture.effectiveDate = preGenerateData.effectiveDate;
                          }
                          if (preGenerateData.descriptionOfGVSIPAssignment && !preGenerateData.descriptionOfGVSIPAssignment_skip) {
                            updatedVenture.descriptionOfGVSIPAssignment = preGenerateData.descriptionOfGVSIPAssignment;
                          }
                          // Check GVS IP skip
                          if (preGenerateData.descriptionOfGVSIPAssignment_skip) {
                            anySkipped = true;
                          }
                          
                          // Apply funding overrides (filtering out _skip fields and checking for skips)
                          if (preGenerateData.fundingOverrides && Object.keys(preGenerateData.fundingOverrides).length > 0) {
                            updatedVenture.fundingRounds = (updatedVenture.fundingRounds || []).map((f, idx) => {
                              const overrides = preGenerateData.fundingOverrides[idx] || {};
                              const cleanOverrides = {};
                              Object.keys(overrides).forEach(key => {
                                if (key.endsWith('_skip')) {
                                  if (overrides[key]) anySkipped = true;
                                } else if (!overrides[key + '_skip']) {
                                  cleanOverrides[key] = overrides[key];
                                }
                              });
                              return { ...f, ...cleanOverrides };
                            });
                          }
                          
                          // Apply employee overrides (filtering out _skip fields)
                          if (preGenerateData.employeeOverrides && Object.keys(preGenerateData.employeeOverrides).length > 0) {
                            updatedVenture.employeeGrants = (updatedVenture.employeeGrants || []).map((e, idx) => {
                              const overrides = preGenerateData.employeeOverrides[idx] || {};
                              const cleanOverrides = {};
                              Object.keys(overrides).forEach(key => {
                                if (key.endsWith('_skip')) {
                                  if (overrides[key]) anySkipped = true;
                                } else if (!overrides[key + '_skip']) {
                                  cleanOverrides[key] = overrides[key];
                                }
                              });
                              return { ...e, ...cleanOverrides };
                            });
                          }
                          
                          // Apply advisor overrides (filtering out _skip fields)
                          if (preGenerateData.advisorOverrides && Object.keys(preGenerateData.advisorOverrides).length > 0) {
                            updatedVenture.advisorGrants = (updatedVenture.advisorGrants || []).map((a, idx) => {
                              const overrides = preGenerateData.advisorOverrides[idx] || {};
                              const cleanOverrides = {};
                              Object.keys(overrides).forEach(key => {
                                if (key.endsWith('_skip')) {
                                  if (overrides[key]) anySkipped = true;
                                } else if (!overrides[key + '_skip']) {
                                  cleanOverrides[key] = overrides[key];
                                }
                              });
                              return { ...a, ...cleanOverrides };
                            });
                          }
                          
                          // Persist the updated venture to storage
                          await updateVenture(updatedVenture);
                          
                          setVentureToGenerate(updatedVenture);
                          setSkippedFields(anySkipped);
                          setShowPreGenerate(false);
                          setShowScriptSection(true);
                        } catch (err) {
                          console.error('Error saving pre-generate data:', err);
                          showToast('Error saving data: ' + err.message, 'error');
                        }
                      }} 
                      className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2"
                    >
                      <CheckCircle className="w-4 h-4" />
                      Save & Continue
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ) : null;
        })()}

        {/* Generate Modal */}
        {showGeneratePrompt && ventureToGenerate && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-4xl w-full flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
              {/* Header with Step Indicator */}
              <div className="p-5 border-b flex-shrink-0">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h2 className="text-lg font-semibold text-slate-900">Generate Documents</h2>
                    <p className="text-sm text-slate-500">{ventureToGenerate.legalName}</p>
                  </div>
                  <button onClick={() => {
                    setShowGeneratePrompt(false);
                    setShowScriptSection(false);
                    setSkippedFields(false);
                  }} className="p-2 hover:bg-slate-100 rounded -mt-1 -mr-1"><X className="w-5 h-5" /></button>
                </div>
                
                {/* Step Progress */}
                <div className="flex items-center gap-2">
                  <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium ${!showScriptSection ? 'bg-blue-600 text-white' : 'bg-green-100 text-green-700'}`}>
                    {showScriptSection ? <CheckCircle className="w-4 h-4" /> : <span className="w-5 h-5 flex items-center justify-center">1</span>}
                    Select Documents
                  </div>
                  <div className="w-8 h-0.5 bg-slate-200"></div>
                  <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium ${showScriptSection ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-400'}`}>
                    <span className="w-5 h-5 flex items-center justify-center">2</span>
                    Generate Script
                  </div>
                </div>
              </div>
              
              <div className="flex-1 overflow-y-auto min-h-0 p-5">
                {!showScriptSection && (
                  <>
                    {/* Quick Presets */}
                    <div className="mb-6">
                      <h4 className="text-sm font-medium text-slate-700 mb-3">Quick Presets</h4>
                      <div className="grid grid-cols-3 gap-3">
                        {/* Formation Package */}
                        <button
                          onClick={() => {
                            setGenerateOptions({
                              ...generateOptions,
                              docs: {
                                ...Object.fromEntries(Object.keys(generateOptions.docs).map(k => [k, false])),
                                certificateOfIncorporation: true,
                                bylaws: true,
                                actionOfIncorporator: true,
                                organizationalResolutions: true,
                                restrictedStockPurchaseAgreement: true,
                                equityIncentivePlan: true,
                                equityPlanStockholderConsent: true,
                              },
                              individualSafes: false,
                              individualOptions: false,
                              individualAdvisors: false,
                            });
                          }}
                          className={`p-4 rounded-xl border-2 text-left transition-all hover:shadow-md ${
                            generateOptions.docs.certificateOfIncorporation && 
                            generateOptions.docs.bylaws && 
                            !generateOptions.individualSafes && 
                            !generateOptions.individualOptions
                              ? 'border-blue-500 bg-blue-50' 
                              : 'border-slate-200 hover:border-blue-300'
                          }`}
                        >
                          <div className="flex items-center gap-2 mb-2">
                            <div className="p-2 bg-blue-100 rounded-lg">
                              <Building2 className="w-5 h-5 text-blue-600" />
                            </div>
                            <span className="font-semibold text-slate-800">Formation Package</span>
                          </div>
                          <p className="text-xs text-slate-500">7 incorporation docs (Certificate, Bylaws, Resolutions, Stock Purchase, etc.)</p>
                        </button>

                        {/* All SAFEs */}
                        {(ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length > 0 && (
                          <button
                            onClick={() => {
                              setGenerateOptions({
                                ...generateOptions,
                                docs: Object.fromEntries(Object.keys(generateOptions.docs).map(k => [k, false])),
                                individualSafes: true,
                                individualOptions: false,
                                individualAdvisors: false,
                              });
                            }}
                            className={`p-4 rounded-xl border-2 text-left transition-all hover:shadow-md ${
                              generateOptions.individualSafes && 
                              !generateOptions.docs.certificateOfIncorporation && 
                              !generateOptions.individualOptions
                                ? 'border-green-500 bg-green-50' 
                                : 'border-slate-200 hover:border-green-300'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-2">
                              <div className="p-2 bg-green-100 rounded-lg">
                                <DollarSign className="w-5 h-5 text-green-600" />
                              </div>
                              <span className="font-semibold text-slate-800">All SAFEs</span>
                            </div>
                            <p className="text-xs text-slate-500">
                              {(ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length} SAFE agreement{(ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length !== 1 ? 's' : ''} for your investors
                            </p>
                          </button>
                        )}

                        {/* All Option Grants */}
                        {(ventureToGenerate.employeeGrants || []).length > 0 && (
                          <button
                            onClick={() => {
                              setGenerateOptions({
                                ...generateOptions,
                                docs: Object.fromEntries(Object.keys(generateOptions.docs).map(k => [k, false])),
                                individualSafes: false,
                                individualOptions: true,
                                individualAdvisors: false,
                              });
                            }}
                            className={`p-4 rounded-xl border-2 text-left transition-all hover:shadow-md ${
                              generateOptions.individualOptions && 
                              !generateOptions.docs.certificateOfIncorporation && 
                              !generateOptions.individualSafes
                                ? 'border-purple-500 bg-purple-50' 
                                : 'border-slate-200 hover:border-purple-300'
                            }`}
                          >
                            <div className="flex items-center gap-2 mb-2">
                              <div className="p-2 bg-purple-100 rounded-lg">
                                <Users className="w-5 h-5 text-purple-600" />
                              </div>
                              <span className="font-semibold text-slate-800">All Option Grants</span>
                            </div>
                            <p className="text-xs text-slate-500">
                              {(ventureToGenerate.employeeGrants || []).length} employee option agreement{(ventureToGenerate.employeeGrants || []).length !== 1 ? 's' : ''}
                            </p>
                          </button>
                        )}

                        {/* Everything */}
                        <button
                          onClick={() => {
                            setGenerateOptions({
                              ...generateOptions,
                              docs: {
                                ...generateOptions.docs,
                                certificateOfIncorporation: true,
                                bylaws: true,
                                actionOfIncorporator: true,
                                organizationalResolutions: true,
                                restrictedStockPurchaseAgreement: true,
                                equityIncentivePlan: true,
                                equityPlanStockholderConsent: true,
                              },
                              individualSafes: (ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length > 0,
                              individualOptions: (ventureToGenerate.employeeGrants || []).length > 0,
                              individualAdvisors: (ventureToGenerate.advisorGrants || []).length > 0,
                            });
                          }}
                          className={`p-4 rounded-xl border-2 text-left transition-all hover:shadow-md border-slate-200 hover:border-emerald-300`}
                        >
                          <div className="flex items-center gap-2 mb-2">
                            <div className="p-2 bg-emerald-100 rounded-lg">
                              <Zap className="w-5 h-5 text-emerald-600" />
                            </div>
                            <span className="font-semibold text-slate-800">Everything</span>
                          </div>
                          <p className="text-xs text-slate-500">Formation + all individual documents</p>
                        </button>
                      </div>
                    </div>

                    <div className="border-t pt-5 mb-5">
                      <h4 className="text-sm font-medium text-slate-700 mb-3">Or customize your selection:</h4>
                    </div>

                    {/* Overwrite Option */}
                    <div className="mb-6 p-3 bg-amber-50 rounded-lg border border-amber-200">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" checked={generateOptions.overwrite} onChange={e => setGenerateOptions({...generateOptions, overwrite: e.target.checked})} className="rounded border-orange-400" />
                        <span className="font-medium text-orange-700">⚠️ Overwrite existing documents</span>
                      </label>
                      <p className="text-xs text-slate-600 mt-1 ml-6">If checked, existing documents with the same name will be replaced. If unchecked, they will be skipped.</p>
                    </div>
                  </>
                )}

                {!showScriptSection && (
                  <>
                {/* Individual Documents - Primary Focus */}
                <div className="mb-6">
                  <h4 className="font-semibold text-lg mb-3 flex items-center gap-2">
                    <Users className="w-5 h-5 text-teal-600" />
                    Individual Documents
                    {((ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length > 0 ||
                      (ventureToGenerate.employeeGrants || []).length > 0 ||
                      (ventureToGenerate.advisorGrants || []).length > 0) && (
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Ready to Generate</span>
                    )}
                  </h4>
                  <p className="text-sm text-slate-600 mb-4">Documents customized for specific investors, employees, and advisors. Document type is determined by the selection made when adding each person.</p>
                  
                  {/* Show message if no individual data */}
                  {(ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length === 0 &&
                   (ventureToGenerate.employeeGrants || []).length === 0 &&
                   (ventureToGenerate.advisorGrants || []).length === 0 && (
                    <div className="p-4 bg-slate-50 rounded-lg border-2 border-dashed border-slate-200 text-center">
                      <p className="text-slate-600 text-sm">No individual documents to generate yet.</p>
                      <p className="text-slate-500 text-xs mt-1">Add SAFE investors, employee grants, or advisor grants to generate personalized documents.</p>
                    </div>
                  )}
                  
                  <div className="space-y-3">
                    {/* SAFE Investors */}
                    {(ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length > 0 && (
                      <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                        <div className="flex items-center gap-3 mb-3">
                          <input 
                            type="checkbox" 
                            checked={generateOptions.individualSafes} 
                            onChange={e => setGenerateOptions({...generateOptions, individualSafes: e.target.checked})} 
                            className="rounded" 
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-green-900">SAFE Investment Agreements</div>
                            <p className="text-xs text-green-700">Y Combinator Post-Money SAFE documents customized for each investor</p>
                          </div>
                          <span className="text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded">✓ Data Complete</span>
                        </div>
                        <div className="ml-7 space-y-2">
                          {(ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').map((s, i) => (
                            <div key={i} className="py-2 px-3 bg-white rounded border text-sm">
                              <div className="flex items-center justify-between mb-1">
                                <span className="font-medium text-slate-900">
                                  {s.safeTemplate === 'mfn' 
                                    ? `Post-Money SAFE (MFN) - ${s.investorName}` 
                                    : `Post-Money SAFE (Valuation Cap) - ${s.investorName}`}
                                </span>
                                <span className="text-slate-500 text-xs">${(s.amount || 0).toLocaleString()}</span>
                              </div>
                              <div className="text-xs text-slate-500">
                                {s.safeTemplate === 'mfn' 
                                  ? 'Simple Agreement for Future Equity with Most Favored Nation clause'
                                  : `Simple Agreement for Future Equity with $${(s.valuationCap || 0).toLocaleString()} post-money valuation cap`}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Employee Option Grants */}
                    {(ventureToGenerate.employeeGrants || []).length > 0 && (
                      <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <div className="flex items-center gap-3 mb-3">
                          <input 
                            type="checkbox" 
                            checked={generateOptions.individualOptions} 
                            onChange={e => setGenerateOptions({...generateOptions, individualOptions: e.target.checked})} 
                            className="rounded" 
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-purple-900">Stock Option Agreements</div>
                            <p className="text-xs text-purple-700">Option grants under the {ventureToGenerate.equityPlanYear} Equity Incentive Plan</p>
                          </div>
                          <span className="text-xs bg-purple-200 text-purple-800 px-2 py-0.5 rounded">✓ Data Complete</span>
                        </div>
                        <div className="ml-7 space-y-2">
                          {(ventureToGenerate.employeeGrants || []).map((e, i) => (
                            <div key={i} className="py-2 px-3 bg-white rounded border text-sm">
                              <div className="flex items-center justify-between mb-1">
                                <span className="font-medium text-slate-900">
                                  {e.optionAgreementType === 'earlyExercise' 
                                    ? `Early Exercise Stock Option Agreement (${e.grantType}) - ${e.employeeName}`
                                    : `Stock Option Agreement (${e.grantType}) - ${e.employeeName}`}
                                </span>
                                <span className="text-slate-500 text-xs">{(e.shares || 0).toLocaleString()} shares</span>
                              </div>
                              <div className="text-xs text-slate-500">
                                {e.optionAgreementType === 'earlyExercise' 
                                  ? `${e.grantType === 'ISO' ? 'Incentive' : 'Non-Qualified'} Stock Option with early exercise rights (83(b) eligible) at $${(e.exercisePrice || 0).toFixed(4)}/share`
                                  : `${e.grantType === 'ISO' ? 'Incentive' : 'Non-Qualified'} Stock Option exercisable after vesting at $${(e.exercisePrice || 0).toFixed(4)}/share`}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Advisor/Consultant Grants */}
                    {(ventureToGenerate.advisorGrants || []).length > 0 && (
                      <div className="p-4 bg-orange-50 rounded-lg border border-orange-200">
                        <div className="flex items-center gap-3 mb-3">
                          <input 
                            type="checkbox" 
                            checked={generateOptions.individualAdvisors} 
                            onChange={e => setGenerateOptions({...generateOptions, individualAdvisors: e.target.checked})} 
                            className="rounded" 
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-orange-900">Advisor & Consultant Agreements</div>
                            <p className="text-xs text-orange-700">Service agreements with equity compensation</p>
                          </div>
                          <span className="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded">✓ Data Complete</span>
                        </div>
                        <div className="ml-7 space-y-2">
                          {(ventureToGenerate.advisorGrants || []).map((a, i) => (
                            <div key={i} className="py-2 px-3 bg-white rounded border text-sm">
                              <div className="flex items-center justify-between mb-1">
                                <span className="font-medium text-slate-900">
                                  {a.agreementType === 'consulting' 
                                    ? `Consulting Agreement - ${a.advisorName}`
                                    : a.agreementType === 'ipStockPurchase'
                                    ? `Restricted Stock Purchase Agreement (IP Assignment) - ${a.advisorName}`
                                    : `Advisor Agreement - ${a.advisorName}`}
                                </span>
                                <span className="text-slate-500 text-xs">{(a.shares || 0).toLocaleString()} shares</span>
                              </div>
                              <div className="text-xs text-slate-500">
                                {a.agreementType === 'consulting' 
                                  ? `Independent contractor agreement with NSO grant of ${(a.shares || 0).toLocaleString()} shares at $${(a.exercisePrice || 0).toFixed(4)}/share`
                                  : a.agreementType === 'ipStockPurchase'
                                  ? `Restricted stock purchase for intellectual property assignment - ${(a.shares || 0).toLocaleString()} shares at $${(a.exercisePrice || 0).toFixed(4)}/share (83(b) election required)`
                                  : `Strategic advisor agreement with NSO grant of ${(a.shares || 0).toLocaleString()} shares at $${(a.exercisePrice || 0).toFixed(4)}/share`}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Formation Documents - Always Important */}
                <div className="mb-6">
                  <h4 className="font-semibold text-lg mb-3 flex items-center gap-2">
                    <FileText className="w-5 h-5 text-blue-600" />
                    Formation Documents
                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">Required</span>
                    <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">✓ Data Complete</span>
                  </h4>
                  <p className="text-sm text-slate-600 mb-4">Core corporate documents needed to properly form and organize your company. All fields will be auto-filled with your venture data.</p>
                  
                  <div className="space-y-2">
                    {Object.values(documentDefinitions).filter(d => d.category === 'formation').map(doc => (
                      <div key={doc.id} className="flex items-start gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <input 
                          type="checkbox" 
                          checked={generateOptions.docs[doc.id]} 
                          onChange={e => setGenerateOptions({
                            ...generateOptions, 
                            docs: {...generateOptions.docs, [doc.id]: e.target.checked}
                          })} 
                          className="mt-1 rounded" 
                        />
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-sm">{doc.name}</div>
                          <p className="text-xs text-slate-600 mt-0.5">{doc.brief}</p>
                        </div>
                        <button 
                          onClick={() => setDocLearnMore(doc)}
                          className="flex-shrink-0 text-xs px-2 py-1 text-blue-600 hover:bg-blue-100 rounded flex items-center gap-1"
                        >
                          <Info className="w-3 h-3" /> Learn more
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Template Documents - Collapsible */}
                <div className="mb-6">
                  <button 
                    onClick={() => setShowTemplateDocuments(!showTemplateDocuments)}
                    className="w-full flex items-center justify-between p-3 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"
                  >
                    <div className="flex items-center gap-2">
                      <ChevronDown className={`w-5 h-5 text-slate-600 transition-transform ${showTemplateDocuments ? 'rotate-180' : ''}`} />
                      <span className="font-semibold">Template Documents</span>
                      <span className="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded">Optional - Blank Templates</span>
                    </div>
                    <span className="text-xs text-slate-500">
                      {showTemplateDocuments ? 'Hide' : 'Show'}
                    </span>
                  </button>
                  
                  {showTemplateDocuments && (
                    <div className="mt-4 space-y-4 pl-4 border-l-2 border-slate-200">
                      {/* Explanation */}
                      <div className="p-3 bg-amber-50 rounded-lg border border-amber-200 text-sm">
                        <p className="text-amber-800"><strong>Why are these not selected?</strong></p>
                        <p className="text-amber-700 mt-1">These are blank template documents for reference. They don't contain personalized data - use them when you need to manually fill in agreements for future investors, employees, or advisors. Individual documents (above) are auto-filled with your data.</p>
                      </div>
                      
                      {/* Check All / Uncheck All */}
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            const templateDocs = Object.values(documentDefinitions)
                              .filter(d => ['safeTemplates', 'equityPlan', 'equityPlanForms', 'employment'].includes(d.category))
                              .reduce((acc, doc) => ({ ...acc, [doc.id]: true }), {});
                            setGenerateOptions({
                              ...generateOptions,
                              docs: { ...generateOptions.docs, ...templateDocs }
                            });
                          }}
                          className="px-3 py-1.5 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                        >
                          ✓ Check All Templates
                        </button>
                        <button
                          onClick={() => {
                            const templateDocs = Object.values(documentDefinitions)
                              .filter(d => ['safeTemplates', 'equityPlan', 'equityPlanForms', 'employment'].includes(d.category))
                              .reduce((acc, doc) => ({ ...acc, [doc.id]: false }), {});
                            setGenerateOptions({
                              ...generateOptions,
                              docs: { ...generateOptions.docs, ...templateDocs }
                            });
                          }}
                          className="px-3 py-1.5 text-xs bg-slate-200 text-slate-700 rounded hover:bg-slate-300 font-medium"
                        >
                          ✗ Uncheck All Templates
                        </button>
                      </div>
                      
                      {/* SAFE Templates */}
                      <div>
                        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-green-200">
                          <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                          <span className="font-semibold text-green-900 text-sm">SAFE Agreement Templates</span>
                          <span className="text-xs text-slate-400">(blank templates)</span>
                        </div>
                        <div className="space-y-2">
                          {Object.values(documentDefinitions).filter(d => d.category === 'safeTemplates').map(doc => (
                            <div key={doc.id} className="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border">
                              <input 
                                type="checkbox" 
                                checked={generateOptions.docs[doc.id]} 
                                onChange={e => setGenerateOptions({
                                  ...generateOptions, 
                                  docs: {...generateOptions.docs, [doc.id]: e.target.checked}
                                })} 
                                className="mt-1 rounded" 
                              />
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm">{doc.name}</div>
                                <p className="text-xs text-slate-600 mt-0.5">{doc.brief}</p>
                              </div>
                              <button 
                                onClick={() => setDocLearnMore(doc)}
                                className="flex-shrink-0 text-xs px-2 py-1 text-blue-600 hover:bg-blue-100 rounded flex items-center gap-1"
                              >
                                <Info className="w-3 h-3" /> Learn more
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Equity Plan Core Documents */}
                      <div>
                        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-purple-200">
                          <div className="w-2 h-2 bg-purple-500 rounded-full"></div>
                          <span className="font-semibold text-purple-900 text-sm">Equity Plan Core Documents</span>
                          <span className="text-xs text-slate-400">(option agreements)</span>
                        </div>
                        <div className="space-y-2">
                          {Object.values(documentDefinitions).filter(d => d.category === 'equityPlan').map(doc => (
                            <div key={doc.id} className="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border">
                              <input 
                                type="checkbox" 
                                checked={generateOptions.docs[doc.id]} 
                                onChange={e => setGenerateOptions({
                                  ...generateOptions, 
                                  docs: {...generateOptions.docs, [doc.id]: e.target.checked}
                                })} 
                                className="mt-1 rounded" 
                              />
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm">{doc.name}</div>
                                <p className="text-xs text-slate-600 mt-0.5">{doc.brief}</p>
                              </div>
                              <button 
                                onClick={() => setDocLearnMore(doc)}
                                className="flex-shrink-0 text-xs px-2 py-1 text-blue-600 hover:bg-blue-100 rounded flex items-center gap-1"
                              >
                                <Info className="w-3 h-3" /> Learn more
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Equity Plan Forms (Exercise Agreements, RSPAs) */}
                      <div>
                        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-indigo-200">
                          <div className="w-2 h-2 bg-indigo-500 rounded-full"></div>
                          <span className="font-semibold text-indigo-900 text-sm">Equity Plan Forms</span>
                          <span className="text-xs text-slate-400">(exercise & RSP agreements)</span>
                        </div>
                        <div className="space-y-2">
                          {Object.values(documentDefinitions).filter(d => d.category === 'equityPlanForms').map(doc => (
                            <div key={doc.id} className="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border">
                              <input 
                                type="checkbox" 
                                checked={generateOptions.docs[doc.id]} 
                                onChange={e => setGenerateOptions({
                                  ...generateOptions, 
                                  docs: {...generateOptions.docs, [doc.id]: e.target.checked}
                                })} 
                                className="mt-1 rounded" 
                              />
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm">{doc.name}</div>
                                <p className="text-xs text-slate-600 mt-0.5">{doc.brief}</p>
                              </div>
                              <button 
                                onClick={() => setDocLearnMore(doc)}
                                className="flex-shrink-0 text-xs px-2 py-1 text-blue-600 hover:bg-blue-100 rounded flex items-center gap-1"
                              >
                                <Info className="w-3 h-3" /> Learn more
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Employment & Advisor */}
                      <div>
                        <div className="flex items-center gap-2 mb-2 pb-2 border-b border-orange-200">
                          <div className="w-2 h-2 bg-orange-500 rounded-full"></div>
                          <span className="font-semibold text-orange-900 text-sm">Employment & Advisor Templates</span>
                          <span className="text-xs text-slate-400">(blank templates)</span>
                        </div>
                        <div className="space-y-2">
                          {Object.values(documentDefinitions).filter(d => d.category === 'employment').map(doc => (
                            <div key={doc.id} className="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border">
                              <input 
                                type="checkbox" 
                                checked={generateOptions.docs[doc.id]} 
                                onChange={e => setGenerateOptions({
                                  ...generateOptions, 
                                  docs: {...generateOptions.docs, [doc.id]: e.target.checked}
                                })} 
                                className="mt-1 rounded" 
                              />
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm">{doc.name}</div>
                                <p className="text-xs text-slate-600 mt-0.5">{doc.brief}</p>
                              </div>
                              <button 
                                onClick={() => setDocLearnMore(doc)}
                                className="flex-shrink-0 text-xs px-2 py-1 text-blue-600 hover:bg-blue-100 rounded flex items-center gap-1"
                              >
                                <Info className="w-3 h-3" /> Learn more
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                  </>
                )}

                {/* Script Section - Only shown after user clicks Continue */}
                {showScriptSection && (
                  <>
                    {/* Skipped Fields Warning */}
                    {skippedFields && (
                      <div className="mb-6 p-4 bg-red-50 rounded-lg border border-red-200">
                        <div className="flex items-start gap-3">
                          <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                          <div>
                            <div className="font-semibold text-red-800">Some fields were skipped</div>
                            <p className="text-sm text-red-700 mt-1">
                              You chose not to fill in some optional fields. Unfilled placeholders, blank lines (____), and skipped fields 
                              will be <span className="font-semibold bg-red-200 px-1 rounded">highlighted in red</span> in your documents for easy identification.
                            </p>
                          </div>
                        </div>
                      </div>
                    )}

                <div className="mb-6">
                  <h3 className="font-bold text-lg mb-4">📋 Step-by-Step Instructions</h3>
                  <div className="space-y-4">
                    <div className="flex gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                      <div className="flex-1">
                        <div className="font-semibold text-blue-900">Copy the Script</div>
                        <p className="text-sm text-blue-700 mb-3">Click the button below to copy the generated script to your clipboard.</p>
                        <button 
                          onClick={async () => {
                            navigator.clipboard.writeText(generateAppsScript(ventureToGenerate, generateOptions));
                            
                            // Build list of document names being generated
                            const documentNames = [];
                            
                            // Formation docs
                            Object.entries(generateOptions.docs).forEach(([key, val]) => {
                              if (val && documentDefinitions[key]) {
                                documentNames.push(`${ventureToGenerate.legalName} - ${documentDefinitions[key].name}`);
                              }
                            });
                            
                            // Individual SAFEs
                            if (generateOptions.individualSafes) {
                              (ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').forEach(safe => {
                                const templateType = safe.safeTemplate === 'mfn' ? 'MFN' : 'Valuation Cap';
                                documentNames.push(`${ventureToGenerate.legalName} - Post-Money SAFE (${templateType}) - ${safe.investorName}`);
                              });
                            }
                            
                            // Individual Options
                            if (generateOptions.individualOptions) {
                              (ventureToGenerate.employeeGrants || []).forEach(grant => {
                                const agreementType = grant.optionAgreementType === 'earlyExercise' ? 'Early Exercise' : 'Standard';
                                documentNames.push(`${ventureToGenerate.legalName} - Option Agreement (${agreementType}) - ${grant.employeeName}`);
                              });
                            }
                            
                            // Individual Advisors
                            if (generateOptions.individualAdvisors) {
                              (ventureToGenerate.advisorGrants || []).forEach(grant => {
                                const agreementType = grant.agreementType === 'consulting' ? 'Consulting Agreement' :
                                                      grant.agreementType === 'corporateConsulting' ? 'Corporate Consulting Agreement' :
                                                      grant.agreementType === 'ipStockPurchase' ? 'Restricted Stock Purchase Agreement (IP Assignment)' :
                                                      'Advisor Agreement';
                                documentNames.push(`${ventureToGenerate.legalName} - ${agreementType} - ${grant.advisorName}`);
                              });
                            }
                            
                            // Create single batch audit entry
                            if (documentNames.length > 0) {
                              const auditEntry = {
                                generatedAt: new Date().toISOString(),
                                documentsGenerated: documentNames,
                                overwriteEnabled: generateOptions.overwrite === true,
                                dataSnapshot: {
                                  legalName: ventureToGenerate.legalName,
                                  state: ventureToGenerate.state,
                                  totalSAFEs: (ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length,
                                  totalEmployees: (ventureToGenerate.employeeGrants || []).length,
                                  totalAdvisors: (ventureToGenerate.advisorGrants || []).length,
                                  presidentName: ventureToGenerate.presidentName || '[not set]',
                                  secretaryName: ventureToGenerate.secretaryName || '[not set]',
                                }
                              };
                              
                              const existingLog = ventureToGenerate.documentAuditLog || [];
                              const updatedVenture = {
                                ...ventureToGenerate,
                                documentAuditLog: [...existingLog, auditEntry]
                              };
                              
                              // Save to storage
                              try {
                                await window.storage.set(`venture:${updatedVenture.id}`, JSON.stringify(updatedVenture));
                                setVentures(prev => prev.map(v => v.id === updatedVenture.id ? updatedVenture : v));
                                if (selectedVenture?.id === updatedVenture.id) {
                                  setSelectedVenture(updatedVenture);
                                }
                                setVentureToGenerate(updatedVenture);
                              } catch (e) {
                                console.error('Failed to save audit log:', e);
                              }
                            }
                            
                            showToast('Script copied to clipboard!', 'success');
                          }} 
                          className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium text-sm"
                        >
                          📋 Copy Script to Clipboard
                        </button>
                      </div>
                    </div>
                    <div className="flex gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">2</div>
                      <div>
                        <div className="font-semibold text-blue-900">Open Google Apps Script</div>
                        <p className="text-sm text-blue-700 mb-2">Click this link to open the script editor:</p>
                        <a href="https://script.google.com/home/projects/create" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                          Open Google Apps Script →
                        </a>
                      </div>
                    </div>
                    <div className="flex gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">3</div>
                      <div>
                        <div className="font-semibold text-blue-900">Paste & Save</div>
                        <p className="text-sm text-blue-700">Select all default code (Ctrl+A), paste (Ctrl+V), then <strong>save the project (Ctrl+S)</strong>.</p>
                      </div>
                    </div>
                    <div className="flex gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">4</div>
                      <div>
                        <div className="font-semibold text-blue-900">Select Function & Run</div>
                        <p className="text-sm text-blue-700">In the toolbar, select <strong>"createVentureDocuments"</strong> from the dropdown next to Run, then click <strong>Run</strong> (▶️). First time: click "Review Permissions" → "Advanced" → "Go to Untitled project" → "Allow".</p>
                      </div>
                    </div>
                    <div className="flex gap-4 p-4 bg-green-50 rounded-lg border border-green-200">
                      <div className="flex-shrink-0 w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold">5</div>
                      <div>
                        <div className="font-semibold text-green-900">Done!</div>
                        <p className="text-sm text-green-700">Check Execution Log (View → Logs) for your folder link and summary of created/skipped/updated files.</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div className="mb-6 p-4 bg-slate-50 rounded-lg border">
                  <h4 className="font-semibold mb-2">🔧 What This Script Does:</h4>
                  <ul className="text-sm space-y-1 text-slate-700">
                    <li>✓ Creates folder: VENTURES / {ventureToGenerate.legalName}</li>
                    <li>✓ Creates subfolders with company name:</li>
                    {generateOptions.formation && <li className="ml-4">• {ventureToGenerate.legalName} - Formation Documents</li>}
                    {generateOptions.safeTemplates && <li className="ml-4">• {ventureToGenerate.legalName} - SAFE Agreements</li>}
                    {generateOptions.equityPlan && <li className="ml-4">• {ventureToGenerate.legalName} - Equity Plan Forms</li>}
                    {generateOptions.employment && <li className="ml-4">• {ventureToGenerate.legalName} - Employment and Advisor Agreements</li>}
                    <li>✓ Renames documents with "{ventureToGenerate.legalName} - " prefix</li>
                    <li>✓ Replaces all template values with your data</li>
                    <li>✓ <span className="text-green-600">Highlights filled fields in green</span> for QA</li>
                    <li>✓ <span className="text-red-600">Highlights unfilled placeholders, blank lines (____), and missing fields in red</span></li>
                    <li>✓ {generateOptions.overwrite ? 'OVERWRITES existing documents' : 'SKIPS existing documents (safe mode)'}</li>
                  </ul>
                  
                  {((ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').length > 0 ||
                    (ventureToGenerate.employeeGrants || []).length > 0 ||
                    (ventureToGenerate.advisorGrants || []).length > 0) && (
                    <div className="mt-4 pt-4 border-t">
                      <h4 className="font-semibold mb-2">📄 Individual Documents to Generate:</h4>
                      <ul className="text-sm space-y-1 text-slate-700">
                        {generateOptions.individualSafes && (ventureToGenerate.fundingRounds || []).filter(f => f.type === 'SAFE').map((safe, i) => (
                          <li key={i} className="flex items-center gap-2">
                            <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                            {ventureToGenerate.legalName} - SAFE Agreement - {safe.investorName}
                          </li>
                        ))}
                        {generateOptions.individualOptions && (ventureToGenerate.employeeGrants || []).map((emp, i) => (
                          <li key={i} className="flex items-center gap-2">
                            <span className="w-2 h-2 bg-purple-500 rounded-full"></span>
                            {ventureToGenerate.legalName} - {emp.grantType} Option Agreement - {emp.employeeName}
                          </li>
                        ))}
                        {generateOptions.individualAdvisors && (ventureToGenerate.advisorGrants || []).map((adv, i) => (
                          <li key={i} className="flex items-center gap-2">
                            <span className="w-2 h-2 bg-orange-500 rounded-full"></span>
                            {ventureToGenerate.legalName} - Advisor Agreement - {adv.advisorName}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                  
                  <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded text-sm">
                    <strong className="text-amber-800">⚠️ Important:</strong>
                    <span className="text-amber-700"> To generate individual SAFE, Employee, and Advisor documents, you'll need to update the <code className="bg-amber-100 px-1 rounded">TEMPLATE_DOCS</code> section in the script with your actual Google Doc template IDs.</span>
                  </div>
                </div>
                <div>
                  <h4 className="font-semibold mb-2">📄 Your Custom Script:</h4>
                  <div className="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-64">
                    <pre>{generateAppsScript(ventureToGenerate, generateOptions)}</pre>
                  </div>
                </div>
                  </>
                )}
              </div>
              <div className="p-5 border-t flex justify-between items-center flex-shrink-0 bg-slate-50">
                <button 
                  onClick={() => {
                    setShowGeneratePrompt(false);
                    setShowScriptSection(false);
                    setSkippedFields(false);
                  }} 
                  className="px-4 py-2 hover:bg-slate-200 rounded"
                >
                  {showScriptSection ? 'Close' : 'Cancel'}
                </button>
                {!showScriptSection && (
                  <button 
                    onClick={() => {
                      // Check for missing fields based on SELECTED documents
                      const missingFields = getMissingFieldsForGeneration(ventureToGenerate, generateOptions);
                      
                      if (missingFields.hasRequired || missingFields.hasOptional) {
                        // Show pre-generate modal to optionally collect missing fields
                        setShowPreGenerate(true);
                      } else {
                        // No missing fields, show script directly
                        setShowScriptSection(true);
                      }
                    }}
                    className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center gap-2"
                  >
                    Continue to Generate <ChevronRight className="w-4 h-4" />
                  </button>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Document Learn More Modal */}
        {docLearnMore && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[100]" onClick={() => setDocLearnMore(null)}>
            <div 
              className="bg-white rounded-xl max-w-2xl w-full flex flex-col"
              style={{ maxHeight: 'calc(100vh - 2rem)' }}
              onClick={e => e.stopPropagation()}
            >
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <div>
                  <h2 className="text-lg font-semibold">{docLearnMore.name}</h2>
                  <p className="text-sm text-slate-500">{docLearnMore.required ? 'Required Document' : 'Optional Document'}</p>
                </div>
                <button onClick={() => setDocLearnMore(null)} className="p-2 hover:bg-slate-100 rounded">
                  <X className="w-5 h-5" />
                </button>
              </div>
              <div style={{ flex: '1 1 auto', overflowY: 'auto', minHeight: 0 }} className="p-5">
                <div className="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                  <p className="text-blue-800 font-medium">{docLearnMore.brief}</p>
                </div>
                <div className="whitespace-pre-line text-slate-700 leading-relaxed mb-6">
                  {docLearnMore.detailed}
                </div>
                
                {/* Fields Updated Section */}
                {docLearnMore.fieldsUpdated && docLearnMore.fieldsUpdated.length > 0 && (
                  <div className="mt-6 pt-4 border-t border-slate-200">
                    <h3 className="font-semibold text-slate-900 mb-3 flex items-center gap-2">
                      <FileText className="w-4 h-4 text-green-600" />
                      Fields Updated by Script
                    </h3>
                    <p className="text-sm text-slate-600 mb-3">
                      The following fields in this document will be automatically populated with your venture data:
                    </p>
                    <div className="bg-slate-50 rounded-lg border p-3">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="border-b border-slate-200">
                            <th className="text-left pb-2 font-medium text-slate-700">Document Field</th>
                            <th className="text-left pb-2 font-medium text-slate-700">Your Data Source</th>
                          </tr>
                        </thead>
                        <tbody>
                          {docLearnMore.fieldsUpdated.map((field, idx) => (
                            <tr key={idx} className={idx < docLearnMore.fieldsUpdated.length - 1 ? 'border-b border-slate-100' : ''}>
                              <td className="py-2 text-slate-600">{field.field}</td>
                              <td className="py-2">
                                <span className="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">
                                  {field.source}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
              <div className="p-5 border-t flex justify-end flex-shrink-0 bg-slate-50">
                <button onClick={() => setDocLearnMore(null)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                  Got it
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Individual Document Generation Modal */}
        {showIndividualGenerate && individualDocData && selectedVenture && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-3xl w-full flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
              <div className={`p-5 border-b flex justify-between items-center flex-shrink-0 ${
                individualDocType === 'safe' ? 'bg-green-50' : 
                individualDocType === 'employee' ? 'bg-purple-50' : 'bg-orange-50'
              }`}>
                <div>
                  <h2 className={`text-lg font-semibold ${
                    individualDocType === 'safe' ? 'text-green-900' : 
                    individualDocType === 'employee' ? 'text-purple-900' : 'text-orange-900'
                  }`}>
                    {individualDocType === 'safe' && (individualDocData.safeTemplate === 'mfn' 
                      ? `Generate Post-Money SAFE (MFN)` 
                      : `Generate Post-Money SAFE (Valuation Cap)`)}
                    {individualDocType === 'employee' && (individualDocData.optionAgreementType === 'earlyExercise'
                      ? `Generate Early Exercise Stock Option Agreement (${individualDocData.grantType})`
                      : `Generate Stock Option Agreement (${individualDocData.grantType})`)}
                    {individualDocType === 'advisor' && (
                      individualDocData.agreementType === 'consulting' ? `Generate Consulting Agreement` :
                      individualDocData.agreementType === 'ipStockPurchase' ? `Generate Restricted Stock Purchase Agreement (IP Assignment)` :
                      `Generate Advisor Agreement`
                    )}
                  </h2>
                  <p className={`text-sm ${
                    individualDocType === 'safe' ? 'text-green-700' : 
                    individualDocType === 'employee' ? 'text-purple-700' : 'text-orange-700'
                  }`}>
                    {individualDocType === 'safe' && `For investor: ${individualDocData.investorName}`}
                    {individualDocType === 'employee' && `For employee: ${individualDocData.employeeName}`}
                    {individualDocType === 'advisor' && `For: ${individualDocData.advisorName}`}
                  </p>
                </div>
                <button onClick={() => setShowIndividualGenerate(false)} className="p-2 hover:bg-white/50 rounded"><X className="w-5 h-5" /></button>
              </div>
              <div className="flex-1 overflow-y-auto min-h-0 p-5">
                {/* Document Preview */}
                <div className="mb-6 p-4 bg-slate-50 rounded-lg border">
                  <h4 className="font-semibold mb-3">📄 Document Details:</h4>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div><span className="text-slate-500">Company:</span> <strong>{selectedVenture.legalName}</strong></div>
                    {individualDocType === 'safe' && (
                      <>
                        <div><span className="text-slate-500">Investor:</span> <strong>{individualDocData.investorName}</strong></div>
                        <div><span className="text-slate-500">SAFE Type:</span> <strong>{individualDocData.safeTemplate === 'mfn' ? 'MFN (Most Favored Nation)' : 'Valuation Cap'}</strong></div>
                        <div><span className="text-slate-500">Amount:</span> <strong>${(individualDocData.amount || 0).toLocaleString()}</strong></div>
                        {individualDocData.safeTemplate !== 'mfn' && (
                          <div><span className="text-slate-500">Valuation Cap:</span> <strong>${(individualDocData.valuationCap || 0).toLocaleString()}</strong></div>
                        )}
                        <div><span className="text-slate-500">Discount:</span> <strong>{individualDocData.discount || 0}%</strong></div>
                        <div><span className="text-slate-500">Date:</span> <strong>{individualDocData.date}</strong></div>
                      </>
                    )}
                    {individualDocType === 'employee' && (
                      <>
                        <div><span className="text-slate-500">Employee:</span> <strong>{individualDocData.employeeName}</strong></div>
                        <div><span className="text-slate-500">Option Type:</span> <strong>{individualDocData.grantType === 'ISO' ? 'Incentive Stock Option' : 'Non-Qualified Stock Option'}</strong></div>
                        <div><span className="text-slate-500">Agreement Type:</span> <strong>{individualDocData.optionAgreementType === 'earlyExercise' ? 'Early Exercise (83(b) eligible)' : 'Standard (exercise after vesting)'}</strong></div>
                        <div><span className="text-slate-500">Shares:</span> <strong>{(individualDocData.shares || 0).toLocaleString()}</strong></div>
                        <div><span className="text-slate-500">Exercise Price:</span> <strong>${(individualDocData.exercisePrice || 0).toFixed(4)}</strong></div>
                        <div><span className="text-slate-500">Grant Date:</span> <strong>{individualDocData.grantDate}</strong></div>
                        <div><span className="text-slate-500">Vesting:</span> <strong>{individualDocData.vestingSchedule}</strong></div>
                      </>
                    )}
                    {individualDocType === 'advisor' && (
                      <>
                        <div><span className="text-slate-500">Name:</span> <strong>{individualDocData.advisorName}</strong></div>
                        <div><span className="text-slate-500">Agreement Type:</span> <strong>{
                          individualDocData.agreementType === 'consulting' ? 'Consulting Agreement (Independent Contractor)' :
                          individualDocData.agreementType === 'ipStockPurchase' ? 'Restricted Stock Purchase (IP Assignment)' :
                          'Advisor Agreement (Strategic Guidance)'
                        }</strong></div>
                        <div><span className="text-slate-500">Shares:</span> <strong>{(individualDocData.shares || 0).toLocaleString()}</strong></div>
                        <div><span className="text-slate-500">{individualDocData.agreementType === 'ipStockPurchase' ? 'Purchase Price:' : 'Exercise Price:'}</span> <strong>${(individualDocData.exercisePrice || 0).toFixed(4)}</strong></div>
                        <div><span className="text-slate-500">Effective Date:</span> <strong>{individualDocData.grantDate}</strong></div>
                        <div><span className="text-slate-500">Vesting:</span> <strong>{individualDocData.vestingSchedule}</strong></div>
                        {individualDocData.agreementType === 'ipStockPurchase' && (
                          <div className="col-span-2 p-2 bg-amber-50 border border-amber-200 rounded text-amber-800 text-xs">
                            ⚠️ 83(b) election must be filed within 30 days of signing
                          </div>
                        )}
                      </>
                    )}
                  </div>
                  <div className="mt-4 pt-3 border-t">
                    <div className="text-sm"><span className="text-slate-500">Document Name:</span></div>
                    <div className="font-mono text-sm bg-white p-2 rounded border mt-1">
                      {individualDocType === 'safe' && (individualDocData.safeTemplate === 'mfn'
                        ? `Post-Money SAFE (MFN) - ${individualDocData.investorName}`
                        : `Post-Money SAFE (Valuation Cap) - ${individualDocData.investorName}`)}
                      {individualDocType === 'employee' && (individualDocData.optionAgreementType === 'earlyExercise'
                        ? `Early Exercise Stock Option Agreement (${individualDocData.grantType}) - ${individualDocData.employeeName}`
                        : `Stock Option Agreement (${individualDocData.grantType}) - ${individualDocData.employeeName}`)}
                      {individualDocType === 'advisor' && (
                        individualDocData.agreementType === 'consulting' ? `Consulting Agreement - ${individualDocData.advisorName}` :
                        individualDocData.agreementType === 'ipStockPurchase' ? `Restricted Stock Purchase Agreement (IP Assignment) - ${individualDocData.advisorName}` :
                        `Advisor Agreement - ${individualDocData.advisorName}`
                      )}
                    </div>
                  </div>
                  
                  {/* Overwrite Toggle */}
                  <div className="mt-4 pt-3 border-t">
                    <label className="flex items-center gap-3 cursor-pointer">
                      <div className={`relative w-12 h-6 rounded-full transition-colors ${individualOverwrite ? 'bg-orange-500' : 'bg-slate-300'}`}>
                        <div className={`absolute top-1 w-4 h-4 bg-white rounded-full shadow transition-transform ${individualOverwrite ? 'translate-x-7' : 'translate-x-1'}`}></div>
                        <input 
                          type="checkbox" 
                          checked={individualOverwrite} 
                          onChange={e => setIndividualOverwrite(e.target.checked)} 
                          className="sr-only" 
                        />
                      </div>
                      <div>
                        <span className={`font-medium ${individualOverwrite ? 'text-orange-700' : 'text-slate-600'}`}>
                          {individualOverwrite ? '⚠️ Overwrite if exists' : '✓ Skip if exists'}
                        </span>
                        <p className="text-xs text-slate-500">
                          {individualOverwrite 
                            ? 'If this document already exists, it will be replaced with a new version.' 
                            : 'If this document already exists, no changes will be made.'}
                        </p>
                      </div>
                    </label>
                  </div>
                </div>

                {/* Instructions */}
                <div className="mb-6">
                  <h4 className="font-semibold mb-3">📋 Instructions:</h4>
                  <div className="space-y-3">
                    <div className="flex gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
                      <div className="flex-1">
                        <div className="font-medium text-blue-900">Copy the Script</div>
                        <p className="text-sm text-blue-700 mb-2">Click below to copy the script to your clipboard.</p>
                        <button 
                          onClick={() => {
                            let script = '';
                            if (individualDocType === 'safe') {
                              script = generateSingleSafeScript(selectedVenture, individualDocData, individualOverwrite);
                            } else if (individualDocType === 'employee') {
                              script = generateSingleEmployeeScript(selectedVenture, individualDocData, individualOverwrite);
                            } else if (individualDocType === 'advisor') {
                              script = generateSingleAdvisorScript(selectedVenture, individualDocData, individualOverwrite);
                            }
                            navigator.clipboard.writeText(script);
                            alert('Script copied to clipboard!');
                          }} 
                          className={`px-4 py-2 text-white rounded font-medium text-sm ${
                            individualDocType === 'safe' ? 'bg-green-600 hover:bg-green-700' : 
                            individualDocType === 'employee' ? 'bg-purple-600 hover:bg-purple-700' : 'bg-orange-600 hover:bg-orange-700'
                          }`}
                        >
                          📋 Copy Script to Clipboard
                        </button>
                      </div>
                    </div>
                    <div className="flex gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
                      <div>
                        <div className="font-medium text-blue-900">Open Google Apps Script & Paste</div>
                        <p className="text-sm text-blue-700 mb-2">Open script editor, paste, and save:</p>
                        <a href="https://script.google.com/home/projects/create" target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                          Open Google Apps Script →
                        </a>
                      </div>
                    </div>
                    <div className="flex gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                      <div className="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
                      <div>
                        <div className="font-medium text-blue-900">Run the Function</div>
                        <p className="text-sm text-blue-700">
                          Select <strong>"{individualDocType === 'safe' ? 'createSafeDocument' : individualDocType === 'employee' ? 'createOptionDocument' : 'createAdvisorDocument'}"</strong> and click Run.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Template ID Warning */}
                <div className="mb-6 p-3 bg-amber-50 border border-amber-200 rounded text-sm">
                  <strong className="text-amber-800">⚠️ Important:</strong>
                  <span className="text-amber-700"> Update the template ID in the script with your actual Google Doc template ID before running.</span>
                </div>

                {/* Script Preview */}
                <div>
                  <h4 className="font-semibold mb-2">📄 Script Preview:</h4>
                  <div className="bg-slate-900 text-green-400 p-4 rounded-lg font-mono text-xs overflow-auto max-h-48">
                    <pre>
                      {individualDocType === 'safe' && generateSingleSafeScript(selectedVenture, individualDocData, individualOverwrite)}
                      {individualDocType === 'employee' && generateSingleEmployeeScript(selectedVenture, individualDocData, individualOverwrite)}
                      {individualDocType === 'advisor' && generateSingleAdvisorScript(selectedVenture, individualDocData, individualOverwrite)}
                    </pre>
                  </div>
                </div>
              </div>
              <div className="p-5 border-t flex justify-end items-center flex-shrink-0 bg-slate-50">
                <button onClick={() => setShowIndividualGenerate(false)} className="px-4 py-2 hover:bg-slate-200 rounded">Close</button>
              </div>
            </div>
          </div>
        )}

        {/* Edit Modal */}
        {isEditing && editingVenture && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-3xl w-full flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
              <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
                <h2 className="text-lg font-semibold">Edit {editingVenture.legalName}</h2>
                <button onClick={() => setIsEditing(false)} className="p-2 hover:bg-slate-100 rounded"><X className="w-5 h-5" /></button>
              </div>
              <div className="flex-1 overflow-y-auto min-h-0 p-5">
                <div className="grid grid-cols-2 gap-4">
                  <SectionHeader color="blue">Company Identity</SectionHeader>
                  <Field label="Legal Name *" value={editingVenture.legalName} onChange={e => setEditingVenture({...editingVenture, legalName: e.target.value})} className="col-span-2" />
                  <Field label="Founded Date *" type="date" value={editingVenture.foundedDate} onChange={e => setEditingVenture({...editingVenture, foundedDate: e.target.value})} />
                  <SelectField label="State" value={editingVenture.state} onChange={e => setEditingVenture({...editingVenture, state: e.target.value})} options={['Delaware', 'California', 'New York', 'Texas', 'Nevada']} />
                  <div className="col-span-2">
                    <Field label="Google Drive Folder URL" value={editingVenture.driveFolderUrl || ''} onChange={e => setEditingVenture({...editingVenture, driveFolderUrl: e.target.value})} placeholder="Paste folder URL from script output" />
                    <p className="text-xs text-slate-500 mt-1">After running the document generation script, paste the folder URL from the execution log here.</p>
                  </div>
                  <SectionHeader color="slate">Registered Agent</SectionHeader>
                  <Field label="Agent Name" value={editingVenture.registeredAgent} onChange={e => setEditingVenture({...editingVenture, registeredAgent: e.target.value})} />
                  <Field label="Agent Address" value={editingVenture.registeredAgentAddress} onChange={e => setEditingVenture({...editingVenture, registeredAgentAddress: e.target.value})} />
                  <Field label="Principal Office" value={editingVenture.principalOfficeAddress} onChange={e => setEditingVenture({...editingVenture, principalOfficeAddress: e.target.value})} className="col-span-2" />
                  <SectionHeader color="green">Share Structure</SectionHeader>
                  <NumberField label="Total Authorized" value={editingVenture.totalSharesAuthorized} onChange={e => setEditingVenture({...editingVenture, totalSharesAuthorized: e.target.value})} />
                  <NumberField label="Par Value (per share)" decimals={5} prefix="$" value={editingVenture.parValue} onChange={e => setEditingVenture({...editingVenture, parValue: e.target.value})} />
                  <NumberField label="Common Authorized" value={editingVenture.commonSharesAuthorized} onChange={e => setEditingVenture({...editingVenture, commonSharesAuthorized: e.target.value})} />
                  <NumberField label="FF Preferred Authorized" value={editingVenture.ffPreferredSharesAuthorized} onChange={e => setEditingVenture({...editingVenture, ffPreferredSharesAuthorized: e.target.value})} />
                  <NumberField label="FF Preferred Price (per share)" decimals={5} prefix="$" value={editingVenture.ffPreferredParValue} onChange={e => setEditingVenture({...editingVenture, ffPreferredParValue: e.target.value})} />
                  <SectionHeader color="purple">Officers</SectionHeader>
                  <Field label="Incorporator Name" value={editingVenture.incorporatorName} onChange={e => setEditingVenture({...editingVenture, incorporatorName: e.target.value})} />
                  <Field label="Initial Director" value={editingVenture.initialDirectorName} onChange={e => setEditingVenture({...editingVenture, initialDirectorName: e.target.value})} />
                  <SectionHeader color="orange">Founder Stock Purchase</SectionHeader>
                  <Field label="Founder Entity" value={editingVenture.founderEntityName} onChange={e => setEditingVenture({...editingVenture, founderEntityName: e.target.value})} className="col-span-2" />
                  <NumberField label="Common Shares" value={editingVenture.founderCommonShares} onChange={e => setEditingVenture({...editingVenture, founderCommonShares: e.target.value})} />
                  <NumberField label="Common Price ($)" decimals={2} prefix="$" value={editingVenture.founderCommonPurchasePrice} onChange={e => setEditingVenture({...editingVenture, founderCommonPurchasePrice: e.target.value})} />
                  <NumberField label="FF Preferred Shares" value={editingVenture.founderFFPreferredShares} onChange={e => setEditingVenture({...editingVenture, founderFFPreferredShares: e.target.value})} />
                  <NumberField label="FF Preferred Price ($)" decimals={2} prefix="$" value={editingVenture.founderFFPreferredPurchasePrice} onChange={e => setEditingVenture({...editingVenture, founderFFPreferredPurchasePrice: e.target.value})} />
                  <SectionHeader color="teal">Equity Plan</SectionHeader>
                  <Field label="Plan Year" value={editingVenture.equityPlanYear} onChange={e => setEditingVenture({...editingVenture, equityPlanYear: e.target.value})} />
                  <NumberField label="Option Pool (shares)" value={editingVenture.optionPoolShares} onChange={e => setEditingVenture({...editingVenture, optionPoolShares: e.target.value})} />
                  <SectionHeader color="purple">Fund Investment Tracking (TVPI)</SectionHeader>
                  <NumberField label="Our Paid-In Capital ($)" decimals={2} prefix="$" value={editingVenture.paidInCapital} onChange={e => setEditingVenture({...editingVenture, paidInCapital: e.target.value})} className="col-span-2" />
                  <div className="col-span-2 text-sm text-slate-500 bg-slate-50 p-3 rounded">
                    <span className="font-medium">Note:</span> Equity position is calculated from founder shares. Latest valuation is derived from the most recent priced funding round.
                  </div>
                </div>
              </div>
              <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0 bg-white">
                <button onClick={() => setIsEditing(false)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={saveEditing} className="px-4 py-2 bg-blue-600 text-white rounded">Save Changes</button>
              </div>
            </div>
          </div>
        )}

        {/* Delete Modal */}
        {showDeleteConfirm && ventureToDelete && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-xl max-w-md w-full p-6">
              <div className="flex items-center gap-2 text-red-600 mb-3">
                <AlertCircle className="w-5 h-5" />
                <h2 className="text-lg font-semibold">Delete Venture</h2>
              </div>
              <p className="text-slate-600 mb-4">Delete <strong>{ventureToDelete.legalName}</strong>? This cannot be undone.</p>
              <input type="text" value={deleteConfirmText} onChange={e => setDeleteConfirmText(e.target.value)} className="w-full border rounded px-3 py-2 mb-4" placeholder="Type DELETE to confirm" />
              <div className="flex justify-end gap-2">
                <button onClick={() => { setShowDeleteConfirm(false); setVentureToDelete(null); }} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
                <button onClick={executeDeleteVenture} disabled={deleteConfirmText !== 'DELETE'} className="px-4 py-2 bg-red-600 text-white rounded disabled:opacity-50">Delete</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // MAIN DASHBOARD
  // Filter and sort ventures
  const filteredVentures = ventures
    .filter(v => {
      if (!searchQuery) return true;
      const query = searchQuery.toLowerCase();
      return v.legalName?.toLowerCase().includes(query) || 
             v.state?.toLowerCase().includes(query) ||
             v.status?.toLowerCase().includes(query);
    })
    .sort((a, b) => {
      switch (sortBy) {
        case 'date':
          return (b.foundedDate || '').localeCompare(a.foundedDate || '');
        case 'raised':
          const raisedA = (a.fundingRounds || []).reduce((s, r) => s + (r.amount || 0), 0);
          const raisedB = (b.fundingRounds || []).reduce((s, r) => s + (r.amount || 0), 0);
          return raisedB - raisedA;
        case 'tvpi':
          const tvpiA = calculateVentureTVPI(a) || 0;
          const tvpiB = calculateVentureTVPI(b) || 0;
          return tvpiB - tvpiA;
        default:
          return (a.legalName || '').localeCompare(b.legalName || '');
      }
    });

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* Toast Notification */}
      {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
      
      {/* Header */}
      <div className="bg-white border-b shadow-sm sticky top-0 z-40">
        <div className="max-w-6xl mx-auto px-6 py-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-4">
              <div className="p-3 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl shadow-lg">
                <Rocket className="w-7 h-7 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-bold bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text text-transparent">Venture Studio</h1>
                <p className="text-slate-500 text-sm">Legal documents & portfolio management</p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              {/* Data Backup Button */}
              <button 
                onClick={() => {
                  setShowTeamSharing(true);
                  setBackupState(prev => ({ ...prev, showSyncReminder: false }));
                }}
                className={`px-4 py-2.5 rounded-xl transition-colors flex items-center gap-2 border relative ${
                  backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0
                    ? 'text-amber-600 border-amber-300 bg-amber-50 hover:bg-amber-100 animate-pulse'
                    : lastCloudSync
                      ? 'text-emerald-600 border-emerald-200 bg-emerald-50 hover:bg-emerald-100'
                      : 'text-slate-600 border-slate-200 hover:bg-slate-100'
                }`}
                title={
                  backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0 
                    ? `${backupState.unsyncedChangeCount} unsynced changes - click to backup` 
                    : lastCloudSync 
                      ? 'All changes backed up' 
                      : 'Click to backup your data'
                }
              >
                {backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0 ? (
                  <>
                    <AlertCircle className="w-5 h-5" />
                    <span className="hidden sm:inline">{backupState.unsyncedChangeCount} Unsynced</span>
                    <span className="sm:hidden">{backupState.unsyncedChangeCount}</span>
                  </>
                ) : lastCloudSync ? (
                  <>
                    <CheckCircle className="w-5 h-5" />
                    <span className="hidden sm:inline">Backed Up</span>
                  </>
                ) : (
                  <>
                    <Upload className="w-5 h-5" />
                    <span className="hidden sm:inline">Backup</span>
                  </>
                )}
              </button>
              
              <button 
                onClick={() => setShowNewVenture(true)} 
                className="px-4 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl flex items-center gap-2 hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg"
              >
                <Plus className="w-5 h-5" /> New Venture
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-6xl mx-auto p-6">
        {/* Hidden file input for import */}
        <input
          type="file"
          ref={fileInputRef}
          onChange={handleImport}
          accept=".json"
          className="hidden"
        />
        
        {/* Sync Reminder Banner */}
        {backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0 && (
          <div className="mb-4 bg-amber-50 border-2 border-amber-300 rounded-xl p-4 flex items-center justify-between animate-pulse">
            <div className="flex items-center gap-3">
              <AlertCircle className="w-6 h-6 text-amber-600" />
              <div>
                <div className="font-semibold text-amber-800">
                  {backupState.unsyncedChangeCount} Unsynced Change{backupState.unsyncedChangeCount !== 1 ? 's' : ''}
                </div>
                <p className="text-sm text-amber-700">
                  Your data exists only on this device. Click below to back it up.
                </p>
              </div>
            </div>
            <button
              onClick={() => {
                const exportPayload = {
                  exportDate: new Date().toISOString(),
                  ventures: ventures
                };
                navigator.clipboard.writeText(JSON.stringify(exportPayload));
                markAsSynced();
                showToast('Data copied! Open the Ventures Sheet and paste into cell B2', 'success');
              }}
              className="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium flex items-center gap-2"
            >
              <Copy className="w-4 h-4" />
              Copy & Backup Now
            </button>
          </div>
        )}
        
        {/* Import success/error notifications */}
        {importSuccess && (
          <div className="fixed top-4 right-4 bg-green-100 border border-green-300 text-green-800 px-4 py-3 rounded-lg flex items-center gap-2 z-50 shadow-lg">
            <CheckCircle className="w-5 h-5" />
            Data imported successfully!
          </div>
        )}
        {importError && (
          <div className="fixed top-4 right-4 bg-red-100 border border-red-300 text-red-800 px-4 py-3 rounded-lg flex items-center gap-2 z-50 shadow-lg">
            <AlertCircle className="w-5 h-5" />
            {importError}
          </div>
        )}

        {/* Stats Dashboard */}
        <div className="grid grid-cols-4 gap-4 mb-6">
          <StatCard 
            icon={Building2} 
            iconColor="blue" 
            value={ventures.length} 
            label="Ventures" 
            subtext={ventures.filter(v => v.status === 'Active').length + ' active'}
          />
          <StatCard 
            icon={DollarSign} 
            iconColor="green" 
            value={'$' + (totalInvested / 1000000).toFixed(1) + 'M'} 
            label="Total Raised" 
            subtext="across all ventures"
          />
          <StatCard 
            icon={TrendingUp} 
            iconColor={overallTVPI !== null && overallTVPI >= 1 ? 'emerald' : overallTVPI !== null ? 'red' : 'purple'} 
            value={overallTVPI !== null ? overallTVPI.toFixed(2) + 'x' : '—'} 
            label="Fund TVPI" 
            subtext={totalPaidInCapital > 0 ? `$${(totalCurrentValue / 1000000).toFixed(2)}M value` : 'Set paid-in capital'}
            highlight={overallTVPI !== null && overallTVPI >= 2}
          />
          <StatCard 
            icon={FileText} 
            iconColor="orange" 
            value={templateList.length} 
            label="Templates" 
            subtext="ready to generate"
            onClick={() => window.open(TEMPLATE_FOLDER_URL, '_blank')}
          />
        </div>

        {/* Search and Fund Costs Row */}
        <div className="grid grid-cols-3 gap-4 mb-6">
          {/* Search */}
          <div className="col-span-2 bg-white rounded-xl border p-4 shadow-sm">
            <div className="flex items-center gap-3">
              <div className="flex-1 relative">
                <Search className="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" />
                <input
                  type="text"
                  placeholder="Search ventures..."
                  value={searchQuery}
                  onChange={e => setSearchQuery(e.target.value)}
                  className="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
                />
                {searchQuery && (
                  <button 
                    onClick={() => setSearchQuery('')}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                  >
                    <X className="w-4 h-4" />
                  </button>
                )}
              </div>
              <div className="flex items-center gap-2 border-l pl-3">
                <span className="text-xs text-slate-500">Sort:</span>
                <select
                  value={sortBy}
                  onChange={e => setSortBy(e.target.value)}
                  className="text-sm border border-slate-200 rounded-lg px-2 py-1.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 bg-white"
                >
                  <option value="name">Name</option>
                  <option value="date">Founded Date</option>
                  <option value="raised">Amount Raised</option>
                  <option value="tvpi">TVPI</option>
                </select>
              </div>
            </div>
          </div>

          {/* Fund-Level Costs */}
          <div className="bg-white rounded-xl border p-4 shadow-sm">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="p-2 bg-slate-100 rounded-lg"><DollarSign className="w-4 h-4 text-slate-600" /></div>
                <span className="text-sm font-medium text-slate-700">Non-Venture Costs</span>
              </div>
              <div className="flex items-center gap-1">
                <span className="text-sm text-slate-400">$</span>
                <input
                  type="text"
                  value={nonVentureStudioCost ? nonVentureStudioCost.toLocaleString() : ''}
                  onChange={(e) => {
                    const cleaned = e.target.value.replace(/[^0-9.-]/g, '');
                    const parsed = parseFloat(cleaned);
                    saveNonVentureStudioCost(isNaN(parsed) ? 0 : parsed);
                  }}
                  className="w-28 border border-slate-200 rounded-lg px-2 py-1.5 text-right text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"
                  placeholder="0"
                />
              </div>
            </div>
            {nonVentureStudioCost > 0 && venturePaidInCapital > 0 && (
              <div className="mt-2 pt-2 border-t text-xs text-slate-500">
                Total: <span className="font-semibold text-slate-700">${totalPaidInCapital.toLocaleString()}</span>
              </div>
            )}
          </div>
        </div>

        {/* Ventures List */}
        <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
          <div className="p-5 border-b flex items-center justify-between bg-gradient-to-r from-slate-50 to-white">
            <div className="flex items-center gap-3">
              <h2 className="font-semibold text-slate-800">Portfolio Ventures</h2>
              {searchQuery && (
                <span className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">
                  {filteredVentures.length} of {ventures.length} shown
                </span>
              )}
            </div>
            {ventures.length > 0 && !searchQuery && (
              <span className="text-sm text-slate-500">{ventures.length} {ventures.length === 1 ? 'venture' : 'ventures'}</span>
            )}
          </div>
          {isLoadingVentures ? (
            <div className="p-12 text-center">
              <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-slate-500">Loading ventures...</p>
            </div>
          ) : ventures.length === 0 ? (
            <EmptyState
              icon={Rocket}
              iconColor="blue"
              title="Launch your first venture"
              description="Get started by adding your first venture. Track equity, generate legal documents, and manage your portfolio all in one place."
              action={() => setShowNewVenture(true)}
              actionLabel="Add Your First Venture"
            />
          ) : filteredVentures.length === 0 ? (
            <div className="p-12 text-center">
              <div className="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <Search className="w-8 h-8 text-slate-400" />
              </div>
              <h3 className="text-lg font-semibold text-slate-800 mb-2">No matches found</h3>
              <p className="text-slate-500 mb-4">No ventures match "{searchQuery}"</p>
              <button onClick={() => setSearchQuery('')} className="text-blue-600 hover:text-blue-700 font-medium">
                Clear search
              </button>
            </div>
          ) : (
            <div className="divide-y">
              {filteredVentures.map(v => {
                const ventureTVPI = calculateVentureTVPI(v);
                const ventureValue = calculateVentureCurrentValue(v);
                const currentPaidIn = inlinePaidIn[v.id] !== undefined ? inlinePaidIn[v.id] : (v.paidInCapital || 0);
                const hasChanged = inlinePaidIn[v.id] !== undefined && parseFloat(String(inlinePaidIn[v.id]).replace(/,/g, '')) !== (v.paidInCapital || 0);
                const isSaving = savingPaidIn[v.id];
                const equity = calculateEquity(v);
                
                // Format the last updated date
                const lastUpdated = v.paidInCapitalUpdatedAt 
                  ? new Date(v.paidInCapitalUpdatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                  : null;
                
                return (
                  <div 
                    key={v.id} 
                    className="p-4 hover:bg-gradient-to-r hover:from-blue-50/50 hover:to-transparent transition-all group"
                  >
                    <div className="flex items-center justify-between">
                      {/* Left side: Venture info (clickable) */}
                      <div 
                        className="flex items-center gap-4 cursor-pointer flex-1 min-w-0"
                        onClick={() => { setSelectedVenture(v) }}
                      >
                        <div className="p-2.5 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-xl group-hover:from-blue-200 group-hover:to-indigo-200 transition-colors flex-shrink-0 shadow-sm">
                          <Building2 className="w-5 h-5 text-blue-600" />
                        </div>
                        <div className="min-w-0">
                          <div className="flex items-center gap-2">
                            <h3 className="font-semibold text-slate-900 group-hover:text-blue-700 transition-colors truncate">{v.legalName}</h3>
                            <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                              v.status === 'Active' ? 'bg-emerald-100 text-emerald-700' :
                              v.status === 'Acquired' ? 'bg-blue-100 text-blue-700' :
                              v.status === 'Closed' ? 'bg-slate-100 text-slate-600' :
                              'bg-amber-100 text-amber-700'
                            }`}>{v.status || 'Active'}</span>
                          </div>
                          <div className="flex items-center gap-3 text-sm text-slate-500 mt-0.5">
                            <span>{v.state}</span>
                            <span>•</span>
                            <span>Founded {v.foundedDate}</span>
                            {equity.totalRaised > 0 && (
                              <>
                                <span>•</span>
                                <span className="text-green-600 font-medium">${(equity.totalRaised / 1000000).toFixed(2)}M raised</span>
                              </>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      {/* Middle: Paid-in capital editor (isolated) */}
                      <div 
                        className="flex items-center gap-3 px-4 border-l border-r mx-4"
                        onClick={e => e.stopPropagation()}
                      >
                        <div className="text-right">
                          <div className="text-xs text-slate-500 mb-0.5">Paid-in Capital</div>
                          <div className="flex items-center gap-1">
                            <span className="text-sm text-slate-400">$</span>
                            <input
                              type="text"
                              value={typeof currentPaidIn === 'number' ? currentPaidIn.toLocaleString() : currentPaidIn}
                              onChange={e => {
                                const raw = e.target.value.replace(/,/g, '');
                                setInlinePaidIn({ ...inlinePaidIn, [v.id]: raw });
                              }}
                              onBlur={() => {
                                const val = parseFloat(String(inlinePaidIn[v.id] || 0).replace(/,/g, ''));
                                if (!isNaN(val) && val !== (v.paidInCapital || 0)) {
                                  savePaidInCapital(v.id, val);
                                }
                              }}
                              onKeyDown={e => {
                                if (e.key === 'Enter') {
                                  const val = parseFloat(String(inlinePaidIn[v.id] || 0).replace(/,/g, ''));
                                  if (!isNaN(val) && val !== (v.paidInCapital || 0)) {
                                    savePaidInCapital(v.id, val);
                                  }
                                  e.target.blur();
                                }
                              }}
                              className={`w-28 border rounded-lg px-2 py-1 text-right text-sm transition-all ${
                                hasChanged ? 'border-blue-500 ring-2 ring-blue-500/20' : 'border-slate-200'
                              } ${isSaving ? 'bg-slate-100' : ''}`}
                              placeholder="0"
                              disabled={isSaving}
                            />
                            {isSaving && <span className="text-xs text-blue-600 ml-1">Saving...</span>}
                          </div>
                          {lastUpdated && (
                            <div className="text-xs text-slate-400 mt-0.5">Updated {lastUpdated}</div>
                          )}
                        </div>
                      </div>
                      
                      {/* Right side: TVPI and arrow (clickable) */}
                      <div 
                        className="flex items-center gap-4 cursor-pointer"
                        onClick={() => { setSelectedVenture(v) }}
                      >
                        <div className="text-right">
                          <div className="text-xs text-slate-500 mb-0.5">TVPI</div>
                          <div className={`text-lg font-bold ${
                            ventureTVPI !== null && ventureTVPI >= 1 ? 'text-emerald-600' : 
                            ventureTVPI !== null ? 'text-red-600' : 'text-slate-400'
                          }`}>
                            {ventureTVPI !== null ? ventureTVPI.toFixed(2) + 'x' : '—'}
                          </div>
                          {ventureTVPI !== null && ventureValue > 0 && (
                            <div className="text-xs text-slate-500">${(ventureValue / 1000000).toFixed(2)}M value</div>
                          )}
                        </div>
                        <ChevronRight className="w-5 h-5 text-slate-300 group-hover:text-blue-500 group-hover:translate-x-1 transition-all" />
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* New Venture Modal */}
      {showNewVenture && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl max-w-3xl w-full flex flex-col" style={{ maxHeight: 'calc(100vh - 2rem)' }}>
            <div className="p-5 border-b flex justify-between items-center flex-shrink-0">
              <h2 className="text-lg font-semibold">Add New Venture</h2>
              <button onClick={() => setShowNewVenture(false)} className="p-2 hover:bg-slate-100 rounded"><X className="w-5 h-5" /></button>
            </div>
            <div className="flex-1 overflow-y-auto min-h-0 p-5">
              <div className="grid grid-cols-2 gap-4">
                <SectionHeader color="blue">Company Identity</SectionHeader>
                <Field label="Legal Name *" value={newVenture.legalName} onChange={e => setNewVenture({...newVenture, legalName: e.target.value})} className="col-span-2" />
                <Field label="Founded Date *" type="date" value={newVenture.foundedDate} onChange={e => setNewVenture({...newVenture, foundedDate: e.target.value})} />
                <SelectField label="State" value={newVenture.state} onChange={e => setNewVenture({...newVenture, state: e.target.value})} options={['Delaware', 'California', 'New York', 'Texas', 'Nevada']} />
                <SectionHeader color="slate">Registered Agent</SectionHeader>
                <Field label="Agent Name" value={newVenture.registeredAgent} onChange={e => setNewVenture({...newVenture, registeredAgent: e.target.value})} />
                <Field label="Agent Address" value={newVenture.registeredAgentAddress} onChange={e => setNewVenture({...newVenture, registeredAgentAddress: e.target.value})} />
                <Field label="Principal Office" value={newVenture.principalOfficeAddress} onChange={e => setNewVenture({...newVenture, principalOfficeAddress: e.target.value})} className="col-span-2" />
                <SectionHeader color="green">Share Structure</SectionHeader>
                <NumberField label="Total Authorized" value={newVenture.totalSharesAuthorized} onChange={e => setNewVenture({...newVenture, totalSharesAuthorized: e.target.value})} />
                <NumberField label="Par Value (per share)" decimals={5} prefix="$" value={newVenture.parValue} onChange={e => setNewVenture({...newVenture, parValue: e.target.value})} />
                <NumberField label="Common Authorized" value={newVenture.commonSharesAuthorized} onChange={e => setNewVenture({...newVenture, commonSharesAuthorized: e.target.value})} />
                <NumberField label="FF Preferred Authorized" value={newVenture.ffPreferredSharesAuthorized} onChange={e => setNewVenture({...newVenture, ffPreferredSharesAuthorized: e.target.value})} />
                <NumberField label="FF Preferred Price (per share)" decimals={5} prefix="$" value={newVenture.ffPreferredParValue} onChange={e => setNewVenture({...newVenture, ffPreferredParValue: e.target.value})} />
                <SectionHeader color="purple">Officers</SectionHeader>
                <Field label="Incorporator Name" value={newVenture.incorporatorName} onChange={e => setNewVenture({...newVenture, incorporatorName: e.target.value})} />
                <Field label="Initial Director" value={newVenture.initialDirectorName} onChange={e => setNewVenture({...newVenture, initialDirectorName: e.target.value})} />
                <SectionHeader color="orange">Founder Stock Purchase</SectionHeader>
                <Field label="Founder Entity" value={newVenture.founderEntityName} onChange={e => setNewVenture({...newVenture, founderEntityName: e.target.value})} className="col-span-2" />
                <NumberField label="Common Shares" value={newVenture.founderCommonShares} onChange={e => setNewVenture({...newVenture, founderCommonShares: e.target.value})} />
                <NumberField label="Common Price ($)" decimals={2} prefix="$" value={newVenture.founderCommonPurchasePrice} onChange={e => setNewVenture({...newVenture, founderCommonPurchasePrice: e.target.value})} />
                <NumberField label="FF Preferred Shares" value={newVenture.founderFFPreferredShares} onChange={e => setNewVenture({...newVenture, founderFFPreferredShares: e.target.value})} />
                <NumberField label="FF Preferred Price ($)" decimals={2} prefix="$" value={newVenture.founderFFPreferredPurchasePrice} onChange={e => setNewVenture({...newVenture, founderFFPreferredPurchasePrice: e.target.value})} />
                <SectionHeader color="teal">Equity Plan</SectionHeader>
                <Field label="Plan Year" value={newVenture.equityPlanYear} onChange={e => setNewVenture({...newVenture, equityPlanYear: e.target.value})} />
                <NumberField label="Option Pool (shares)" value={newVenture.optionPoolShares} onChange={e => setNewVenture({...newVenture, optionPoolShares: e.target.value})} />
                <SectionHeader color="purple">Fund Investment Tracking (TVPI)</SectionHeader>
                <NumberField label="Our Paid-In Capital ($)" decimals={2} prefix="$" value={newVenture.paidInCapital} onChange={e => setNewVenture({...newVenture, paidInCapital: e.target.value})} className="col-span-2" />
                <div className="col-span-2 text-sm text-slate-500 bg-slate-50 p-3 rounded">
                  <span className="font-medium">Note:</span> Equity position and valuation will be calculated automatically from founder shares and funding rounds.
                </div>
              </div>
            </div>
            <div className="p-5 border-t flex justify-end gap-2 flex-shrink-0 bg-white">
              <button onClick={() => setShowNewVenture(false)} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
              <button onClick={addVenture} disabled={!newVenture.legalName || !newVenture.foundedDate} className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50">Add Venture</button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Modal (main dashboard) */}
      {showDeleteConfirm && ventureToDelete && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl max-w-md w-full p-6">
            <div className="flex items-center gap-2 text-red-600 mb-3">
              <AlertCircle className="w-5 h-5" />
              <h2 className="text-lg font-semibold">Delete Venture</h2>
            </div>
            <p className="text-slate-600 mb-4">Delete <strong>{ventureToDelete.legalName}</strong>?</p>
            <input type="text" value={deleteConfirmText} onChange={e => setDeleteConfirmText(e.target.value)} className="w-full border rounded px-3 py-2 mb-4" placeholder="Type DELETE to confirm" />
            <div className="flex justify-end gap-2">
              <button onClick={() => { setShowDeleteConfirm(false); setVentureToDelete(null); }} className="px-4 py-2 hover:bg-slate-100 rounded">Cancel</button>
              <button onClick={executeDeleteVenture} disabled={deleteConfirmText !== 'DELETE'} className="px-4 py-2 bg-red-600 text-white rounded disabled:opacity-50">Delete</button>
            </div>
          </div>
        </div>
      )}

      {/* Data Backup Modal */}
      {showTeamSharing && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowTeamSharing(false)}>
          <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div className="p-5 border-b flex justify-between items-center bg-white">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-emerald-100 rounded-lg">
                  <FileText className="w-5 h-5 text-emerald-600" />
                </div>
                <div>
                  <h2 className="text-lg font-semibold">Data Backup</h2>
                  <p className="text-sm text-slate-500">Save your venture data to Google Sheets</p>
                </div>
              </div>
              <button onClick={() => setShowTeamSharing(false)} className="p-2 hover:bg-slate-100 rounded">
                <X className="w-5 h-5" />
              </button>
            </div>
            
            {/* Content */}
            <div style={{ maxHeight: 'calc(90vh - 140px)', overflowY: 'auto' }} className="p-5 space-y-6">
              
              {/* Status Banner */}
              {backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0 ? (
                <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
                  <div className="flex items-center gap-3">
                    <AlertCircle className="w-6 h-6 text-amber-600" />
                    <div>
                      <div className="font-semibold text-amber-800">
                        {backupState.unsyncedChangeCount} Unsynced Change{backupState.unsyncedChangeCount !== 1 ? 's' : ''}
                      </div>
                      <p className="text-sm text-amber-700">
                        Back up your data now to avoid losing your work.
                      </p>
                    </div>
                  </div>
                </div>
              ) : lastCloudSync ? (
                <div className="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                  <div className="flex items-center gap-3">
                    <CheckCircle className="w-6 h-6 text-emerald-600" />
                    <div>
                      <div className="font-semibold text-emerald-800">All Changes Backed Up</div>
                      <p className="text-sm text-emerald-700">
                        Last backup: {new Date(lastCloudSync).toLocaleString()}
                      </p>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="bg-slate-50 border border-slate-200 rounded-xl p-4">
                  <div className="flex items-center gap-3">
                    <AlertCircle className="w-6 h-6 text-slate-500" />
                    <div>
                      <div className="font-semibold text-slate-700">No Backup Yet</div>
                      <p className="text-sm text-slate-600">
                        {ventures.length > 0 ? 'Back up your data to avoid losing it.' : 'Add ventures and back them up to share with your team.'}
                      </p>
                    </div>
                  </div>
                </div>
              )}

              {/* Main Backup Section */}
              <div className="border-2 border-emerald-200 rounded-xl overflow-hidden">
                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 p-4">
                  <div className="font-semibold text-white flex items-center gap-2">
                    <Upload className="w-5 h-5" />
                    Backup to Google Sheets
                  </div>
                  <p className="text-sm text-emerald-100 mt-1">
                    Copy your data and paste it into the shared spreadsheet
                  </p>
                </div>
                <div className="p-4 space-y-4">
                  {/* Step 1: Copy Data */}
                  <div className="flex items-start gap-3">
                    <div className="w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold text-sm flex-shrink-0">1</div>
                    <div className="flex-1">
                      <div className="font-medium text-slate-700 mb-2">Copy your data</div>
                      <button
                        onClick={() => {
                          const exportPayload = {
                            exportDate: new Date().toISOString(),
                            ventures: ventures
                          };
                          navigator.clipboard.writeText(JSON.stringify(exportPayload));
                          markAsSynced();
                          showToast('Data copied! Now paste it into the Google Sheet', 'success');
                        }}
                        className={`w-full px-4 py-3 rounded-lg flex items-center justify-center gap-2 font-medium ${
                          backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0
                            ? 'bg-amber-500 text-white hover:bg-amber-600'
                            : 'bg-emerald-600 text-white hover:bg-emerald-700'
                        }`}
                      >
                        <Copy className="w-5 h-5" />
                        {backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0 
                          ? `Copy ${backupState.unsyncedChangeCount} Unsynced Changes`
                          : `Copy All Data (${ventures.length} ventures)`
                        }
                      </button>
                    </div>
                  </div>
                  
                  {/* Step 2: Open Sheet */}
                  <div className="flex items-start gap-3">
                    <div className="w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold text-sm flex-shrink-0">2</div>
                    <div className="flex-1">
                      <div className="font-medium text-slate-700 mb-2">Open the backup spreadsheet</div>
                      <a
                        href="https://docs.google.com/spreadsheets/d/1hKO7u0xZTnniN-uzHPqfATqAT5J7IwmhmFRr2AEbxmM/edit"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center justify-center gap-2 w-full px-4 py-3 bg-white border-2 border-emerald-300 text-emerald-700 rounded-lg hover:bg-emerald-50 font-medium"
                      >
                        <ExternalLink className="w-5 h-5" />
                        Open Venture Legal Data Sheet
                      </a>
                    </div>
                  </div>
                  
                  {/* Step 3: Paste */}
                  <div className="flex items-start gap-3">
                    <div className="w-7 h-7 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold text-sm flex-shrink-0">3</div>
                    <div className="flex-1">
                      <div className="font-medium text-slate-700 mb-1">Paste into cell B2</div>
                      <p className="text-sm text-slate-500">
                        In the "Ventures" sheet, click cell B2 and paste (Ctrl+V / Cmd+V)
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Restore Section */}
              <details className="border rounded-xl overflow-hidden">
                <summary className="bg-slate-50 p-4 cursor-pointer hover:bg-slate-100">
                  <span className="font-medium text-slate-700">📥 Restore from Backup</span>
                  <span className="text-sm text-slate-500 ml-2">(load data from sheet)</span>
                </summary>
                <div className="p-4 space-y-3 border-t">
                  <p className="text-sm text-slate-600">
                    To restore your data from the Google Sheet:
                  </p>
                  <ol className="text-sm text-slate-600 space-y-1 list-decimal list-inside">
                    <li>Open the <a href="https://docs.google.com/spreadsheets/d/1hKO7u0xZTnniN-uzHPqfATqAT5J7IwmhmFRr2AEbxmM/edit" target="_blank" rel="noopener noreferrer" className="text-blue-600 underline">Venture Legal Data Sheet</a></li>
                    <li>Copy the contents of cell B2 in the "Ventures" sheet</li>
                    <li>Paste it below and click Import</li>
                  </ol>
                  <textarea
                    value={importJsonText}
                    onChange={(e) => setImportJsonText(e.target.value)}
                    placeholder='Paste data from the Google Sheet here...'
                    className="w-full h-24 border rounded-lg p-3 text-sm font-mono resize-none"
                  />
                  <button
                    onClick={() => {
                      try {
                        const data = JSON.parse(importJsonText);
                        if (data.ventures && Array.isArray(data.ventures)) {
                          importTeamData(JSON.stringify({ ventures: data.ventures }));
                          setImportJsonText('');
                        } else if (data.exportDate && data.ventures) {
                          importTeamData(importJsonText);
                          setImportJsonText('');
                        } else {
                          showToast('Invalid data format', 'error');
                        }
                      } catch (e) {
                        showToast('Invalid JSON: ' + e.message, 'error');
                      }
                    }}
                    disabled={!importJsonText.trim()}
                    className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium"
                  >
                    Import Data
                  </button>
                </div>
              </details>

              {/* File Backup (collapsed) */}
              <details className="border rounded-xl overflow-hidden">
                <summary className="bg-slate-50 p-4 cursor-pointer hover:bg-slate-100">
                  <span className="font-medium text-slate-700">💾 Download as File</span>
                  <span className="text-sm text-slate-500 ml-2">(local backup)</span>
                </summary>
                <div className="p-4 space-y-3 border-t">
                  <p className="text-sm text-slate-600">
                    Download a backup file to your computer.
                  </p>
                  <div className="flex gap-2">
                    <button
                      onClick={exportData}
                      className="flex-1 px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 flex items-center justify-center gap-2"
                    >
                      <Download className="w-4 h-4" />
                      Download JSON
                    </button>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      className="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 flex items-center justify-center gap-2"
                    >
                      <Upload className="w-4 h-4" />
                      Upload JSON
                    </button>
                  </div>
                </div>
              </details>
            </div>
            
            {/* Footer */}
            <div className="p-4 border-t flex justify-between items-center bg-white">
              <div className="text-sm text-slate-500">
                {ventures.length} venture{ventures.length !== 1 ? 's' : ''} • {
                  backupState.hasUnsyncedChanges && backupState.unsyncedChangeCount > 0 
                    ? `${backupState.unsyncedChangeCount} unsynced` 
                    : lastCloudSync 
                      ? 'all backed up' 
                      : 'not backed up yet'
                }
              </div>
              <button 
                onClick={() => setShowTeamSharing(false)} 
                className="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
